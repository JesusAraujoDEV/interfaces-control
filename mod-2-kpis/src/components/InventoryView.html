<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfico de Pareto y Alertas - Cafetería</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-center">Gráfico de Pareto y Alertas - Inventario de Cafetería</h1>
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Gráfico de Pareto -->
            <div class="flex-1">
                <h2 class="text-lg font-semibold mb-2">Gráfico de Pareto</h2>
                <div id="pareto-chart" class="w-full h-96 bg-gray-50 rounded-lg flex items-end justify-center relative">
                    <!-- Aquí se renderizará el gráfico SVG -->
                </div>
                <p class="text-sm text-gray-600 mt-2">Datos obtenidos de la API. El producto campeón está resaltado en rojo.</p>
            </div>
            <!-- Panel de Alertas -->
            <div class="w-full md:w-1/3">
                <h2 class="text-lg font-semibold mb-2">Alertas de Inventario</h2>
                <div id="alerts-panel" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                    <!-- Aquí se renderizarán las alertas -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para obtener datos del gráfico de Pareto
        async function fetchParetoData() {
            try {
                const response = await fetch('http://localhost:3000/api/v1/kpi/inventory/pareto');
                if (!response.ok) throw new Error('Error en la API');
                const data = await response.json();
                if (data.success) {
                    renderParetoChart(data.data.data);
                } else {
                    console.error('Respuesta no exitosa de la API');
                }
            } catch (error) {
                console.error('Error al obtener datos del Pareto:', error);
                document.getElementById('pareto-chart').innerHTML = '<p class="text-red-500">Error al cargar datos del gráfico.</p>';
            }
        }

        // Función para obtener datos de alertas
        async function fetchAlertsData() {
            try {
                const response = await fetch('http://localhost:3000/api/v1/kpi/inventory/alerts');
                if (!response.ok) throw new Error('Error en la API');
                const data = await response.json();
                renderAlertsPanel(data);
            } catch (error) {
                console.error('Error al obtener datos de alertas:', error);
                document.getElementById('alerts-panel').innerHTML = '<p class="text-red-500">Error al cargar alertas.</p>';
            }
        }

        // Función para renderizar el gráfico de Pareto (sin cambios)
        function renderParetoChart(products) {
            const chartContainer = document.getElementById('pareto-chart');
            chartContainer.innerHTML = ''; // Limpiar contenido anterior

            // Ordenar productos por revenue_generated descendente
            products.sort((a, b) => b.revenue_generated - a.revenue_generated);

            // Calcular total de ingresos para porcentajes
            const totalRevenue = products.reduce((sum, p) => sum + p.revenue_generated, 0);

            // Dimensiones del gráfico
            const width = chartContainer.clientWidth;
            const height = chartContainer.clientHeight;
            const margin = { top: 20, right: 60, bottom: 60, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            // Crear SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('class', 'w-full h-full');
            chartContainer.appendChild(svg);

            // Grupo para el gráfico
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
            svg.appendChild(g);

            // Escalas
            const maxRevenue = Math.max(...products.map(p => p.revenue_generated));
            const barWidth = innerWidth / products.length * 0.8; // Ancho de barras
            const barSpacing = innerWidth / products.length * 0.2; // Espacio entre barras

            // Dibujar barras
            let cumulativePercent = 0;
            const points = []; // Para la línea acumulativa
            products.forEach((product, index) => {
                const barHeight = (product.revenue_generated / maxRevenue) * innerHeight;
                const x = index * (barWidth + barSpacing);
                const y = innerHeight - barHeight;

                // Barra
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', product.is_champion ? '#ef4444' : '#3b82f6'); // Rojo para campeón, azul para otros
                rect.setAttribute('class', 'cursor-pointer');
                rect.setAttribute('title', `${product.name}: $${product.revenue_generated} (Cant: ${product.quantity_sold})`);
                g.appendChild(rect);

                // Etiqueta del nombre (abajo)
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + barWidth / 2);
                text.setAttribute('y', innerHeight + 20);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('class', 'text-xs fill-gray-700');
                text.textContent = product.name;
                g.appendChild(text);

                // Calcular porcentaje acumulado para la línea
                cumulativePercent += (product.revenue_generated / totalRevenue) * 100;
                points.push({ x: x + barWidth / 2, y: innerHeight - (cumulativePercent / 100) * innerHeight });
            });

            // Dibujar línea acumulativa
            if (points.length > 1) {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let d = `M ${points[0].x} ${points[0].y}`;
                points.forEach(point => {
                    d += ` L ${point.x} ${point.y}`;
                });
                path.setAttribute('d', d);
                path.setAttribute('stroke', '#10b981'); // Verde para la línea
                path.setAttribute('stroke-width', 2);
                path.setAttribute('fill', 'none');
                g.appendChild(path);
            }

            // Ejes Y (izquierdo: ingresos, derecho: porcentaje)
            // Eje Y izquierdo (ingresos)
            const yAxisLeft = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            for (let i = 0; i <= 5; i++) {
                const y = innerHeight - (i / 5) * innerHeight;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', -5);
                line.setAttribute('y1', y);
                line.setAttribute('x2', 0);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#ccc');
                yAxisLeft.appendChild(line);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', -10);
                label.setAttribute('y', y + 5);
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('class', 'text-xs fill-gray-700');
                label.textContent = `$${(maxRevenue * i / 5).toFixed(0)}`;
                yAxisLeft.appendChild(label);
            }
            g.appendChild(yAxisLeft);

            // Eje Y derecho (porcentaje)
            const yAxisRight = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            for (let i = 0; i <= 5; i++) {
                const y = innerHeight - (i / 5) * innerHeight;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', innerWidth);
                line.setAttribute('y1', y);
                line.setAttribute('x2', innerWidth + 5);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#ccc');
                yAxisRight.appendChild(line);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', innerWidth + 15);
                label.setAttribute('y', y + 5);
                label.setAttribute('text-anchor', 'start');
                label.setAttribute('class', 'text-xs fill-gray-700');
                label.textContent = `${i * 20}%`;
                yAxisRight.appendChild(label);
            }
            g.appendChild(yAxisRight);
        }

        // Función para renderizar el panel de alertas
        function renderAlertsPanel(data) {
            const panel = document.getElementById('alerts-panel');
            panel.innerHTML = ''; // Limpiar contenido anterior

            // Mostrar critical_count
            const criticalHeader = document.createElement('div');
            criticalHeader.className = 'mb-4 p-2 bg-red-100 border border-red-300 rounded';
            criticalHeader.innerHTML = `<strong>Alertas Críticas:</strong> ${data.critical_count}`;
            panel.appendChild(criticalHeader);

            // Lista de alertas
            if (data.alerts && data.alerts.length > 0) {
                const list = document.createElement('ul');
                list.className = 'space-y-2';
                data.alerts.forEach(alert => {
                    const item = document.createElement('li');
                    item.className = `p-3 border rounded ${
                        alert.severity === 'CRITICAL' ? 'bg-red-50 border-red-300' :
                        alert.severity === 'WARNING' ? 'bg-yellow-50 border-yellow-300' :
                        'bg-green-50 border-green-300'
                    }`;
                    item.innerHTML = `
                        <div class="font-semibold">${alert.item_name}</div>
                        <div class="text-sm">Nivel actual: ${alert.current_level_pct}%</div>
                        <div class="text-sm">Severidad: <span class="font-medium">${alert.severity}</span></div>
                        <div class="text-sm">Acción requerida: ${alert.action_required}</div>
                    `;
                    list.appendChild(item);
                });
                panel.appendChild(list);
            } else {
                panel.innerHTML += '<p class="text-gray-500">No hay alertas disponibles.</p>';
            }
        }

        // Llamar a las funciones al cargar la página
        window.onload = () => {
            fetchParetoData();
            fetchAlertsData();
        };
    </script>
</body>
</html>