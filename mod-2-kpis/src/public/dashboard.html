<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - Charlotte</title>
    <link rel="stylesheet" href="/mod-2-kpis/src/public/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <div class="main-layout">
      <aside class="sidebar">
        <div class="sidebar__logo"><span class="icon">‚òï</span> CHARLOTTE</div>

        <nav class="sidebar__nav">
          <a
            href="/mod-2-kpis/src/public/dashboard.html"
            class="sidebar__menu-item sidebar__menu-item--active"
          >
            <i>üè†</i> Dashboard
          </a>
          <a href="/mod-2-kpis/src/public/bussines-intelligence.html" class="sidebar__menu-item">
            <i>üìä</i> Reportes
          </a>
          <a href="/mod-2-kpis/src/public/inventario.html" class="sidebar__menu-item">
            <i>üì¶</i> Inventario
          </a>
          <a href="/mod-2-kpis/src/public/eficiencia-operacional.html" class="sidebar__menu-item">
            <i>‚è±Ô∏è</i> Eficiencia
          </a>
          <a href="#" class="sidebar__menu-item" onclick="showAlertsHistory()">
            <i>üîî</i> Alertas
          </a>
          <a href="#" class="sidebar__menu-item"> <i>‚öôÔ∏è</i> Configuraci√≥n </a>
        </nav>

        <div class="sidebar__profile-footer">
          <div
            class="sidebar__avatar"
            style="
              background-image: url(&quot;user.jpg&quot;);
              background-size: cover;
            "
          ></div>
          <div>
            <p class="sidebar__user-name">Juan P√©rez</p>
            <p class="sidebar__user-role">Gerente</p>
          </div>
        </div>
      </aside>

      <main class="content">
        <header class="header-top">
          <div>
            <h1 class="header-top__title">HOLA, GERENTE</h1>
            <p class="header-top__subtitle">
              Este es el resumen de tu negocio.
            </p>
          </div>
          <div
            class="date-badge"
            id="current-date-badge"
            style="
              background: var(--white);
              padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 3.75); /* 8px 15px */
              border-radius: var(--border-radius);
              border: 1px solid var(--border-color);
              font-size: 0.875rem; /* 14px */
              box-shadow: var(--shadow-light);
            "
          >
            üìÖ Cargando fecha...
          </div>
        </header>

        <section class="stats-grid">
          <div class="kpi-card">
            <p class="kpi-card__label">Ingresos</p>
            <p class="kpi-card__value" id="kpi-revenue">Loading...</p>
            <span class="kpi-card__trend" id="kpi-revenue-trend">--</span>
          </div>
          <div class="kpi-card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <p class="kpi-card__label">Meta Trimestral</p>
              <button id="edit-goal-btn" class="icon-btn" title="Editar Meta">
                ‚úèÔ∏è
              </button>
            </div>
            <p class="kpi-card__value" id="kpi-goal">Loading...</p>
            <p style="font-size: 0.875rem; color: var(--text-muted)" id="kpi-goal-absolute">$0k</p>
          </div>

          <div class="kpi-card">
            <p class="kpi-card__label">Tiempo Atenci√≥n</p>
            <p class="kpi-card__value" id="kpi-avg-time">Loading...</p>
            <span style="font-size: 0.875rem; color: var(--text-muted)"
              >√ìptimo ‚è±Ô∏è</span
            >
          </div>
          <div class="kpi-card">
            <p class="kpi-card__label">Rotaci√≥n</p>
            <p class="kpi-card__value" id="kpi-rotation">0.0 /hr</p>
            <span class="kpi-card__trend" id="kpi-rotation-target">Meta --</span>
          </div>
        </section>

        <div class="dashboard-main-grid">
          <div class="chart-container">
            <h2 class="card__title">Ventas por Hora</h2>
            <p class="kpi-card__value" style="font-size: 1.125rem">
              <span id="chart-revenue-today">$0</span>
              <span style="font-size: 0.875rem; color: #28a745" id="chart-revenue-trend">Hoy +0%</span>
            </p>
            <div style="width: 100%; height: 250px; margin-top: calc(var(--spacing-unit) * 5); /* 20px */">
              <canvas id="demand-chart"></canvas>
            </div>
            <div
              id="salesLabels"
              style="
                display: flex;
                justify-content: space-between;
                margin-top: calc(var(--spacing-unit) * 2.5); /* 10px */
                color: var(--text-muted);
                font-size: 0.875rem; /* 14px */
              "
            >
              <span>8 AM</span><span>12 PM</span><span>4 PM</span
              ><span>8 PM</span>
            </div>
          </div>

          <div class="stock-alerts">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: calc(var(--spacing-unit) * 3.75); /* 15px */
              "
            >
              <h2 class="card__title" style="margin-bottom: 0">
                Alertas de Stock
              </h2>
              <button
                id="stock-settings-btn"
                class="icon-btn"
                title="Configurar L√≠mites"
              >
                ‚öôÔ∏è
              </button>
            </div>

            <div id="alertsList">
              <!-- alertas ser√°n renderizadas aqu√≠ -->
              <p class="text-muted" style="font-size: 0.875rem">Cargando alertas...</p>
            </div>

            <div id="stockLimits" style="margin-top: calc(var(--spacing-unit) * 3); /* 12px */ font-size: 0.875rem; color:var(--text-muted);"></div>
            </div>
          </div>
          </main>
    </div>
    <script>
    // Carga datos desde la API y actualiza la interfaz
    async function loadDashboard() {
      // Mostrar fecha actual
      const now = new Date();
      const dateStr = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const dateBadge = document.getElementById('current-date-badge');
      if (dateBadge) dateBadge.textContent = 'üìÖ ' + dateStr;

      try {
        // Use allSettled so that a failing fetch (e.g., backend not running) doesn't abort UI wiring
        const [sRes, aRes] = await Promise.allSettled([
          fetch('http://localhost:3000/api/v1/kpi/dashboard/summary'),
          fetch('http://localhost:3000/api/v1/kpi/inventory/alerts')
        ]);

        let summaryJson = {};
        let alertsJson = {};

        if (sRes.status === 'fulfilled' && sRes.value && sRes.value.ok) {
          try { summaryJson = await sRes.value.json(); } catch(_) { summaryJson = {}; }
        }
        if (aRes.status === 'fulfilled' && aRes.value && aRes.value.ok) {
          try { alertsJson = await aRes.value.json(); } catch(_) { alertsJson = {}; }
        }
        console.log('Fetched summary:', summaryJson);
        console.log('Fetched alerts:', alertsJson);
        const summary = summaryJson.data || summaryJson || {};
        const alerts = alertsJson.alerts || alertsJson || [];
        console.log('Dashboard summary:', summary);
        // Ingresos (mapear a ambos conjuntos de IDs para evitar duplicados)
        const revenue = summary.revenue || {};
        const incomeEls = [document.getElementById('incomeValue'), document.getElementById('kpi-revenue')];
        const incomeTrendEls = [document.getElementById('incomeTrend'), document.getElementById('kpi-revenue-trend')];
        if (revenue.total != null) {
          const txt = formatCurrency(revenue.total, revenue.currency);
          incomeEls.forEach(e => { if (e) e.textContent = txt; });
        }
        if (revenue.trend_percentage != null) {
          const t = (revenue.trend_direction === 'down' ? '-' : (revenue.trend_direction === 'up' ? '+' : '')) + revenue.trend_percentage + '%';
          incomeTrendEls.forEach(e => { if (e) e.textContent = t; });
        }

        // Meta trimestral (mapear a ambos bloques)
        const quarterly = summary.quarterly_goal || {};
        const quarterlyProgressEls = [document.getElementById('quarterlyProgress'), document.getElementById('kpi-goal')];
        const quarterlyTargetEls = [document.getElementById('quarterlyTarget'), document.getElementById('kpi-goal-absolute')];
        if (quarterly.progress_percentage != null) {
          const txt = (quarterly.progress_percentage) + '%';
          quarterlyProgressEls.forEach(e => { if (e) e.textContent = txt; });
        }
        if (quarterly.target != null) {
          const txt = formatCurrency(quarterly.target, revenue.currency);
          quarterlyTargetEls.forEach(e => { if (e) e.textContent = txt; });
        }

        // Rotaci√≥n / Tiempo atenci√≥n (mapear a ambos bloques)
        const ops = summary.operations || {};
        const avgTimeEls = [document.getElementById('rotationValue'), document.getElementById('kpi-avg-time')];
        const avgStatusEls = [document.getElementById('timeStatus')];
        const rotationRateEls = [document.getElementById('rotationRate'), document.getElementById('kpi-rotation')];
        const rotationStatusEls = [document.getElementById('rotationStatus'), document.getElementById('kpi-rotation-target')];
        if (ops.avg_service_time) avgTimeEls.forEach(e => { if (e) e.textContent = ops.avg_service_time; });
        if (ops.time_status) avgStatusEls.forEach(e => { if (e) e.textContent = ops.time_status; });
        if (ops.table_rotation != null) rotationRateEls.forEach(e => { if (e) e.textContent = ops.table_rotation + ' /hr'; });
        if (ops.rotation_status) rotationStatusEls.forEach(e => { if (e) e.textContent = ops.rotation_status; });

        // Ventas por hora y valor total hoy (no vienen en la respuesta de ejemplo; manejar vac√≠o)
        const salesData = summary.sales_by_hour || summary.sales_hours || [];
        const totalToday = summary.sales_total_today ?? (Array.isArray(salesData) ? salesData.reduce((s,i)=>s + (typeof i === 'number' ? i : (i.value||0)),0) : 0);
        const salesValueEl = document.getElementById('chart-revenue-today');
        const salesChangeEl = document.getElementById('chart-revenue-trend');
        console.log(salesValueEl, salesChangeEl);
        if (salesValueEl) salesValueEl.textContent = formatCurrency(totalToday, revenue.currency);
        if (salesChangeEl && summary.sales_change) salesChangeEl.textContent = 'Hoy ' + summary.sales_change;

        // Etiquetas debajo de la gr√°fica
        const labelsEl = document.getElementById('salesLabels');
        if (salesData.length) {
          const labels = salesData.map(d => (d.hour || d.label || ''));
          labelsEl.innerHTML = labels.map(l => '<span>' + escapeHtml(l || '') + '</span>').join('');
        } else {
          labelsEl.innerHTML = '<span>--</span><span>--</span><span>--</span><span>--</span>';
        }

        // Dibujar gr√°fica en canvas
        drawChart('demand-chart', salesData);

        // Alertas de inventario
        const alertsList = document.getElementById('alertsList');
        alertsList.innerHTML = '';
        const cfg = getStockLimits();
        const defaultLimit = Number(cfg.default ?? 30);
        const perItem = cfg.items || {};
        (alerts || []).forEach(item => {
          const percent = item.percent ?? item.level ?? 0;
          const name = item.name || item.item || 'Sin nombre';
          const limit = Number(perItem[name] ?? defaultLimit);
          const isCritical = percent <= limit;

          const div = document.createElement('div');
          div.className = 'stock-item';
          div.style.cursor = item.url ? 'pointer' : 'default';
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.style.padding = '6px 0';

          const left = document.createElement('div');
          left.innerHTML = '<span class="stock-item__name">' + escapeHtml(name) + '</span>';

          const right = document.createElement('div');
          right.style.display = 'flex';
          right.style.gap = '10px';
          right.style.alignItems = 'center';

          const bar = document.createElement('div');
          bar.style.display = 'flex';
          bar.style.alignItems = 'center';
          bar.innerHTML = '<div class="progress-bar" style="width:160px;margin-right:8px"><div class="progress-bar__fill ' + getFillClass(percent) + '" style="width:' + percent + '%"></div></div><span class="stock-item__percent">' + percent + '%</span>';

          const badge = document.createElement('span');
          badge.style.fontSize = '0.8rem';
          badge.style.padding = '4px 8px';
          badge.style.borderRadius = '6px';
          badge.style.background = isCritical ? 'rgba(255,99,71,0.12)' : 'transparent';
          badge.style.color = isCritical ? '#c53030' : 'var(--text-muted)';
          badge.textContent = isCritical ? 'Cr√≠tico (' + limit + '%)' : 'L√≠mite ' + limit + '%';

          const editBtn = document.createElement('button');
          editBtn.textContent = 'Editar l√≠mite';
          editBtn.className = 'icon-btn';
          editBtn.onclick = (ev) => { ev.stopPropagation(); showEditLimitForItem(name, perItem[name]); };

          right.appendChild(bar);
          right.appendChild(badge);
          right.appendChild(editBtn);

          if (item.url) div.onclick = () => window.location.href = item.url;

          div.appendChild(left);
          div.appendChild(right);
          alertsList.appendChild(div);
        });

        // si no hay alertas mostrar mensaje
        if (!alerts.length) {
          alertsList.innerHTML = '<div style="color:var(--text-muted); font-size:0.9rem;">Sin alertas cr√≠ticas</div>';
        }

        // Wire settings button and render stored limits
        const settingsBtn = document.getElementById('stock-settings-btn');
        if (settingsBtn) settingsBtn.onclick = (ev) => { ev.preventDefault(); showDefaultLimitEditor(); };
        // Wire edit-goal button for quarterly goal
        const editGoalBtn = document.getElementById('edit-goal-btn');
        if (editGoalBtn) editGoalBtn.onclick = (ev) => { ev.preventDefault();
          const current = (summary.quarterly_goal ?? null);
          const absolute = (summary.quarterly_goal_total ?? null);
          showEditQuarterlyGoal(current, absolute);
        };
        renderStockLimits();

      } catch (err) {
        console.error('Error cargando dashboard:', err);
      }
    }

    function formatCurrency(v, currency) {
      const n = Number(v) || 0;
      const symbol = (currency === 'USD' ? '$' : (currency ? currency + ' ' : '$'));
      return symbol + n.toLocaleString();
    }

    // ...existing helper functions (getFillClass, drawChart, escapeHtml)...
    function getFillClass(p) {
      if (p >= 70) return 'progress-bar__fill--high';
      if (p <= 30) return 'progress-bar__fill--low';
      return '';
    }

    function drawChart(canvasId, data) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !canvas.getContext) return;
      const ctx = canvas.getContext('2d');
      const DPR = window.devicePixelRatio || 1;

      // Compute visible size robustly
      const rect = canvas.getBoundingClientRect();
      const w = rect.width || canvas.parentElement?.clientWidth || 800;
      const h = rect.height || 250;

      // Set canvas drawing buffer and CSS size
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      canvas.width = Math.max(1, Math.floor(w * DPR));
      canvas.height = Math.max(1, Math.floor(h * DPR));

      // Reset transform and scale for DPR
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(DPR, DPR);

      ctx.clearRect(0, 0, w, h);
      const points = (data || []).map(d => (typeof d === 'number' ? {label:'', value:d} : {label: d.hour || d.label || '', value: d.value || 0}));
      if (!points.length) {
        // dibujar fondo suave cuando no hay datos
        ctx.fillStyle = '#f5f7fa';
        ctx.fillRect(0, 0, w, h);
        ctx.fillStyle = 'var(--text-muted, #6b7280)';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No hay datos de ventas por hora', w/2, h/2);
        return;
      }

      const values = points.map(p => p.value);
      const max = Math.max(...values);
      const min = Math.min(...values);
      const padding = 30;
      const usableW = w - padding * 2;
      const usableH = h - padding * 2;

      // eje x
      ctx.strokeStyle = '#e9eef2';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, h - padding);
      ctx.lineTo(w - padding, h - padding);
      ctx.stroke();

      // l√≠nea
      ctx.strokeStyle = '#1f8ef1';
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = padding + (i / (points.length - 1 || 1)) * usableW;
        const y = h - padding - ((p.value - min) / (max - min || 1)) * usableH;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // puntos y etiquetas peque√±as
      points.forEach((p, i) => {
        const x = padding + (i / (points.length - 1 || 1)) * usableW;
        const y = h - padding - ((p.value - min) / (max - min || 1)) * usableH;
        ctx.fillStyle = '#1f8ef1';
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = 'var(--text-muted)';
        ctx.font = '12px sans-serif';
        ctx.fillText(p.label || '', Math.max(5, x - 15), h - 8);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Stock limits persisted in localStorage under key 'stockLimits'
    function getStockLimits() {
      try {
        const raw = localStorage.getItem('stockLimits');
        if (!raw) return { default: 30, items: {} };
        const parsed = JSON.parse(raw);
        return { default: Number(parsed.default ?? 30), items: parsed.items || {} };
      } catch (e) {
        return { default: 30, items: {} };
      }
    }

    function saveStockLimits(obj) {
      localStorage.setItem('stockLimits', JSON.stringify(obj));
      renderStockLimits();
    }

    function renderStockLimits() {
      const el = document.getElementById('stockLimits');
      if (!el) return;
      const cfg = getStockLimits();
      const lines = [];
      const keys = Object.keys(cfg.items || {});
      if (keys.length) {
        lines.push('<div style="margin-top:6px"><strong>L√≠mites por √≠tem:</strong></div>');
        lines.push('<ul style="margin:6px 0 0 14px">' + keys.map(k => '<li>' + escapeHtml(k) + ': ' + cfg.items[k] + '%</li>').join('') + '</ul>');
      }
      el.innerHTML = lines.join('');
    }

    async function showEditLimitForItem(itemName, current) {
      const { value: percent } = await Swal.fire({
        title: 'Editar l√≠mite para "' + escapeHtml(itemName) + '"',
        input: 'number',
        inputLabel: 'L√≠mite (%)',
        inputValue: current ?? '',
        inputAttributes: { min: 0, max: 100, step: 1 },
        showCancelButton: true
      });
      if (percent === undefined || percent === null) return;
      const cfg = getStockLimits();
      cfg.items = cfg.items || {};
      cfg.items[itemName] = Number(percent || 0);
      saveStockLimits(cfg);
      loadDashboard();
    }

    async function showDefaultLimitEditor() {
      const cfg = getStockLimits();
      const { value: def } = await Swal.fire({
        title: 'L√≠mite por defecto de stock',
        input: 'number',
        inputLabel: 'Porcentaje cr√≠tico (%)',
        inputValue: cfg.default,
        inputAttributes: { min: 0, max: 100, step: 1 },
        showCancelButton: true
      });
      if (def === undefined || def === null) return;
      cfg.default = Number(def || 0);
      saveStockLimits(cfg);
      loadDashboard();
    }

    // Editar meta trimestral (modal + patch al backend si est√° disponible)
    async function showEditQuarterlyGoal(currentValue, currentTarget) {
      const { value: newGoal } = await Swal.fire({
        title: 'Editar Meta Trimestral',
        html: '<input id="swal-goal" type="number" class="swal2-input" placeholder="Porcentaje" value="' + (currentValue ?? '') + '">' +
              '<input id="swal-target" type="text" class="swal2-input" placeholder="Meta absoluta (ej. 450k)" value="' + (currentTarget ?? '') + '">',
        focusConfirm: false,
        showCancelButton: true,
        preConfirm: () => {
          const g = document.getElementById('swal-goal').value;
          const t = document.getElementById('swal-target').value;
          return { goal: g !== '' ? Number(g) : null, target: t };
        }
      });
      if (!newGoal) return;

      // Try to PATCH to known endpoints
      const payload = { goal: newGoal.goal, target: newGoal.target };
      const endpoints = [
        '/configuration/goals/quarterly',
        'http://localhost:3000/api/v1/kpi/configuration/goals/quarterly'
      ];
      let patched = false;
      for (const ep of endpoints) {
        try {
          const res = await fetch(ep, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ goal: payload.goal, target: payload.target }) });
          if (res.ok) { patched = true; break; }
        } catch (e) {
          // ignore and try next
        }
      }

      // Update UI locally regardless
      const qEls = [document.getElementById('quarterlyProgress'), document.getElementById('kpi-goal')];
      const qTargetEls = [document.getElementById('quarterlyTarget'), document.getElementById('kpi-goal-absolute')];
      if (payload.goal != null) qEls.forEach(e => { if (e) e.textContent = payload.goal + '%'; });
      if (payload.target != null) qTargetEls.forEach(e => { if (e) e.textContent = payload.target; });

      if (patched) {
        Swal.fire({ icon: 'success', title: 'Meta actualizada' });
      } else {
        Swal.fire({ icon: 'warning', title: 'Guardado local', text: 'No se pudo actualizar el backend; cambios aplicados localmente.' });
      }
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
