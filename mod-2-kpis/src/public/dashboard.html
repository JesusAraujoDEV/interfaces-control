<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - Charlotte</title>
    <link rel="stylesheet" href="/mod-2-kpis/src/public/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <div class="main-layout">
      <aside class="sidebar">
        <div class="sidebar__logo"><span class="icon">‚òï</span> CHARLOTTE</div>

        <nav class="sidebar__nav">
          <a
            href="/mod-2-kpis/src/public/dashboard.html"
            class="sidebar__menu-item sidebar__menu-item--active"
          >
            <i>üè†</i> Dashboard
          </a>
          <a href="/mod-2-kpis/src/public/bussines-intelligence.html" class="sidebar__menu-item">
            <i>üìä</i> Reportes
          </a>
          <a href="/mod-2-kpis/src/public/inventario.html" class="sidebar__menu-item">
            <i>üì¶</i> Inventario
          </a>
          <a href="/mod-2-kpis/src/public/eficiencia-operacional.html" class="sidebar__menu-item">
            <i>‚è±Ô∏è</i> Eficiencia
          </a>
          <a href="#" class="sidebar__menu-item" onclick="showAlertsHistory()">
            <i>üîî</i> Alertas
          </a>
          <a href="#" class="sidebar__menu-item"> <i>‚öôÔ∏è</i> Configuraci√≥n </a>
        </nav>

        <div class="sidebar__profile-footer">
          <div
            class="sidebar__avatar"
            style="
              background-image: url(&quot;user.jpg&quot;);
              background-size: cover;
            "
          ></div>
          <div>
            <p class="sidebar__user-name">Juan P√©rez</p>
            <p class="sidebar__user-role">Administrador</p>
          </div>
        </div>
      </aside>

      <main class="content">
        <header class="header-top">
          <div>
            <h1 class="header-top__title">HOLA, JUAN</h1>
            <p class="header-top__subtitle">
              Este es el resumen de tu negocio.
            </p>
          </div>
          <div
            class="date-badge"
            id="current-date-badge"
            style="
              background: white;
              padding: 8px 15px;
              border-radius: 8px;
              border: 1px solid var(--border-color);
              font-size: 0.8rem;
            "
          >
            üìÖ Cargando fecha...
          </div>
        </header>

        <section class="stats-grid">
          <div class="kpi-card">
            <p class="kpi-card__label">Ingresos</p>
            <p class="kpi-card__value" id="kpi-revenue">Loading...</p>
            <span class="kpi-card__trend" id="kpi-revenue-trend">--</span>
          </div>
          <div class="kpi-card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <p class="kpi-card__label">Meta Trimestral</p>
              <button id="edit-goal-btn" class="icon-btn" title="Editar Meta">
                ‚úèÔ∏è
              </button>
            </div>
            <p class="kpi-card__value" id="kpi-goal">Loading...</p>
            <p style="font-size: 0.7rem; color: var(--text-muted)" id="kpi-goal-absolute">$0k</p>
          </div>

          <div class="kpi-card">
            <p class="kpi-card__label">Tiempo Atenci√≥n</p>
            <p class="kpi-card__value" id="kpi-avg-time">Loading...</p>
            <span style="font-size: 0.8rem; color: var(--text-muted)"
              >√ìptimo ‚è±Ô∏è</span
            >
          </div>
          <div class="kpi-card">
            <p class="kpi-card__label">Rotaci√≥n</p>
            <p class="kpi-card__value" id="kpi-rotation">0.0 /hr</p>
            <span class="kpi-card__trend" id="kpi-rotation-target">Meta --</span>
          </div>
        </section>

        <div class="dashboard-main-grid">
          <div class="chart-container">
            <h2 class="card__title">Ventas por Hora</h2>
            <p class="kpi-card__value" style="font-size: 1.5rem">
              <span id="chart-revenue-today">$0</span>
              <span style="font-size: 0.8rem; color: #28a745" id="chart-revenue-trend">Hoy +0%</span>
            </p>
            <div style="width: 100%; height: 250px; margin-top: 20px">
              <canvas id="demand-chart"></canvas>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-top: 10px;
                color: var(--text-muted);
                font-size: 0.7rem;
              "
            >
              <span>8 AM</span><span>12 PM</span><span>4 PM</span
              ><span>8 PM</span>
            </div>
          </div>

          <div class="stock-alerts">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
              "
            >
              <h2 class="card__title" style="margin-bottom: 0">
                Alertas de Stock
              </h2>
              <button
                id="stock-settings-btn"
                class="icon-btn"
                title="Configurar L√≠mites"
              >
                ‚öôÔ∏è
              </button>
            </div>

            <div id="stock-alerts-list">
              <!-- Dynamically populated from API -->
              <p class="text-muted" style="font-size: 0.8rem">Cargando alertas...</p>
            </div>
        </aside>

        <main class="content">
            <header class="header-top">
                <div>
                    <h1 class="header-top__title">HOLA, JUAN</h1>
                    <p class="header-top__subtitle">Este es el resumen de tu negocio.</p>
                </div>
                <div class="date-badge" style="background: white; padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.8rem;">
                    üìÖ Hoy, Dic 01
                </div>
            </header>

            <section class="stats-grid">
                <div class="kpi-card">
                    <p class="kpi-card__label">Ingresos</p>
                    <p id="incomeValue" class="kpi-card__value">$0</p>
                    <span id="incomeTrend" class="kpi-card__trend kpi-card__trend--up">0%</span>
                </div>
                <div class="kpi-card">
                    <p class="kpi-card__label">Meta Trimestral</p>
                    <p id="quarterlyProgress" class="kpi-card__value">0%</p>
                    <p id="quarterlyTarget" style="font-size: 0.7rem; color: var(--text-muted);">$0</p>
                </div>
                <div class="kpi-card">
                    <p class="kpi-card__label">Tiempo Atenci√≥n</p>
                    <p id="rotationValue" class="kpi-card__value">00:00</p>
                    <span id="timeStatus" style="font-size: 0.8rem; color: var(--text-muted);">--</span>
                </div>
                <div class="kpi-card" onclick="window.location.href='operaciones.html'" style="cursor:pointer">
                    <p class="kpi-card__label">Rotaci√≥n</p>
                    <p id="rotationRate" class="kpi-card__value">0 /hr</p>
                    <span id="rotationStatus" class="kpi-card__trend kpi-card__trend--down">--</span>
                </div>
            </section>

            <div class="dashboard-main-grid">
                <div class="chart-container">
                    <h2 class="card__title">Ventas por Hora</h2>
                    <p id="salesValue" class="kpi-card__value" style="font-size: 1.5rem;">$0 <span id="salesChange" style="font-size: 0.8rem; color: #28a745;"></span></p>
                    <canvas id="salesChart" width="800" height="250" style="width:100%; height:250px; border-radius: 0 0 10px 10px; display:block; margin-top:20px;"></canvas>
                    <div id="salesLabels" style="display: flex; justify-content: space-between; margin-top: 10px; color: var(--text-muted); font-size: 0.7rem;">
                        <span></span><span></span><span></span><span></span>
                    </div>
                </div>

                <div class="stock-alerts">
                    <h2 class="card__title">Alertas de Stock</h2>
                    
                    <div id="alertsList">
                        <!-- alertas ser√°n renderizadas aqu√≠ -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
    // Carga datos desde la API y actualiza la interfaz
    async function loadDashboard() {
      try {
        const [summaryRes, alertsRes] = await Promise.all([
          fetch('http://localhost:3000/api/v1/kpi/dashboard/summary'),
          fetch('http://localhost:3000/api/v1/kpi/inventory/alerts')
        ]);
        
        const summaryJson = summaryRes.ok ? await summaryRes.json() : {};
        const alertsJson = alertsRes.ok ? await alertsRes.json() : {};
        const summary = summaryJson.data || {};
        const alerts = alertsJson.alerts || [];
        console.log('Dashboard summary:', summary);
        // Ingresos
        const incomeEl = document.getElementById('incomeValue');
        const incomeTrendEl = document.getElementById('incomeTrend');
        const revenue = summary.revenue || {};
        if (revenue.total != null) incomeEl.textContent = formatCurrency(revenue.total, revenue.currency);
        if (revenue.trend_percentage != null) incomeTrendEl.textContent = (revenue.trend_direction === 'down' ? '-' : (revenue.trend_direction === 'up' ? '+' : '')) + revenue.trend_percentage + '%';

        // Meta trimestral
        const quarterly = summary.quarterly_goal || {};
        const quarterlyProgressEl = document.getElementById('quarterlyProgress');
        const quarterlyTargetEl = document.getElementById('quarterlyTarget');
        if (quarterly.progress_percentage != null) quarterlyProgressEl.textContent = (quarterly.progress_percentage) + '%';
        if (quarterly.target != null) quarterlyTargetEl.textContent = formatCurrency(quarterly.target, revenue.currency);

        // Rotaci√≥n / Tiempo atenci√≥n
        const ops = summary.operations || {};
        if (ops.avg_service_time) document.getElementById('rotationValue').textContent = ops.avg_service_time;
        if (ops.time_status) document.getElementById('timeStatus').textContent = ops.time_status;
        if (ops.table_rotation != null) document.getElementById('rotationRate').textContent = ops.table_rotation + ' /hr';
        if (ops.rotation_status) document.getElementById('rotationStatus').textContent = ops.rotation_status;

        // Ventas por hora y valor total hoy (no vienen en la respuesta de ejemplo; manejar vac√≠o)
        const salesData = summary.sales_by_hour || summary.sales_hours || [];
        const totalToday = summary.sales_total_today ?? (Array.isArray(salesData) ? salesData.reduce((s,i)=>s + (typeof i === 'number' ? i : (i.value||0)),0) : 0);
        const salesValueEl = document.getElementById('salesValue');
        const salesChangeEl = document.getElementById('salesChange');
        salesValueEl.firstChild && salesValueEl.firstChild.nodeValue !== undefined && (salesValueEl.firstChild.nodeValue = formatCurrency(totalToday, revenue.currency) + ' ');
        if (summary.sales_change) salesChangeEl.textContent = 'Hoy ' + summary.sales_change;

        // Etiquetas debajo de la gr√°fica
        const labelsEl = document.getElementById('salesLabels');
        if (salesData.length) {
          const labels = salesData.map(d => (d.hour || d.label || ''));
          labelsEl.innerHTML = labels.map(l => '<span>' + escapeHtml(l || '') + '</span>').join('');
        } else {
          labelsEl.innerHTML = '<span>--</span><span>--</span><span>--</span><span>--</span>';
        }

        // Dibujar gr√°fica en canvas
        drawChart('salesChart', salesData);

        // Alertas de inventario
        const alertsList = document.getElementById('alertsList');
        alertsList.innerHTML = '';
        (alerts || []).forEach(item => {
          const percent = item.percent ?? item.level ?? 0;
          const div = document.createElement('div');
          div.className = 'stock-item';
          div.style.cursor = item.url ? 'pointer' : 'default';
          div.innerHTML = `
            <span class="stock-item__name">${escapeHtml(item.name || item.item || 'Sin nombre')}</span>
            <div style="display:flex;align-items:center;">
              <div class="progress-bar"><div class="progress-bar__fill ${getFillClass(percent)}" style="width:${percent}%;"></div></div>
              <span class="stock-item__percent">${percent}%</span>
            </div>`;
          if (item.url) div.onclick = () => window.location.href = item.url;
          alertsList.appendChild(div);
        });

        // si no hay alertas mostrar mensaje
        if (!alerts.length) {
          alertsList.innerHTML = '<div style="color:var(--text-muted); font-size:0.9rem;">Sin alertas cr√≠ticas</div>';
        }

      } catch (err) {
        console.error('Error cargando dashboard:', err);
      }
    }

    function formatCurrency(v, currency) {
      const n = Number(v) || 0;
      const symbol = (currency === 'USD' ? '$' : (currency ? currency + ' ' : '$'));
      return symbol + n.toLocaleString();
    }

    // ...existing helper functions (getFillClass, drawChart, escapeHtml)...
    function getFillClass(p) {
      if (p >= 70) return 'progress-bar__fill--high';
      if (p <= 30) return 'progress-bar__fill--low';
      return '';
    }

    function drawChart(canvasId, data) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !canvas.getContext) return;
      const ctx = canvas.getContext('2d');
      const DPR = window.devicePixelRatio || 1;
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      canvas.width = w * DPR;
      canvas.height = h * DPR;
      ctx.scale(DPR, DPR);

      ctx.clearRect(0, 0, w, h);
      const points = (data || []).map(d => typeof d === 'number' ? {label:'', value:d} : {label: d.hour || d.label || '', value: d.value || 0});
      if (!points.length) {
        // dibujar fondo suave cuando no hay datos
        ctx.fillStyle = '#f5f7fa';
        ctx.fillRect(0, 0, w, h);
        return;
      }

      const values = points.map(p => p.value);
      const max = Math.max(...values);
      const min = Math.min(...values);
      const padding = 30;
      const usableW = w - padding * 2;
      const usableH = h - padding * 2;

      // eje x
      ctx.strokeStyle = '#e9eef2';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, h - padding);
      ctx.lineTo(w - padding, h - padding);
      ctx.stroke();

      // l√≠nea
      ctx.strokeStyle = '#1f8ef1';
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = padding + (i / (points.length - 1 || 1)) * usableW;
        const y = h - padding - ((p.value - min) / (max - min || 1)) * usableH;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // puntos y etiquetas peque√±as
      points.forEach((p, i) => {
        const x = padding + (i / (points.length - 1 || 1)) * usableW;
        const y = h - padding - ((p.value - min) / (max - min || 1)) * usableH;
        ctx.fillStyle = '#1f8ef1';
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = 'var(--text-muted)';
        ctx.font = '12px sans-serif';
        ctx.fillText(p.label || '', Math.max(5, x - 15), h - 8);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
