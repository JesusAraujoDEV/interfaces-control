<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Eficiencia Operacional - Charlotte</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4" id="body">

    <div class="main-layout">
        <aside class="sidebar">
            <div class="sidebar__logo">
                <span class="icon">‚òï</span> CHARLOTTE
                <p style="font-size: 0.6rem; font-weight: normal; margin-top: -5px;">Sweet & Coffee</p>
            </div>

            <nav class="sidebar__nav">
                <a href="dashboard.html" class="sidebar__menu-item"><i>üè†</i> Dashboard</a>
                <a href="index.html" class="sidebar__menu-item"><i>üìä</i> An√°lisis de Ventas</a>
                <a href="eficiencia.html" class="sidebar__menu-item sidebar__menu-item--active"><i>‚è±Ô∏è</i> Eficiencia Operacional</a>
                <a href="#" class="sidebar__menu-item"><i>üì¶</i> Inventario</a>
                <a href="#" class="sidebar__menu-item"><i>üì£</i> Marketing</a>
            </nav>

            <div class="sidebar__profile-footer">
                <div class="sidebar__avatar" style="background-color: #ccc;"></div>
                <div class="sidebar__logout" style="border:none; padding:0;">
                    <a href="#" class="sidebar__menu-item" style="margin:0; padding:0; font-size: 0.8rem;">‚öôÔ∏è Configuraci√≥n</a>
                    <a href="#" class="sidebar__menu-item" style="margin:0; padding:0; font-size: 0.8rem;">‚ùì Ayuda</a>
                </div>
            </div>
        </aside>

        <main class="content">
            <header class="header-top">
                <div>
                    <h1 class="header-top__title" style="color: var(--primary-color);">Eficiencia Operacional</h1>
                    <p class="header-top__subtitle">Tiempo y Personal</p>
                </div>
            </header>

            <div id="app" class="container mx-auto p-4">
                <!-- El contenido se renderizar√° aqu√≠ con JavaScript -->
            </div>

            <div class="dashboard-main-grid">
                <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
                <h1 class="text-2xl font-bold mb-4">Ranking de Meseros</h1>
                <div id="shift-indicator" class="mb-4 text-center font-semibold"></div>
                <table id="ranking-table" class="w-full table-auto border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="px-4 py-2 text-left">Avatar</th>
                            <th class="px-4 py-2 text-left">Nombre</th>
                            <th class="px-4 py-2 text-left">Pedidos Totales</th>
                            <th class="px-4 py-2 text-left">Tiempo Promedio</th>
                            <th class="px-4 py-2 text-left">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- Las filas se agregar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
                <div id="pagination" class="mt-4 flex justify-center">
                    <!-- Botones de paginaci√≥n se agregar√°n aqu√≠ -->
                </div>
            </div>

                <section class="meta-section">
                    <h2 class="card__title text-xl font-bold" style="color: var(--primary-color);">Meta de Rotaci√≥n</h2>
                    <div class="card gauge-container bg-white p-4 rounded-lg shadow-md">
                        <div class="gauge-placeholder">
                            <div class="gauge-placeholder__fill"></div>
                        </div>
                        <p class="gauge-container__value text-2xl font-bold mt-2" id="current-value">Cargando...</p>
                        <p class="gauge-container__label text-sm text-gray-600">Rotaci√≥n Actual</p>
                        <p style="font-size: 0.7rem; margin-top: 15px; color: var(--text-muted);">
                            <span class="dot dot--danger" style="width: 6px; height: 6px;"></span> Meta: <span id="target-value">Cargando...</span>
                        </p>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <script>
        function updateGauge(current, target) {
            const percentage = Math.min((current / target) * 100, 100); // M√°ximo 100%
            document.documentElement.style.setProperty('--percentage', percentage);
            document.getElementById('current-value').textContent = current.toFixed(1);
            document.getElementById('target-value').textContent = target.toFixed(1);
        }

    // Funci√≥n para hacer fetch a la API
    async function fetchRotationData() {
        try {
            const response = await fetch('http://localhost:3000/api/v1/kpi/operations/staff-ranking');
            if (!response.ok) throw new Error('Error en la API');
            const result = await response.json();
            if (result.success && result.data && result.data.length > 0) {
                // Calcular el promedio de efficiency_score como "rotaci√≥n actual"
                const totalScore = result.data.reduce((sum, item) => sum + item.efficiency_score, 0);
                const averageScore = totalScore / result.data.length;
                const target = 1007; 
                updateGauge(averageScore, target);
            } else {
                console.error('Datos inv√°lidos o array vac√≠o en la API');
                updateGauge(0, 107); // Valor por defecto
            }
        } catch (error) {
            console.error('Error al cargar datos:', error);
            updateGauge(0, 107); // Valor por defecto
        }
    }

    // Llamar a la funci√≥n al cargar la p√°gina
    window.addEventListener('load', fetchRotationData);

        // Funci√≥n para obtener iniciales del nombre
        function getInitials(name) {
            return name.split(' ').map(word => word.charAt(0).toUpperCase()).join('');
        }

        // Funci√≥n para mapear estado
        function mapStatus(status) {
            return status === 'ACTIVE' ? 'Activo' : 'Descanso';
        }

        // Funci√≥n para obtener clase del badge
        function getStatusClass(status) {
            return status === 'Activo' ? 'active' : 'rest';
        }

        // Funci√≥n para cargar datos de la API
        async function loadRanking(sort_by="EFFICIENCY", page = 1, limit = 10) {
            try {
                // Reemplaza con la URL real de tu API
                const response = await fetch(`http://localhost:3000/api/v1/kpi/operations/staff-ranking?sort_by=${sort_by}&page=${page}&limit=${limit}`);
                const result = await response.json();
                
                if (result.success) {
                    const { data, meta } = result;
                    populateTable(data);
                    setupPagination(meta);
                } else {
                    console.error('Error en la respuesta de la API');
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        // Funci√≥n para poblar la tabla
        function populateTable(ranking) {
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = ''; // Limpiar contenido anterior

            ranking.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50'; // Zebra striping

                const avatarCell = document.createElement('td');
                avatarCell.className = 'px-4 py-2';
                const avatar = document.createElement('div');
                avatar.className = 'avatar-circle';
                avatar.textContent = getInitials(item.name);
                avatarCell.appendChild(avatar);

                const nameCell = document.createElement('td');
                nameCell.className = 'px-4 py-2';
                nameCell.textContent = item.name;

                const ordersCell = document.createElement('td');
                ordersCell.className = 'px-4 py-2';
                ordersCell.textContent = item.total_orders;

                const timeCell = document.createElement('td');
                timeCell.className = 'px-4 py-2';
                timeCell.textContent = `${item.avg_time_minutes} min`;

                const statusCell = document.createElement('td');
                statusCell.className = 'px-4 py-2';
                const badge = document.createElement('span');
                badge.className = `status-badge ${getStatusClass(mapStatus(item.current_status))}`;
                badge.textContent = mapStatus(item.current_status);
                statusCell.appendChild(badge);

                row.appendChild(avatarCell);
                row.appendChild(nameCell);
                row.appendChild(ordersCell);
                row.appendChild(timeCell);
                row.appendChild(statusCell);

                tbody.appendChild(row);
            });
        }

        // Funci√≥n para configurar paginaci√≥n
        function setupPagination(meta) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = ''; // Limpiar

            const totalPages = Math.ceil(meta.total_items / meta.per_page);
            const currentPage = meta.current_page;

            // Bot√≥n anterior
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded mr-2';
                prevBtn.textContent = 'Anterior';
                prevBtn.onclick = () => loadRanking(currentPage - 1, meta.per_page);
                paginationDiv.appendChild(prevBtn);
            }

            // Bot√≥n siguiente
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded';
                nextBtn.onclick = () => loadRanking(currentPage + 1, meta.per_page);
                paginationDiv.appendChild(nextBtn);
            }
        }

        // Cargar datos iniciales al cargar la p√°gina
        window.onload = () => loadRanking();

        let data = null;
    let loading = true;
    let error = null;

    // URL de la API (usando un valor por defecto ya que process.env no est√° disponible en vanilla JS)
    const API_URL = 'http://localhost:3000/api/v1/kpi/operations/sla-breakdown'; // Ajusta si es necesario

    // Funci√≥n para renderizar una zona
    function renderZone(zoneName, zoneData, bgColor, textColor) {
      return `
        <div class="p-4 rounded-lg shadow-md ${bgColor} ${textColor} mb-4">
          <h3 class="text-lg font-bold mb-2 capitalize">${zoneName.replace('_', ' ')}</h3>
          <p class="mb-1">${zoneData} %</p>
        </div>
      `;
    }

    // Funci√≥n para renderizar el componente completo
    function render() {
      const app = document.getElementById('app');

      if (loading) {
        app.innerHTML = '<p class="text-center">Cargando datos...</p>';
        return;
      }

      if (error) {
        app.innerHTML = `<p class="text-center text-red-500">${error}</p>`;
        return;
      }

      app.innerHTML = `
        <h2 class="text-2xl font-bold mb-6 text-center">Desglose de SLA de Comandas</h2>
        
        <!-- Bloque para la fecha -->
        <div class="p-4 rounded-lg shadow-md bg-gray-100 text-gray-800 mb-6">
          <h3 class="text-lg font-bold">Fecha</h3>
          <p>${data.data_timestamp || 'Fecha no disponible'}</p>
        </div>

        <!-- Bloques para las zonas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          ${renderZone('green_zone', data.green_zone_percent, 'bg-green-100', 'text-green-800')}
          ${renderZone('yellow_zone', data.yellow_zone_percent, 'bg-yellow-100', 'text-yellow-800')}
          ${renderZone('red_zone', data.red_zone_percent, 'bg-red-100', 'text-red-800')}
        </div>
      `;
    }

    // Funci√≥n para obtener datos de la API
    async function fetchData() {
      try {
        const response = await fetch(API_URL.toString(), {headers: {
          "Content-Type": "application/json",
        }});
        if (!response.ok) {
          throw new Error('Error en la respuesta de la API');
        }
        const result = await response.json();
        data = result;
        loading = false;
        render();
      } catch (err) {
        error = 'Error al cargar los datos. Verifica la conexi√≥n a la API.';
        loading = false;
        render();
      }
    }

    // Inicializar: llamar a fetchData y renderizar inicialmente
    render(); // Render inicial con loading
    fetchData();
    </script>
</body>
</html>