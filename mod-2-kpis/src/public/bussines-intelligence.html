<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informes Hist贸ricos - Charlotte</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://kit.fontawesome.com/your-code.js" crossorigin="anonymous"></script>
</head>

<body>

    <div class="main-layout">
        <aside class="sidebar">
            <div class="sidebar__profile">
                <div class="sidebar__avatar"></div>
                <div>
                    <p class="sidebar__user-name">Charlotte</p>
                    <p class="sidebar__user-role">Sweet & Coffee</p>
                </div>
            </div>

            <nav class="sidebar__nav">
                <a href="#" class="sidebar__menu-item sidebar__menu-item--active">
                    <span></span> Business Intelligence
                </a>
                <a href="#" class="sidebar__menu-item">
                    <span></span> Inventario
                </a>
                <a href="#" class="sidebar__menu-item">
                    <span></span> Empleados
                </a>
                <a href="#" class="sidebar__menu-item">
                    <span>锔</span> Configuraci贸n
                </a>
            </nav>

            <div class="sidebar__logout">
                <a href="#" class="sidebar__menu-item">
                    <span></span> Cerrar Sesi贸n
                </a>
            </div>
        </aside>

        <main class="content">
            <header class="header-top">
                <div>
                    <h1 class="header-top__title">Informes Hist贸ricos</h1>
                    <p class="header-top__subtitle">Descarga de datos hist贸ricos y contabilidad.</p>
                </div>
                <button class="btn-primary">
                    <span></span> Exportar a Excel (.CSV)
                </button>
            </header>

            <div class="dashboard-grid">
                <aside class="filters-section">
                    <div class="card">
                        <h2 class="card__title">Filtros</h2>

                        <div class="filter-group">
                            <label
                                style="display:block; margin-bottom: 10px; font-weight: 600; font-size: 0.9rem;">Rango
                                de Fechas</label>
                            <div class="calendar-widget">
                                <div class="calendar-widget__header">
                                    <span>&lt;</span> Agosto 2024 <span>&gt;</span>
                                </div>
                                <div class="calendar-widget__grid">
                                    <span>LU</span><span>MA</span><span>MI</span><span>JU</span><span>VI</span><span>SA</span><span>DO</span>
                                    <span class="calendar-widget__day">1</span><span
                                        class="calendar-widget__day">2</span><span
                                        class="calendar-widget__day">3</span><span class="calendar-widget__day">4</span>
                                    <span class="calendar-widget__day calendar-widget__day--selected">5</span><span
                                        class="calendar-widget__day">6</span><span
                                        class="calendar-widget__day">7</span><span
                                        class="calendar-widget__day">8</span><span
                                        class="calendar-widget__day">9</span><span
                                        class="calendar-widget__day calendar-widget__day--selected">10</span>
                                </div>
                            </div>
                        </div>

                        <div class="filter-group" style="margin-top: 2rem;">
                            <label style="display:block; margin-bottom: 10px; font-weight: 600; font-size: 0.9rem;">Tipo
                                de Informe</label>
                            <select
                                style="width:100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                                <option>Ventas</option>
                            </select>
                        </div>

                        <button class="btn-primary" style="width: 100%; margin-top: 2rem; justify-content: center;">
                            Aplicar Filtros
                        </button>
                    </div>
                </aside>

                <section class="table-section">
                    <div class="card"
                        style="padding: 0; overflow: hidden; display: flex; flex-direction: column; height: 500px;">

                        <!-- Header fijo -->
                        <div style="background-color: var(--primary-color); color: white; padding-right: 17px;">
                            <!-- padding-right para compensar scrollbar -->
                            <table class="data-table" style="margin-bottom: 0;">
                                <thead class="data-table__thead">
                                    <tr>
                                        <th class="data-table__th" style="width: 15%;">ID TRANSACCIN</th>
                                        <th class="data-table__th" style="width: 15%;">FECHA</th>
                                        <th class="data-table__th" style="width: 10%;">HORA</th>
                                        <th class="data-table__th" style="width: 25%;">CAMARERO</th>
                                        <th class="data-table__th" style="width: 15%;">CANTIDAD</th>
                                        <th class="data-table__th" style="width: 20%;">DURACIN TOTAL</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>

                        <!-- Contenedor con scroll (VIRTUALIZADO) -->
                        <div id="virtual-scroller" style="flex-grow: 1; overflow-y: auto; position: relative;">
                            <!-- Elemento fantasma para dar altura total -->
                            <div id="ghost-height" style="height: 0;"></div>

                            <!-- Tabla real que se mueve -->
                            <table class="data-table" id="real-table"
                                style="position: absolute; top: 0; left: 0; width: 100%;">
                                <tbody id="table-body">
                                    <!-- Rows injected by JS -->
                                </tbody>
                            </table>
                        </div>

                        <div
                            style="padding: 10px; border-top: 1px solid var(--border-color); font-size: 0.8rem; color: var(--text-muted);">
                            <span id="record-count">Cargando transacciones...</span>
                        </div>
                    </div>
                </section>

                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const scroller = document.getElementById('virtual-scroller');
                        const ghost = document.getElementById('ghost-height');
                        const realTable = document.getElementById('real-table');
                        const tbody = document.getElementById('table-body');
                        const countLabel = document.getElementById('record-count');

                        const ROW_HEIGHT = 51; // Aprox height per row (check CSS)
                        let allData = [];

                        // 1. Fetch Data
                        fetch('/api/v1/kpi/business/transactions')
                            .then(res => res.json())
                            .then(response => {
                                allData = response.data || [];
                                const count = allData.length;

                                // Set total height
                                ghost.style.height = `${count * ROW_HEIGHT}px`;
                                countLabel.innerText = `Mostrando ${count} registros (Renderizado de Alto Rendimiento)`;

                                // Initial Render
                                renderSlice();
                            });

                        // 2. Virtual Scroll Logic
                        const renderSlice = () => {
                            const scrollTop = scroller.scrollTop;
                            const viewportHeight = scroller.clientHeight;

                            // Calculate start/end index
                            const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
                            const endIndex = Math.min(
                                allData.length,
                                Math.floor((scrollTop + viewportHeight) / ROW_HEIGHT) + 5 // Buffer
                            );

                            // Create rows string
                            let rowsHtml = '';
                            for (let i = startIndex; i < endIndex; i++) {
                                const item = allData[i];
                                rowsHtml += `
                        <tr style="height: ${ROW_HEIGHT}px;">
                            <td class="data-table__td" style="width: 15%;">${item.id}</td>
                            <td class="data-table__td" style="width: 15%;">${item.date}</td>
                            <td class="data-table__td" style="width: 10%;">${item.time}</td>
                            <td class="data-table__td" style="width: 25%;">${item.waiter}</td>
                            <td class="data-table__td" style="width: 15%;"><strong>$${item.amount}</strong></td>
                            <td class="data-table__td" style="width: 20%;">${item.duration}</td>
                        </tr>
                    `;
                            }

                            // Update DOM
                            tbody.innerHTML = rowsHtml;
                            // Move table to correct position
                            realTable.style.transform = `translateY(${startIndex * ROW_HEIGHT}px)`;
                        };

                        // Listen to scroll
                        scroller.addEventListener('scroll', () => {
                            window.requestAnimationFrame(renderSlice);
                        });
                    });
                </script>

            </div>
        </main>
    </div>

</body>

</html>