<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inventario - Charlotte</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

    <div class="main-layout">
        <aside class="sidebar">
            <div class="sidebar__logo">
                <span class="icon">‚òï</span> CHARLOTTE
            </div>

            <nav class="sidebar__nav">
                <a href="dashboard.html" class="sidebar__menu-item"><i>üè†</i> Dashboard</a>
                <a href="inventario.html" class="sidebar__menu-item sidebar__menu-item--active"><i>üì¶</i> Inventario</a>
                <a href="index.html" class="sidebar__menu-item"><i>üìä</i> Reportes</a>
                <a href="eficiencia.html" class="sidebar__menu-item"><i>‚è±Ô∏è</i> Eficiencia</a>
                <a href="#" class="sidebar__menu-item"><i>‚öôÔ∏è</i> Configuraci√≥n</a>
            </nav>

            <div class="sidebar__profile-footer">
                <a href="#" class="sidebar__menu-item"><i>‚ùì</i> Ayuda</a>
            </div>
        </aside>

        <main class="content">
            <header class="header-top">
                <div>
                    <h1 class="header-top__title">Inteligencia de Inventario</h1>
                    <p class="header-top__subtitle">An√°lisis de stock y rendimiento del men√∫.</p>
                </div>
                <button class="btn-primary">üì§ Exportar Reporte</button>
            </header>

            <div class="tabs-container">
                <button class="tab tab--active">√öltimos 30 d√≠as ‚ñæ</button>
                <button class="tab">Semana Actual</button>
                <button class="tab">Mes Actual</button>
                <button class="tab">A√±o Actual</button>
            </div>

            <h1 class="text-2xl font-bold mb-4 text-center ">Gr√°fico de Pareto y Alertas - Inventario de Cafeter√≠a</h1>
            <div class="dashboard-main-grid">
                
                <div class="flex flex-col md:flex-row gap-6">
                <!-- Gr√°fico de Pareto -->
                <div class="flex-1">
                    <h2 class="text-lg font-semibold mb-2">Gr√°fico de Pareto</h2>
                    <div id="pareto-chart" class="w-full h-96 bg-gray-50 rounded-lg flex items-end justify-center relative">
                        <!-- Aqu√≠ se renderizar√° el gr√°fico SVG -->
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Datos obtenidos de la API. El producto campe√≥n est√° resaltado en rojo.</p>
                </div>
                </div>
                
                <!-- Panel de Alertas -->
                <div class="w-full md:w-1/3">
                    <h2 class="text-lg font-semibold mb-2">Alertas de Inventario</h2>
                    <div id="alerts-panel" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto inline-block">
                        <!-- Aqu√≠ se renderizar√°n las alertas -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        async function fetchParetoData() {
            try {
                const response = await fetch('http://localhost:3000/api/v1/kpi/inventory/pareto');
                if (!response.ok) throw new Error('Error en la API');
                const data = await response.json();
                console.log('Datos del Pareto recibidos:', data);
                if (data.success) {
                    renderParetoChart(data.data.data);
                } else {
                    console.error('Respuesta no exitosa de la API');
                }
            } catch (error) {
                console.error('Error al obtener datos del Pareto:', error);
                document.getElementById('pareto-chart').innerHTML = '<p class="text-red-500">Error al cargar datos del gr√°fico.</p>';
            }
        }

        // Funci√≥n para obtener datos de alertas
        async function fetchAlertsData() {
            try {
                const response = await fetch('http://localhost:3000/api/v1/kpi/inventory/alerts');
                if (!response.ok) throw new Error('Error en la API');
                const data = await response.json();
                renderAlertsPanel(data);
            } catch (error) {
                console.error('Error al obtener datos de alertas:', error);
                document.getElementById('alerts-panel').innerHTML = '<p class="text-red-500">Error al cargar alertas.</p>';
            }
        }

        // Funci√≥n para renderizar el gr√°fico de Pareto (sin cambios)
        function renderParetoChart(products) {
            const chartContainer = document.getElementById('pareto-chart');
            chartContainer.innerHTML = ''; // Limpiar contenido anterior

            if (!products || products.length === 0) {
                chartContainer.innerHTML = '<p class="text-gray-500">No hay datos disponibles.</p>';
                return;
            }

            // Helper: convierte nombres t√©cnicos a uno legible
            function humanizeName(name) {
                if (!name) return '';
                let s = String(name).replace(/[_\-]+/g, ' ').replace(/\s+/g, ' ').trim();
                s = s.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                return s.length > 24 ? s.slice(0, 21) + '...' : s;
            }

            // Ordenar por revenue descendente
            products.sort((a, b) => b.revenue_generated - a.revenue_generated);

            // Configurable: mostrar solo los N mejores + "Otros"
            const TOP_N = 6;
            const topList = products.slice(0, TOP_N);
            const restList = products.slice(TOP_N);
            const othersSum = restList.reduce((s, p) => s + (p.revenue_generated || 0), 0);
            const totalRevenue = products.reduce((s, p) => s + (p.revenue_generated || 0), 0);

            if (othersSum > 0) {
                topList.push({
                    name: 'Otros',
                    revenue_generated: othersSum,
                    quantity_sold: restList.reduce((s, p) => s + (p.quantity_sold || 0), 0)
                });
            }

            const productsToRender = topList;

            // Dimensiones del gr√°fico
            const width = chartContainer.clientWidth || 800;
            const height = chartContainer.clientHeight || 400;
            const margin = { top: 20, right: 60, bottom: 80, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            // Crear SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('class', 'w-full h-full');
            chartContainer.appendChild(svg);

            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
            svg.appendChild(g);

            // Escalas simples
            const maxRevenue = Math.max(...productsToRender.map(p => p.revenue_generated || 0), 1);
            const barWidth = innerWidth / productsToRender.length * 0.7;
            const barSpacing = innerWidth / productsToRender.length * 0.3;

            // Dibujar barras y calcular puntos acumulativos basados en totalRevenue real
            let cumulativePercent = 0;
            const points = [];
            productsToRender.forEach((product, index) => {
                const rev = product.revenue_generated || 0;
                const barHeight = (rev / maxRevenue) * innerHeight;
                const x = index * (barWidth + barSpacing);
                const y = innerHeight - barHeight;

                // Color: primer producto destacado, "Otros" gris, los dem√°s verde
                let fillColor = '#A5D6A7';
                if (index === 0) fillColor = '#795548';
                if (product.name === 'Otros') fillColor = '#9CA3AF';

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', fillColor);
                rect.setAttribute('class', 'cursor-pointer');
                rect.setAttribute('title', `${humanizeName(product.name)}: $${rev.toFixed(2)} (Cant: ${product.quantity_sold || 0}) ‚Äî ${(rev / totalRevenue * 100 || 0).toFixed(1)}%`);
                g.appendChild(rect);

                // Etiqueta legible abajo (rotar si es necesario)
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + barWidth / 2);
                text.setAttribute('y', innerHeight + 24);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('class', 'text-xs fill-gray-700');
                text.textContent = humanizeName(product.name);
                g.appendChild(text);

                // Porcentaje acumulado respecto al total real
                cumulativePercent += (rev / totalRevenue) * 100;
                points.push({ x: x + barWidth / 2, y: innerHeight - (cumulativePercent / 100) * innerHeight });
            });

            // L√≠nea acumulativa
            if (points.length > 1) {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let d = `M ${points[0].x} ${points[0].y}`;
                points.forEach(point => { d += ` L ${point.x} ${point.y}`; });
                path.setAttribute('d', d);
                path.setAttribute('stroke', '#10b981');
                path.setAttribute('stroke-width', 2);
                path.setAttribute('fill', 'none');
                g.appendChild(path);
            }

            // Eje Y izquierdo (ingresos) ‚Äî ajustar etiquetas usando maxRevenue real de los renderizados
            const yAxisLeft = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            for (let i = 0; i <= 5; i++) {
                const y = innerHeight - (i / 5) * innerHeight;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', -5);
                line.setAttribute('y1', y);
                line.setAttribute('x2', 0);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#ccc');
                yAxisLeft.appendChild(line);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', -10);
                label.setAttribute('y', y + 5);
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('class', 'text-xs fill-gray-700');
                label.textContent = `$${(maxRevenue * i / 5).toFixed(0)}`;
                yAxisLeft.appendChild(label);
            }
            g.appendChild(yAxisLeft);

            // Eje Y derecho (porcentaje)
            const yAxisRight = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            for (let i = 0; i <= 5; i++) {
                const y = innerHeight - (i / 5) * innerHeight;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', innerWidth);
                line.setAttribute('y1', y);
                line.setAttribute('x2', innerWidth + 5);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#ccc');
                yAxisRight.appendChild(line);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', innerWidth + 15);
                label.setAttribute('y', y + 5);
                label.setAttribute('text-anchor', 'start');
                label.setAttribute('class', 'text-xs fill-gray-700');
                label.textContent = `${i * 20}%`;
                yAxisRight.appendChild(label);
            }
            g.appendChild(yAxisRight);
        }

        // Funci√≥n para renderizar el panel de alertas
        function renderAlertsPanel(data) {
            const panel = document.getElementById('alerts-panel');
            panel.innerHTML = ''; // Limpiar contenido anterior

            // Mostrar critical_count
            const criticalHeader = document.createElement('div');
            criticalHeader.className = 'mb-4 p-2 bg-red-100 border border-red-300 rounded';
            criticalHeader.innerHTML = `<strong>Alertas Cr√≠ticas:</strong> ${data.critical_count}`;
            panel.appendChild(criticalHeader);

            // Lista de alertas
            if (data.alerts && data.alerts.length > 0) {
                const list = document.createElement('ul');
                list.className = 'space-y-2';
                data.alerts.forEach(alert => {
                    const item = document.createElement('li');
                    item.className = `p-3 border rounded ${
                        alert.severity === 'CRITICAL' ? 'bg-red-50 border-red-300' :
                        alert.severity === 'WARNING' ? 'bg-yellow-50 border-yellow-300' :
                        'bg-green-50 border-green-300'
                    }`;
                    item.innerHTML = `
                        <div class="font-semibold">${alert.item_name}</div>
                        <div class="text-sm">Nivel actual: ${alert.current_level_pct}%</div>
                        <div class="text-sm">Severidad: <span class="font-medium">${alert.severity}</span></div>
                        <button onclick="handleRestockRequest(this)" 
                            class="mt-2 w-full py-1.5 px-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors flex justify-center items-center shadow-sm">
                            Solicitar Reposici√≥n
                        </button>
                    `;
                    list.appendChild(item);
                });
                panel.appendChild(list);
            } else {
                panel.innerHTML += '<p class="text-gray-500">No hay alertas disponibles.</p>';
            }
        }
        // CAMBIO 3: Funci√≥n que maneja la animaci√≥n del bot√≥n (Loading -> Success)
        function handleRestockRequest(btn) {
            // Estado 1: Loading
            btn.disabled = true;
            btn.className = "mt-2 w-full py-1.5 px-3 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded cursor-not-allowed flex justify-center items-center";
            btn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg> Procesando...`;

            // Estado 2: Simulaci√≥n de √©xito (1.5 segundos despu√©s)
            setTimeout(() => {
                btn.className = "mt-2 w-full py-1.5 px-3 text-sm font-medium text-white bg-green-600 border border-green-600 rounded cursor-default flex justify-center items-center";
                btn.innerHTML = `‚úÖ Solicitado`;
            }, 1500);
        }
        // Llamar a las funciones al cargar la p√°gina
        window.onload = () => {
            fetchParetoData();
            fetchAlertsData();

            // CAMBIO 4: Auto-refresco cada 5 minutos (300,000 ms)
            setInterval(() => {
                console.log("‚ôªÔ∏è Actualizando inventario...");
                fetchParetoData();
                fetchAlertsData();
             }, 300000);

         };
    </script>
</body>
</html>