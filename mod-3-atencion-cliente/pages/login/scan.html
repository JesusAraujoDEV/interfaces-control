<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Charlotte - Escaneando Mesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#1B5E20',
                            light: '#4CAF50',
                            input: '#F3F4F6',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes loading {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        .animate-progress {
            animation: loading 2s ease-in-out infinite;
        }
        /* Evitar rebote en iOS */
        body {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen w-full text-gray-900">

    <div class="flex flex-col md:flex-row min-h-screen w-full">

        <div class="relative h-[40vh] md:h-auto w-full md:w-1/2 lg:w-3/5 transition-all duration-500 shrink-0">
            <img src="https://images.unsplash.com/photo-1554118811-1e0d58224f24?auto=format&fit=crop&q=80&w=1600" 
                 alt="Ambiente del restaurante" 
                 class="w-full h-full object-cover brightness-75 md:brightness-90">
            
            <div class="hidden md:flex absolute inset-0 bg-gradient-to-r from-black/50 to-transparent items-center px-12">
                <div class="text-white max-w-lg">
                    <h2 class="text-4xl font-bold mb-4">Bienvenido a Charlotte</h2>
                    <p class="text-lg opacity-90">Escanea, ordena y disfruta sin esperas.</p>
                </div>
            </div>
        </div>

        <div class="relative w-full md:static md:h-screen md:w-1/2 lg:w-2/5 
                    bg-white 
                    -mt-10 md:mt-0 
                    rounded-t-[30px] md:rounded-none 
                    shadow-[0_-10px_40px_rgba(0,0,0,0.1)] md:shadow-none
                    flex flex-col items-center 
                    z-10 
                    min-h-[60vh] md:min-h-0">
            
            <div class="w-full h-full flex flex-col items-center px-8 pt-16 pb-8 md:justify-center md:pt-0">

                <div class="absolute -top-0.5 left-1/2 transform -translate-x-1/2 
                            bg-white px-8 py-3 rounded-full shadow-lg border border-gray-100 z-20">
                    <span id="display-table-number" class="font-bold text-gray-900 text-lg tracking-wide whitespace-nowrap">
                        Detectando...
                    </span>
                </div>

                <div class="w-full max-w-md flex flex-col justify-start md:justify-center h-full">

                    <div id="view-loading" class="w-full flex flex-col items-center justify-center gap-8 py-4 transition-opacity duration-300">
                        <div class="text-center w-full mt-4">
                            <h1 id="loading-status" class="text-2xl font-bold text-gray-900 mb-6">Verificando mesa...</h1>
                            
                            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-2 relative">
                                <div id="progress-bar" class="h-full bg-brand-dark rounded-full w-1/3 transition-all duration-300"></div>
                            </div>
                            <p id="loading-subtext" class="text-sm text-gray-400 mt-2">Obteniendo ubicaci√≥n...</p>
                        </div>

                        <div class="w-32 h-32 flex items-center justify-center opacity-80">
                            <img src="/mod-3-atencion-cliente/images/Charlotte-sweet-and-coffee-en-maracay.png" 
                                 alt="Charlotte Logo" 
                                 class="w-full h-full object-contain">
                        </div>
                    </div>

                    <div id="view-login" class="w-full flex flex-col hidden opacity-0 transition-opacity duration-500">
                        
                        <div class="text-center mb-6">
                            <h1 id="login-title" class="text-2xl font-bold text-gray-900">Bienvenido</h1>
                            <p id="login-subtitle" class="text-gray-500 text-sm mt-1">Ingresa tus datos para comenzar</p>
                        </div>

                        <div id="table-status-card" class="mb-6 rounded-xl border p-4 flex flex-row items-center justify-between gap-3 transition-colors duration-300 hidden">
                            </div>

                        <form id="login-form" class="flex flex-col gap-4 w-full pb-6" novalidate>
                            <input type="hidden" id="final-table-id" name="table_id">
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1 ml-1">Nombre</label>
                                    <input type="text" id="guest-name" 
                                           class="w-full bg-brand-input px-4 py-3.5 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-dark transition-all"
                                           placeholder="Ej: Juan P√©rez" autocomplete="name">
                                    <p id="error-name" class="text-red-500 text-xs mt-1 ml-1 hidden flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span>Ingresa un nombre v√°lido (m√≠n. 3 letras)</span>
                                    </p>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1 ml-1">C√©dula</label>
                                    <input type="tel" id="guest-cedula" inputmode="numeric" maxlength="10"
                                           class="w-full bg-brand-input px-4 py-3.5 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-dark transition-all"
                                           placeholder="Ej: 31000543">
                                    <p id="error-cedula" class="text-red-500 text-xs mt-1 ml-1 hidden flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span>Solo n√∫meros (entre 6 y 10 d√≠gitos)</span>
                                    </p>
                                </div>
                            </div>

                            <button type="submit" 
                                    class="w-full bg-brand-dark text-white font-bold py-4 rounded-xl mt-4 shadow-lg hover:bg-green-800 active:scale-[0.98] transition-all transform">
                                Comenzar a Ordenar
                            </button>
                        </form>
                    </div>

                    <div id="view-error" class="hidden w-full flex flex-col items-center text-center justify-center py-10">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Acceso Denegado</h2>
                        <p id="error-message" class="text-gray-500 text-sm mt-2 px-4">No pudimos verificar tu ubicaci√≥n.</p>
                        <button onclick="window.location.reload()" class="mt-6 px-6 py-2 bg-gray-100 rounded-lg text-brand-dark font-semibold text-sm hover:bg-gray-200 transition-colors">
                            Intentar de nuevo
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="/config.js"></script> 
    <script src="/mod-3-atencion-cliente/api/base.js"></script>
    <script src="/mod-3-atencion-cliente/api/auth.js"></script>
    <script src="/mod-3-atencion-cliente/api/tables.js"></script>
    <script src="/mod-3-atencion-cliente/api/client.js"></script>
    
    <script>
        // Elementos del DOM
        const viewLoading = document.getElementById('view-loading');
        const viewLogin = document.getElementById('view-login');
        const viewError = document.getElementById('view-error');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('loading-status');
        const subStatusText = document.getElementById('loading-subtext');
        const tableIndicator = document.getElementById('display-table-number');
        
        // Elementos Formulario
        const form = document.getElementById('login-form');
        const nameInput = document.getElementById('guest-name');
        const cedulaInput = document.getElementById('guest-cedula');
        const errorName = document.getElementById('error-name');
        const errorCedula = document.getElementById('error-cedula');
        
        // Elementos Estado Mesa
        const tableStatusCard = document.getElementById('table-status-card');
        const loginTitle = document.getElementById('login-title');
        const loginSubtitle = document.getElementById('login-subtitle');

        function getQRParam() {
            const params = new URLSearchParams(window.location.search);
            return params.get('qr_uuid');
        }

        // === 1. UTILIDADES DE VALIDACI√ìN ===
        function validateInputs() {
            let isValid = true;
            
            // Validar Nombre (M√≠nimo 3 caracteres)
            if (nameInput.value.trim().length < 3) {
                errorName.classList.remove('hidden');
                nameInput.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                isValid = false;
            } else {
                errorName.classList.add('hidden');
                nameInput.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
            }

            // Regex: Acepta V, E, J, P (opcional), gui√≥n (opcional) y 6-8 d√≠gitos.
            const cedulaValue = cedulaInput.value.trim();
            const cedulaRegex = /^(?:[VEJP]-?)?\d{6,8}$/i;
            if (!cedulaRegex.test(cedulaValue)) {
                // Mostramos el error
                errorCedula.classList.remove('hidden');
                // Opcional: Actualiza el texto del error si es necesario para guiar al usuario
                errorCedula.textContent = "Formato inv√°lido. Ej: V-12345678, J-123456 o 12345678"; 
                
                cedulaInput.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                isValid = false;
            } else {
                // Ocultamos el error
                errorCedula.classList.add('hidden');
                cedulaInput.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
            }

            return isValid;
        }

        // Limpiar errores al escribir
        nameInput.addEventListener('input', () => {
            errorName.classList.add('hidden');
            nameInput.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
        });
        
        // Permitir solo n√∫meros en el input de c√©dula (UX Extra)
        cedulaInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            errorCedula.classList.add('hidden');
            cedulaInput.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
        });


        // === 2. GEOLOCALIZACI√ìN BLINDADA (Soluci√≥n definitiva) ===
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                
                // Esta bandera evita que se responda dos veces (el bug que tienes)
                let hasFinished = false;

                // Funci√≥n de √©xito (solo se ejecuta si no ha terminado)
                const onSuccess = (position) => {
                    if (hasFinished) return; 
                    hasFinished = true;
                    
                    console.log("‚úÖ Ubicaci√≥n final aceptada:", position.coords);
                    resolve({ 
                        latitude: position.coords.latitude, 
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    });
                };

                // Funci√≥n de error (con espera de seguridad)
                const onError = (error) => {
                    if (hasFinished) return;
                    
                    // TRUCO: Si el error es "User denied" (Code 1), esperamos 500ms
                    // porque a veces el √©xito llega justo despu√©s si hay conflicto de scripts.
                    if (error.code === 1) {
                        setTimeout(() => {
                            if (!hasFinished) { // Si despu√©s de esperar aun no hay √©xito, entonces s√≠ fallamos
                                hasFinished = true;
                                reject(new Error("‚õî Acceso denegado. Haz clic en el candado üîí de la barra de direcci√≥n y selecciona 'Permitir'."));
                            }
                        }, 500);
                    } else {
                        hasFinished = true;
                        // Mapeo de otros errores
                        if (error.code === 2) reject(new Error("üì° Se√±al GPS d√©bil. Intenta moverte a un lugar abierto."));
                        else if (error.code === 3) reject(new Error("‚åõ Tiempo de espera agotado."));
                        else reject(error);
                    }
                };

                if (!navigator.geolocation) {
                    reject(new Error("Navegador no compatible."));
                    return;
                }

                console.log("üìç Iniciando petici√≥n GPS...");
                
                navigator.geolocation.getCurrentPosition(
                    onSuccess,
                    onError,
                    { 
                        enableHighAccuracy: true, 
                        timeout: 15000, 
                        maximumAge: 0 
                    }
                );
            });
        }

        // === 3. FLUJO PRINCIPAL ===
        async function initScanProcess() {
            const qrUuid = getQRParam();
            
            if (!qrUuid) {
                showError("No se detect√≥ ning√∫n c√≥digo QR.");
                return;
            }

            try {
                // --- PASO A: Verificar QR ---
                updateProgress(30, "Verificando c√≥digo QR...");
                
                const qrData = await window.TablesApi.verify_qr(qrUuid);

                console.log("Datos QR verificados:", qrData);

                if (qrData.error) {
                    throw new Error(qrData.error);
                }

                if (!qrData || !qrData.table_id) {
                    throw new Error("Datos de mesa inv√°lidos");
                }

                // --- NUEVO: Guardar el QR para usarlo al final del flujo ---
                localStorage.setItem('current_qr_uuid', qrUuid);

                // Actualizar UI b√°sica
                tableIndicator.innerText = `Mesa ${qrData.table_number}`;
                document.getElementById('final-table-id').value = qrData.table_id;

                // --- RENDERIZAR ESTADO MESA ---
                const tableInfo = await window.TablesApi.getById(qrData.table_id);
                if (!tableInfo) throw new Error("Info de mesa no disponible");

                renderTableStatus(tableInfo);

                // --- PASO B: Verificar Ubicaci√≥n ---
                updateProgress(60, "Verificando ubicaci√≥n...");
                const coords = await getUserLocation();
                console.log("Coordenadas obtenidas:", coords);
                const locData = await window.AuthApi.verify_location(coords.latitude, coords.longitude);
                console.log("Datos de ubicaci√≥n verificados:", locData);

                if (!locData.is_inside) {
                    throw new Error("Debes estar dentro del restaurante para ordenar.");
                }
                
                if (locData.locationToken) localStorage.setItem('location_token', locData.locationToken);

                // --- PASO C: √âXITO ---
                updateProgress(100, "¬°Verificaci√≥n exitosa!");
                
                setTimeout(() => {
                    transitionToLogin();
                }, 800);

            } catch (error) {
                console.error("‚ùå Error detectado:", error);
                
                let msg = "Ocurri√≥ un error inesperado.";
                
                // Error Code 1 = PERMISSION_DENIED
                if (error.code === 1) {
                    msg = "‚ö†Ô∏è Acceso a ubicaci√≥n denegado.\n\nPara verificar que est√°s en el restaurante, necesitamos saber tu ubicaci√≥n. Por favor, habilita los permisos en tu navegador (√≠cono del candado en la barra superior) y recarga la p√°gina.";
                } 
                // Error Code 2 = POSITION_UNAVAILABLE
                else if (error.code === 2) {
                    msg = "‚ö†Ô∏è No pudimos detectar tu ubicaci√≥n. Aseg√∫rate de tener el GPS encendido.";
                }
                // Error Code 3 = TIMEOUT
                else if (error.code === 3) {
                    msg = "‚ö†Ô∏è Se agot√≥ el tiempo esperando la ubicaci√≥n. Int√©ntalo de nuevo.";
                }
                // Errores lanzados por nosotros (throw new Error)
                else if (error.message) {
                    msg = error.message;
                }
                
                showError(msg);
            }
        }

        // === 4. RENDERIZADO VISUAL ===
        function renderTableStatus(data) {
            const { capacity, active_sessions } = data;
            const occupiedCount = active_sessions || 0;
            const maxCapacity = capacity || 4;
            const percentage = (occupiedCount / maxCapacity) * 100;
            const isNewSession = occupiedCount === 0;

            let colorStyles, statusIcon, statusTitle, statusDesc;

            if (isNewSession) {
                colorStyles = "bg-green-50 border-green-200 text-green-800";
                statusIcon = `<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>`;
                statusTitle = "Mesa Libre";
                statusDesc = "Est√°s abriendo una nueva cuenta.";
                loginTitle.innerText = "Nueva Orden";
                loginSubtitle.innerText = "S√© el primero en ordenar en esta mesa.";
            } else {
                if (percentage >= 100) {
                    colorStyles = "bg-red-50 border-red-200 text-red-800";
                    statusIcon = `<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
                    statusDesc = `La mesa est√° llena (${occupiedCount}/${maxCapacity}).`;
                } else {
                    colorStyles = "bg-blue-50 border-blue-200 text-blue-800";
                    statusIcon = `<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
                    statusDesc = `Te unes a ${occupiedCount} persona(s).`;
                }
                statusTitle = "Uni√©ndote a la sesi√≥n";
                loginTitle.innerText = "Unirse a la Mesa";
                loginSubtitle.innerText = `Comparte la cuenta con los dem√°s comensales.`;
            }

            tableStatusCard.className = `mb-6 rounded-xl border p-4 flex items-center justify-between gap-4 transition-colors duration-300 ${colorStyles}`;
            tableStatusCard.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-white rounded-full shadow-sm">
                        ${statusIcon}
                    </div>
                    <div>
                        <h3 class="font-bold text-sm">${statusTitle}</h3>
                        <p class="text-xs opacity-90">${statusDesc}</p>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Ocupaci√≥n</span>
                    <span class="text-xl font-bold">${occupiedCount}<span class="text-sm opacity-60">/${maxCapacity}</span></span>
                </div>
            `;
            tableStatusCard.classList.remove('hidden');
        }

        function updateProgress(percent, text) {
            progressBar.style.width = `${percent}%`;
            if (percent < 100) progressBar.classList.add('animate-pulse');
            else progressBar.classList.remove('animate-pulse');
            if(text) subStatusText.innerText = text;
        }

        function transitionToLogin() {
            viewLoading.classList.add('hidden');
            viewLogin.classList.remove('hidden');
            setTimeout(() => {
                viewLogin.classList.remove('opacity-0');
            }, 50);
        }

        function showError(message) {
            viewLoading.classList.add('hidden');
            viewLogin.classList.add('hidden');
            viewError.classList.remove('hidden');
            document.getElementById('error-message').innerText = message;
        }

        // === 5. LOGIN SUBMIT CON VALIDACI√ìN ===
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validateInputs()) {
                // Si la validaci√≥n falla, detenemos todo aqu√≠
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;
            const tableIdInput = document.getElementById('final-table-id');

            const payload = {
                table_id: parseInt(tableIdInput.value),
                customer_name: nameInput.value.trim(),
                customer_dni: cedulaInput.value.trim()
            };

            // UI de Carga
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Ingresando...
            `;
            submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                console.log("Enviando login validado:", payload);
                const response = await window.ClientApi.login(payload);
                console.log("Respuesta login:", response);
                if (response.session_token) {
                    localStorage.setItem('access_token', response.session_token);
                    if (response.client) localStorage.setItem('user_client', JSON.stringify(response.client));
                    alert("¬°Bienvenido a Charlotte! Puedes comenzar a ordenar.");
                    window.location.href = '/mod-3-atencion-cliente/pages/pedidos/menu.html'; 
                } else {
                    throw new Error("Token inv√°lido.");
                }

            } catch (error) {
                console.error("Error login:", error);
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                alert(`Error: ${error.message}`);
            }
        });

        // INICIAR
        document.addEventListener('DOMContentLoaded', initScanProcess);

    </script>
</body>
</html>