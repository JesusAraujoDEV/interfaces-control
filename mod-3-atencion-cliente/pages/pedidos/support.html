<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayuda y Servicio - Charlotte's Restaurant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#357854',
                        secondary: '#f6faf7',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-[#f2f7f1] font-sans min-h-screen flex flex-col overflow-y-scroll">

    <header class="md:hidden p-4 text-center bg-white sticky top-0 z-20 shadow-sm">
        <h1 class="text-xl font-bold text-gray-900">Ayuda y Servicio</h1>
    </header>

    <header class="hidden md:block bg-[#f2f7f1] border-b border-[#e6efe4] sticky top-0 z-30">
        <div class="container mx-auto max-w-6xl px-4 h-20 flex items-center justify-between">
            <div id="brand-container" class="hidden md:flex items-center gap-3 w-[280px] shrink-0"></div>
            <div id="desktop-nav-container" class="hidden md:flex gap-6 items-center"></div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-6xl px-4 py-6 pb-24 md:pb-10 flex flex-col md:flex-row gap-8 items-start justify-center">
        
        <div class="w-full max-w-md bg-white md:border md:border-gray-100 md:shadow-lg md:rounded-3xl p-6 md:p-10 flex flex-col items-center text-center transition-all mx-auto md:mx-0">
            
            <div class="bg-orange-50 rounded-full p-8 mb-8 w-40 h-40 flex items-center justify-center relative group cursor-pointer">
                <div class="absolute inset-0 bg-orange-100 rounded-full animate-ping opacity-20 group-hover:opacity-40"></div>
                <span class="material-icons-outlined text-6xl text-orange-500">room_service</span>
            </div>

            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-3">¬øC√≥mo podemos ayudarte?</h2>
            
            <p class="text-gray-500 text-sm md:text-base leading-relaxed mb-8 max-w-xs mx-auto">
                Nuestro equipo est√° listo para asistirte. Ya sea que necesites un refill, servilletas, o tengas una pregunta sobre el men√∫.
            </p>

            <div class="w-full space-y-4">
                <button id="callWaiterBtn" onclick="callWaiter()" class="w-full bg-primary hover:bg-green-800 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">notifications_active</span>
                    Llamar al Mesero
                </button>

                <button onclick="openReport()" class="w-full bg-gray-50 hover:bg-gray-100 text-gray-900 font-semibold py-4 rounded-xl border border-gray-200 transition flex items-center justify-center gap-2">
                    <span class="material-icons-outlined text-gray-500">report_problem</span>
                    Reportar un Problema
                </button>
            </div>
        </div>

        <div class="w-full max-w-md mx-auto md:mx-0">
            <h3 class="text-lg font-bold text-gray-900 mb-4 px-2">Solicitudes Recientes</h3>
            
            <div id="requestsList" class="space-y-3">
                <div class="text-center py-10 text-gray-400 bg-white rounded-2xl border border-gray-100">
                    <span class="material-icons-outlined text-4xl mb-2 opacity-50">history</span>
                    <p class="text-sm">No hay solicitudes activas a√∫n.</p>
                </div>
            </div>
        </div>

    </main>

    <div id="reportOverlay" class="fixed inset-0 bg-gray-50 z-50 overflow-y-auto hidden flex-col animate-fade-in">
        <div class="bg-white p-4 sticky top-0 z-10 flex items-center shadow-sm">
            <button onclick="closeReport()" class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full transition">
                <span class="material-icons-outlined text-2xl">arrow_back</span>
            </button>
            <h1 class="text-xl font-bold text-gray-900 ml-2">Reportar un Problema</h1>
        </div>
        <div class="flex-grow p-6 max-w-md mx-auto w-full">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Selecciona un Problema</h2>
            <div class="grid grid-cols-2 gap-3 mb-8" id="issueGrid">
                <button onclick="selectChip(this)" class="issue-chip py-3 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium bg-white hover:bg-gray-50 transition text-sm" data-issue="Food Quality">Calidad de la Comida</button>
                <button onclick="selectChip(this)" class="issue-chip py-3 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium bg-white hover:bg-gray-50 transition text-sm" data-issue="Cleanliness">Limpieza</button>
                <button onclick="selectChip(this)" class="issue-chip py-3 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium bg-white hover:bg-gray-50 transition text-sm" data-issue="Utensils">Utensilios</button>
                <button onclick="selectChip(this)" class="issue-chip py-3 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium bg-white hover:bg-gray-50 transition text-sm" data-issue="Other">Otro</button>
            </div>
            <form onsubmit="submitReport(event)" class="space-y-6">
                <input type="hidden" id="selectedIssue" value="">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Detalles</label>
                    <textarea id="issueDetails" class="w-full h-40 p-4 bg-white rounded-2xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-green-100 outline-none resize-none transition text-gray-700 placeholder-gray-400" placeholder="Por favor describe el problema..." required></textarea>
                </div>
                <button type="submit" id="submitReportBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">send</span>
                    Enviar Reporte
                </button>
            </form>
        </div>
    </div>

    <div id="toast" class="pointer-events-none fixed bottom-24 md:bottom-8 left-4 right-4 md:left-auto md:right-8 md:w-80 bg-gray-900 text-white px-4 py-3 rounded-xl shadow-xl z-[60] transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3">
        <span class="material-icons-outlined text-green-400">check_circle</span>
        <span id="toast-message" class="flex-1 text-sm font-medium">Notificaci√≥n</span>
    </div>

    <nav id="mobile-nav-container"></nav>
    <script src="/config.js"></script>
    <script src="/mod-3-atencion-cliente/api/base.js"></script>
    <script src="/mod-3-atencion-cliente/api/client.js"></script>
    <script src="/mod-3-atencion-cliente/components/navbar.js"></script>

    <script>
        // --- GESTI√ìN DE SONIDO ---
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) { console.log('Audio silent'); }
        }

        // --- GESTI√ìN DE TOAST ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const icon = toast.querySelector('.material-icons-outlined');
            msgEl.textContent = message;
            icon.textContent = type === 'success' ? 'check_circle' : 'error';
            icon.className = `material-icons-outlined ${type === 'success' ? 'text-green-400' : 'text-red-400'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        }

        // --- GESTI√ìN DEL HISTORIAL (NUEVO) ---
        
        // 1. Guardar ID en localStorage
        function saveRequestIdLocally(id) {
            let requests = JSON.parse(localStorage.getItem('my_service_requests') || '[]');
            // Agregamos al principio
            requests.unshift(id);
            // Limitamos a los √∫ltimos 10 para no saturar
            requests = requests.slice(0, 10);
            localStorage.setItem('my_service_requests', JSON.stringify(requests));
            // Recargamos la lista
            loadRequestHistory();
        }

        // 2. Renderizar un Item del historial
        function renderRequestItem(request) {
            const isPending = request.status === 'PENDING';
            const isCancelled = request.status === 'CANCELLED';
            const isAttended = request.status === 'ATTENDED' || request.status === 'COMPLETED';

            let statusColor = isPending ? 'text-yellow-600 bg-yellow-50 border-yellow-100' : 
                              isCancelled ? 'text-gray-500 bg-gray-100 border-gray-200' : 
                              'text-green-600 bg-green-50 border-green-100';
            
            let icon = request.type === 'CALL_WAITER' ? 'notifications' : 'report_problem';
            
            // Formatear hora
            const time = new Date(request.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            return `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-start justify-between transition hover:shadow-md">
                    <div class="flex items-start gap-3">
                        <div class="p-2 rounded-full ${isPending ? 'bg-orange-50 text-orange-500' : 'bg-gray-50 text-gray-400'}">
                            <span class="material-icons-outlined text-xl">${icon}</span>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-900">${request.type === 'CALL_WAITER' ? 'Waiter Call' : 'Issue Report'}</p>
                            <p class="text-xs text-gray-500 mt-1 line-clamp-1">${request.message}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-md border ${statusColor}">
                                    ${request.status}
                                </span>
                                <span class="text-[10px] text-gray-400">${time}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${isPending ? `
                        <button onclick="cancelRequest('${request.id}')" class="text-xs font-medium text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded transition">
                            Cancelar
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // 3. Cargar historial desde API basado en localStorage
        async function loadRequestHistory() {
            const listContainer = document.getElementById('requestsList');
            const requestIds = JSON.parse(localStorage.getItem('my_service_requests') || '[]');

            if (requestIds.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-400 bg-white rounded-2xl border border-gray-100">
                        <span class="material-icons-outlined text-4xl mb-2 opacity-50">history</span>
                        <p class="text-sm">No hay solicitudes activas a√∫n.</p>
                    </div>`;
                return;
            }

            // Spinner simple mientras carga
            // listContainer.innerHTML = '<div class="text-center py-4 text-gray-400">Loading history...</div>';

            let htmlContent = '';
            
            // Iteramos sobre los IDs guardados
            for (const id of requestIds) {
                try {
                    const response = await window.ClientApi.getServiceRequest(id);
                    if (response.success && response.data) {
                        htmlContent += renderRequestItem(response.data);
                    }
                } catch (error) {
                    console.error(`Could not load request ${id}`, error);
                    // Si falla (ej. ID viejo borrado de DB), podr√≠amos optar por no mostrarlo
                }
            }

            if (htmlContent) {
                listContainer.innerHTML = htmlContent;
            }
        }

        // 4. Funci√≥n para cancelar
        async function cancelRequest(id) {
            if(!confirm("¬øEst√°s seguro de que deseas cancelar esta solicitud?")) return;

            try {
                await window.ClientApi.cancelServiceRequest(id);
                showToast("Solicitud cancelada", "success");
                loadRequestHistory(); // Recargar lista
            } catch (error) {
                console.error(error);
                showToast("Error al cancelar la solicitud", "error");
            }
        }

        // --- ACCIONES PRINCIPALES ---

        async function callWaiter() {
            const btn = document.getElementById('callWaiterBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<span class="material-icons-outlined animate-spin">refresh</span> Llamando...`;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                
                const response = await window.ClientApi.sendServiceRequest("CALL_WAITER", "Customer needs assistance.");
                
                // GUARDAR ID EN HISTORIAL
                if(response.data && response.data.id) {
                    saveRequestIdLocally(response.data.id);
                }

                showToast('‚úÖ ¬°Camarero notificado!', 'success');
                playNotificationSound();
                
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                }, 2000);
            }
        }

        async function submitReport(e) {
            e.preventDefault();
            const details = document.getElementById('issueDetails').value.trim();
            const submitBtn = document.getElementById('submitReportBtn');
            const originalText = submitBtn.innerHTML;
            
            if (!selectedIssue || !details) return;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<span class="material-icons-outlined animate-spin">refresh</span> Enviando...`;
                
                const fullMessage = `[${selectedIssue}] ${details}`;
                const response = await window.ClientApi.sendServiceRequest("COMPLAINT", fullMessage);
                
                // GUARDAR ID EN HISTORIAL
                if(response.data && response.data.id) {
                    saveRequestIdLocally(response.data.id);
                }

                closeReport();
                setTimeout(() => {
                    showToast('üì§ Reporte enviado con √©xito.', 'success');
                    playNotificationSound();
                }, 300);
                
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // --- INICIALIZACI√ìN ---
        const reportOverlay = document.getElementById('reportOverlay');
        let selectedIssue = '';
        
        function openReport() {
            document.getElementById('issueDetails').value = '';
            selectedIssue = '';
            document.getElementById('selectedIssue').value = '';
            document.querySelectorAll('.issue-chip').forEach(c => c.classList.remove('border-primary', 'text-primary', 'bg-green-50', 'font-bold'));
            reportOverlay.classList.remove('hidden');
            reportOverlay.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }
        
        function closeReport() {
            reportOverlay.classList.add('hidden');
            reportOverlay.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }
        
        function selectChip(btn) {
            document.querySelectorAll('.issue-chip').forEach(chip => {
                chip.className = "issue-chip py-3 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium bg-white hover:bg-gray-50 transition text-sm";
            });
            btn.className = "issue-chip py-3 px-4 rounded-xl border-2 border-primary text-primary font-bold bg-green-50 transition text-sm";
            selectedIssue = btn.getAttribute('data-issue');
        }

        // Cargar historial al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            loadRequestHistory();
            
            // Polling: Actualizar estado cada 10 segundos
            setInterval(loadRequestHistory, 10000);
        });

    </script>

    <style>
        html { scrollbar-gutter: stable; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</body>
</html>