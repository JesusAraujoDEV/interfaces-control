<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlotte - Men√∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#357854',
                        primaryDark: '#13532a',
                        cream: '#f2f7f1'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Ocultar scrollbar pero permitir funcionalidad */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Barra de categor√≠as tipo p√≠ldora */
        .tab-btn { 
            display: inline-flex; 
            align-items: center; 
            padding: 0.5rem 1rem; 
            border-radius: 9999px; 
            border: 1px solid #e5e7eb; 
            background: #ffffff; 
            color: #374151; 
            font-weight: 700; 
            font-size: 0.875rem; 
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; 
            white-space: nowrap; 
        }
        .tab-btn:hover { background: #f9fafb; }
        .tab-btn.active { 
            background: #13532a; 
            color: #ffffff; 
            border-color: transparent; 
        }

        /* Skeleton loading */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>
<body class="bg-cream text-gray-800 font-sans min-h-screen flex flex-col overflow-y-scroll">

    <!-- ============ HEADER MOBILE ============ -->
    <header class="md:hidden bg-white sticky top-0 z-20 shadow-sm">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div id="brand-container-mobile" class="flex items-center gap-3"></div>
            <div class="w-8"></div>
        </div>
    </header>

    <!-- ============ HEADER DESKTOP ============ -->
    <header class="hidden md:block bg-[#f2f7f1] border-b border-[#e6efe4] sticky top-0 z-30">
        <div class="container mx-auto max-w-6xl px-4 h-20 flex items-center justify-between">
            <div id="brand-container" class="hidden md:flex items-center gap-3 w-[280px] shrink-0"></div>
            <div id="desktop-nav-container" class="hidden md:flex gap-6 items-center"></div>
        </div>
    </header>

    <!-- ============ MAIN CONTENT ============ -->
    <main class="flex-grow container mx-auto max-w-6xl px-4 py-6 pb-24 md:pb-8">
        <!-- Barra de b√∫squeda -->
        <div class="relative max-w-2xl mx-auto mb-6 group">
            <span class="material-icons-outlined absolute left-4 top-3 text-gray-400 group-focus-within:text-primary transition-colors">search</span>
            <input type="text"
                id="search-input"
                placeholder="Buscar platos o bebidas..."
                class="w-full bg-white rounded-xl py-3 pl-11 pr-4 text-sm font-medium text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20 border border-gray-300 focus:border-primary/30 shadow-sm transition-all">
        </div>

        <!-- Barra de Categor√≠as -->
        <div class="mt-2">
            <h2 class="text-sm font-semibold text-gray-700 mb-2">Categor√≠as</h2>
            <nav id="category-tabs" class="flex gap-3 overflow-x-auto no-scrollbar justify-start md:justify-start py-2">
                <!-- Se cargan din√°micamente -->
                <div class="skeleton h-8 w-20 rounded-full mb-1"></div>
                <div class="skeleton h-8 w-24 rounded-full mb-1"></div>
                <div class="skeleton h-8 w-28 rounded-full mb-1"></div>
            </nav>
        </div>
        
        <!-- Grid de Productos -->
        <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Skeleton inicial -->
            <div class="skeleton h-36 rounded-2xl"></div>
            <div class="skeleton h-36 rounded-2xl"></div>
            <div class="skeleton h-36 rounded-2xl"></div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
            <span class="material-icons-outlined text-6xl text-gray-300 mb-4">search_off</span>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No se encontraron resultados</h3>
            <p class="text-sm text-gray-500">Intenta con otra b√∫squeda o categor√≠a</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-16">
            <span class="material-icons-outlined text-6xl text-red-300 mb-4">error_outline</span>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Error al cargar el men√∫</h3>
            <p id="error-message" class="text-sm text-gray-500 mb-4">No pudimos conectar con el servidor</p>
            <button onclick="loadMenuData()" class="bg-primary text-white px-6 py-2 rounded-xl font-medium hover:bg-green-800 transition-colors">
                Reintentar
            </button>
        </div>

    </main>

    <!-- Modal de ingredientes (solo lectura) -->
    <div id="ingredientsModal" class="fixed inset-0 z-50 hidden" aria-labelledby="ingredients-modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeIngredientsModal()"></div>
        <div class="fixed inset-x-0 bottom-0 md:inset-auto md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[520px] bg-white md:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden animate-slide-up z-50">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center">
                        <span class="material-icons-outlined text-xl text-primary">list_alt</span>
                    </div>
                    <div>
                        <h2 id="ingredients-modal-title" class="text-lg font-bold text-gray-900">Ingredientes</h2>
                        <p class="text-xs text-gray-500">Informaci√≥n de ingredientes por plato (solo lectura).</p>
                    </div>
                </div>
                <div id="ingredients-modal-list" class="mt-4 max-h-[360px] overflow-y-auto no-scrollbar"></div>
                <div class="mt-6">
                    <button onclick="closeIngredientsModal()" class="w-full bg-white text-gray-700 font-bold py-3 rounded-xl border border-gray-200 transition flex items-center justify-center gap-2">
                        <span class="material-icons-outlined text-sm">close</span> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ TOAST NOTIFICATION ============ -->
    <div id="toast" class="pointer-events-none fixed bottom-24 md:bottom-8 left-4 right-4 md:left-auto md:right-8 md:w-80 bg-gray-900 text-white px-4 py-3 rounded-xl shadow-xl z-40 transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3">
        <span class="material-icons-outlined text-green-400">check_circle</span>
        <span id="toast-message" class="flex-1 text-sm font-medium">Producto agregado al carrito</span>
    </div>

    <!-- ============ BOTTOM NAVIGATION (Mobile) ============ -->
    <nav id="mobile-nav-container"></nav>

    <!-- ============ SCRIPTS ============ -->
    <script src="/config.js"></script>
    <script src="/mod-3-atencion-cliente/components/navbar.js"></script>
    <script src="/mod-3-atencion-cliente/api/base.js"></script>
    <script src="/mod-3-atencion-cliente/api/client.js"></script>
    <script src="/mod-3-atencion-cliente/api/kitchen.js"></script>

    <script>
        // ============ ESTADO GLOBAL ============
        let allProducts = [];
        let allCategories = [];
        let selectedCategory = 'all';
        let cart = [];
        let recipeCache = {}; // cache por productId

        // ============ ELEMENTOS DOM ============
        const categoryTabs = document.getElementById('category-tabs');
        const menuGrid = document.getElementById('menu-grid');
        const emptyState = document.getElementById('empty-state');
        const errorState = document.getElementById('error-state');
        const searchInput = document.getElementById('search-input');

        // ============ INICIALIZACI√ìN ============
        document.addEventListener('DOMContentLoaded', async () => {
            loadCart();
            await loadMenuData();
            setupSearch();
        });

        // ============ CARRITO ============
        function loadCart() {
            try {
                const savedCart = localStorage.getItem('charlotte_cart');
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                    updateCartBadge();
                }
            } catch (e) {
                cart = [];
            }
        }

        function saveCart() {
            localStorage.setItem('charlotte_cart', JSON.stringify(cart));
            updateCartBadge();
        }

        function updateCartBadge() {
            try {
                if (window.Navbar && typeof window.Navbar.updateCartBadge === 'function') {
                    window.Navbar.updateCartBadge();
                }
            } catch (e) { /* noop */ }
        }

        function addToCart(productId) {
            const product = allProducts.find(p => getProductId(p) === productId);
            if (!product) return;

            const price = parseFloat(product.price || product.precio || product.basePrice || 0);
            const name = product.name || product.nombre || 'Producto';
            const image = product.imageUrl || product.image_url || product.image || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&q=80';
            const description = product.description || product.descripcion || '';

            // Verificar si ya existe en el carrito
            const existingIndex = cart.findIndex(item => item.productId === productId);

            if (existingIndex > -1) {
                cart[existingIndex].quantity += 1;
            } else {
                cart.push({
                    id: Date.now(),
                    productId: productId,
                    name: name,
                    price: price,
                    quantity: 1,
                    image: image,
                    description: description
                });
            }

            saveCart();
            showToast(`${name} agregado al carrito`);
        }

        // ============ CARGA DE DATOS ============
        async function loadMenuData() {
            showLoading();
            hideError();
            
            try {
                // Cargar categor√≠as y productos en paralelo
                const [categoriesRes, productsRes] = await Promise.all([
                    window.KitchenApi.getCategories(),
                    window.KitchenApi.getProducts()
                ]);

                console.log('üì¶ Categor√≠as:', categoriesRes);
                console.log('üì¶ Productos:', productsRes);

                // Procesar respuestas (ajustar seg√∫n estructura real del backend)
                allCategories = extractData(categoriesRes);
                allProducts = extractData(productsRes);

                renderCategories();
                renderProducts();

            } catch (error) {
                console.error('‚ùå Error cargando men√∫:', error);
                showError(error.message || 'No pudimos cargar el men√∫');
            }
        }

        function extractData(response) {
            if (Array.isArray(response)) return response;
            if (response.data) return Array.isArray(response.data) ? response.data : [];
            if (response.products) return response.products;
            if (response.categories) return response.categories;
            return [];
        }

        function showLoading() {
            menuGrid.innerHTML = `
                <div class="skeleton h-36 rounded-2xl"></div>
                <div class="skeleton h-36 rounded-2xl"></div>
                <div class="skeleton h-36 rounded-2xl"></div>
                <div class="skeleton h-36 rounded-2xl"></div>
                <div class="skeleton h-36 rounded-2xl"></div>
                <div class="skeleton h-36 rounded-2xl"></div>
            `;
            categoryTabs.innerHTML = `
                <div class="skeleton h-8 w-20 rounded mb-3"></div>
                <div class="skeleton h-8 w-24 rounded mb-3"></div>
                <div class="skeleton h-8 w-28 rounded mb-3"></div>
            `;
            menuGrid.classList.remove('hidden');
            emptyState.classList.add('hidden');
        }

        function showError(message) {
            menuGrid.classList.add('hidden');
            emptyState.classList.add('hidden');
            errorState.classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function hideError() {
            errorState.classList.add('hidden');
            menuGrid.classList.remove('hidden');
        }

        // ============ UTILIDADES PARA DATOS ============
        function getProductId(product) {
            return product.id || product._id || product.productId;
        }

        function getCategoryId(cat) {
            return cat.id || cat._id || cat.categoryId || cat.category_id;
        }

        function getCategoryName(cat) {
            return cat.name || cat.nombre || 'Categor√≠a';
        }

        function getProductCategoryId(product) {
            // Manejar diferentes estructuras posibles
            if (product.categoryId) return product.categoryId;
            if (product.category_id) return product.category_id;
            if (product.category && typeof product.category === 'object') {
                return product.category.id || product.category._id;
            }
            if (product.category && typeof product.category === 'number') {
                return product.category;
            }
            return null;
        }

        function getProductCategoryName(product) {
            // Si tiene categor√≠a embebida
            if (product.category && typeof product.category === 'object') {
                return product.category.name || product.category.nombre || '';
            }
            // Buscar por ID
            const catId = getProductCategoryId(product);
            if (catId) {
                const cat = allCategories.find(c => 
                    getCategoryId(c) === catId || String(getCategoryId(c)) === String(catId)
                );
                if (cat) return getCategoryName(cat);
            }
            return '';
        }

        // ============ RENDERIZADO ============
        function renderCategories() {
            let html = `
                <button onclick="filterMenu('all')" 
                        class="tab-btn ${selectedCategory === 'all' ? 'active' : ''}">
                    Todos
                </button>
            `;

            allCategories.forEach(cat => {
                const catId = getCategoryId(cat);
                const catName = getCategoryName(cat);
                const isActive = String(selectedCategory) === String(catId);
                
                html += `
                    <button onclick="filterMenu('${catId}')" 
                            class="tab-btn ${isActive ? 'active' : ''}">
                        ${escapeHtml(catName)}
                    </button>
                `;
            });

            categoryTabs.innerHTML = html;
        }

        function renderProducts() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Filtrar productos
            let filtered = allProducts.filter(product => {
                // Filtro por categor√≠a
                let matchesCategory = selectedCategory === 'all';
                if (!matchesCategory) {
                    const productCatId = getProductCategoryId(product);
                    matchesCategory = String(productCatId) === String(selectedCategory);
                }

                // Filtro por b√∫squeda
                const name = (product.name || product.nombre || '').toLowerCase();
                const desc = (product.description || product.descripcion || '').toLowerCase();
                const matchesSearch = searchTerm === '' || 
                    name.includes(searchTerm) || 
                    desc.includes(searchTerm);

                // Solo productos activos
                const isActive = product.isActive !== false && product.is_active !== false && product.active !== false;

                return matchesCategory && matchesSearch && isActive;
            });

            if (filtered.length === 0) {
                menuGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            menuGrid.classList.remove('hidden');
            menuGrid.innerHTML = filtered.map(product => renderProductCard(product)).join('');
        }

        function renderProductCard(product) {
            const id = getProductId(product);
            const name = product.name || product.nombre || 'Producto';
            const description = product.description || product.descripcion || '';
            const price = parseFloat(product.price || product.precio || product.basePrice || 0).toFixed(2);
            const image = product.imageUrl || product.image_url || product.image || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&q=80';
            const categoryName = getProductCategoryName(product);
            
            // Determinar si es popular o del chef (basado en alg√∫n campo si existe)
            const isPopular = product.isPopular || product.is_popular || product.popular;
            const isChefChoice = product.isChefChoice || product.is_chef_choice || product.chefChoice;
            
            let tagHtml = '';
            if (isPopular) {
                tagHtml = `<span class="inline-block bg-orange-50 text-orange-600 text-[10px] font-bold px-2 py-1 rounded-md tracking-wide uppercase">Popular</span>`;
            } else if (isChefChoice) {
                tagHtml = `<span class="inline-block bg-green-50 text-primary text-[10px] font-bold px-2 py-1 rounded-md tracking-wide uppercase">Chef's Choice</span>`;
            } else if (categoryName) {
                tagHtml = `<span class="inline-block bg-gray-50 text-gray-600 text-[10px] font-bold px-2 py-1 rounded-md tracking-wide uppercase">${escapeHtml(categoryName)}</span>`;
            }

            return `
                <article class="menu-item bg-white p-4 rounded-2xl shadow-md hover:shadow-lg transition-shadow border border-gray-100 flex gap-4 cursor-pointer" 
                         onclick="addToCart('${id}')">
                    <div class="flex-1 flex flex-col">
                        ${tagHtml ? `<div class="mb-2">${tagHtml}</div>` : '<div class="mb-2 h-6"></div>'}
                        <h3 class="font-bold text-gray-900 text-lg mb-1 leading-snug line-clamp-2 min-h-[40px]" title="${escapeHtml(name)}">${escapeHtml(name)}</h3>
                        <p class="text-xs text-gray-500 leading-relaxed line-clamp-2 mb-3">${escapeHtml(description)}</p>
                        <div class="mt-1">
                            <button class="text-[11px] font-bold uppercase tracking-wide text-primary hover:text-green-800 inline-flex items-center gap-1" onclick="event.stopPropagation(); openIngredientsModal('${id}')">
                                <span class="material-icons-outlined text-[14px]">list</span> Ver ingredientes
                            </button>
                        </div>
                        <div class="mt-auto">
                            <button class="inline-flex items-center gap-1 bg-gray-50 hover:bg-gray-100 text-gray-900 text-sm font-bold px-3 py-1.5 rounded-lg border border-gray-200 transition-colors">
                                $${price} <span class="material-icons-outlined text-[14px] text-primary">add</span>
                            </button>
                        </div>
                    </div>
                    <img src="${escapeHtml(image)}" 
                         alt="${escapeHtml(name)}"
                         class="w-32 h-32 object-cover rounded-xl bg-gray-100"
                         onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&q=80'">
                </article>
            `;
        }

        async function openIngredientsModal(productId) {
            const overlay = document.getElementById('ingredientsModal');
            const titleEl = document.getElementById('ingredients-modal-title');
            const listEl = document.getElementById('ingredients-modal-list');

            // T√≠tulo con nombre del producto
            const product = allProducts.find(p => String(getProductId(p)) === String(productId));
            const productName = product ? (product.name || product.nombre || 'Producto') : 'Producto';
            titleEl.textContent = `Ingredientes de: ${escapeHtml(productName)}`;

            // Mostrar overlay
            overlay.classList.remove('hidden');
            listEl.innerHTML = `<div class="text-xs text-gray-500 flex items-center gap-2"><span class="material-icons-outlined animate-spin text-[14px] text-gray-400">refresh</span> Cargando ingredientes...</div>`;

            try {
                if (!recipeCache[productId]) {
                    const res = await window.KitchenApi.getProductRecipe(productId);
                    const recipe = Array.isArray(res) ? res : (res?.data || []);
                    recipeCache[productId] = recipe;
                }
                listEl.innerHTML = renderIngredientsModalList(recipeCache[productId]);
            } catch (e) {
                console.error('Error cargando ingredientes:', e);
                listEl.innerHTML = `<div class="text-xs text-red-500">No se pudieron cargar los ingredientes. Intenta m√°s tarde.</div>`;
            }
        }

        function closeIngredientsModal() {
            const overlay = document.getElementById('ingredientsModal');
            overlay.classList.add('hidden');
        }

        function renderIngredientsModalList(recipe) {
            if (!Array.isArray(recipe) || recipe.length === 0) {
                return `<div class="text-xs text-gray-400">No hay ingredientes disponibles.</div>`;
            }
            const applicable = recipe.filter(r => {
                const scope = (r.scope || 'ALL').toUpperCase();
                return scope === 'ALL' || scope === 'DINE_IN';
            });
            if (applicable.length === 0) {
                return `<div class="text-xs text-gray-400">Ingredientes no aplicables a sala.</div>`;
            }
            return `
                <div class="space-y-1">
                    ${applicable.map(ing => `
                        <div class="flex items-center justify-between py-1 border-b border-gray-50 last:border-0">
                            <div class="text-sm text-gray-700">
                                <span class="font-medium">${escapeHtml(ing.ingredientName || 'Ingrediente')}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${ing.isMandatory ? `<span class="text-[9px] px-2 py-0.5 rounded bg-green-100 text-green-700 font-bold uppercase">Obligatorio</span>` : ''}
                                ${(ing.scope && ing.scope.toUpperCase() !== 'ALL') ? `<span class="text-[9px] px-2 py-0.5 rounded bg-gray-100 text-gray-600 font-bold uppercase">${escapeHtml(ing.scope)}</span>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============ FILTRADO ============
        function filterMenu(category) {
            selectedCategory = category;
            renderCategories();
            renderProducts();
        }

        function setupSearch() {
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    renderProducts();
                }, 300);
            });
        }

        // ============ TOAST ============
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // ============ UTILIDADES ============
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Exponer funciones globales
        window.filterMenu = filterMenu;
        window.addToCart = addToCart;
        window.loadMenuData = loadMenuData;
    </script>
</body>
</html>
