<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlotte Admin - Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f2f7f1', 700: '#13532a', 800: '#0f4a22' },
                        primary: '#205638',
                        secondary: '#4CAF50',
                        'bg-light': '#F9FAFB',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/shared/styles/global.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        :root {
          /* Palette aligned with /menu (shared/styles/global.css) */
          --bg: #f2f7f1;       /* brand-50 */
          --fg: #1f2937;       /* text */
          --card: #ffffff;     /* surface */
          --border: rgba(15, 74, 34, 0.14); /* subtle green border */

          --primary: #0f4a22;  /* brand-800 */
          --primary-contrast: #ffffff;
          --accent: #13532a;   /* brand-700 */

          --muted: rgba(31, 41, 55, 0.68);
          --shadow: 0 22px 60px rgba(16, 24, 40, 0.12);

          --radius: 16px;
          --container: 1120px;

          --font-sans: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
          --font-serif: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .theme-admin { background-color: var(--bg); color: var(--fg); font-family: var(--font-sans); }
        .theme-admin header { background-color: var(--bg) !important; box-shadow: none; border-color: transparent !important; }
        .theme-admin .surface { background-color: var(--card) !important; border-color: var(--border) !important; box-shadow: var(--shadow); border-radius: var(--radius); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hidden { display: none !important; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        /* Animación suave para las cards */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-enter { animation: fadeIn 0.3s ease-out forwards; }
        .page-enter { animation: fadeIn 0.25s ease-out both; }
        .page-leave { opacity: 0 !important; transform: translateY(4px); transition: opacity .22s ease, transform .22s ease; }
          /* Ajuste tipografía y densidad */
          #page-title { font-size: 30px !important; line-height: 1.2; }
          .table-compact th, .table-compact td { padding: 0.75rem !important; }
          .table-compact th { font-size: 11px; }
          .table-compact td { font-size: 13px; }

                /* Skeleton loader */
                .skeleton { position: relative; overflow: hidden; background: #e5e7eb; border-radius: 6px; }
                .skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, rgba(229,231,235,0) 0%, rgba(255,255,255,0.6) 50%, rgba(229,231,235,0) 100%); animation: shimmer 1.4s infinite; }
                @keyframes shimmer { 100% { transform: translateX(100%); } }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex theme-admin">

    <div id="mobile-overlay" onclick="toggleSidebar()" 
         class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden backdrop-blur-sm transition-opacity">
    </div>

    <!-- Componente Aside (renderizado desde components/aside.js) -->
    <div id="admin-sidebar-container" data-active="tables"></div>

    <main id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative w-full page-enter">
        
        <header class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4 md:mb-6">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 rounded-lg text-gray-600 hover:bg-gray-100 focus:outline-none">
                        <span class="material-icons-outlined text-2xl">menu</span>
                    </button>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 truncate" id="page-title">Inventario de Mesas</h1>
                    <p class="text-sm md:text-base text-gray-600 mt-1">Administra el inventario de mesas: crear, editar, archivar y restaurar.</p>
                </div>

                <div id="table-actions" class="flex gap-2 w-full md:w-auto">
                    <button onclick="toggleArchivedMode()" id="btn-toggle-archive" class="w-full md:w-auto bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm font-medium border border-gray-300 transition-colors">
                        <span class="material-icons-outlined text-sm">delete_outline</span>
                        Papelera
                    </button>

                    <button class="w-full md:w-auto bg-primary hover:bg-green-900 text-white px-4 py-2 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform transform active:scale-95 text-sm font-medium" onclick="window.openCreateModal()">
                        <span class="material-icons-outlined text-sm">add</span>
                        Nueva Mesa
                    </button>
                </div>
            </div>
        </header>

        <div id="view-tables" class="flex-1 overflow-y-auto p-4 md:p-8 pt-0">
            <div class="mb-4">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="w-full md:w-auto flex items-start gap-3">
                        <button onclick="toggleSidebar()" class="md:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg text-slate-600 hover:bg-slate-100 focus:outline-none">
                            <span class="material-icons-outlined text-2xl">menu</span>
                        </button>
                        <div>
                            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 leading-tight" id="page-title">Inventario de Mesas</h1>
                            <p class="text-xs sm:text-sm md:text-base text-gray-600 mt-1">Administra el inventario de mesas: crear, editar, archivar y restaurar.</p>
                        </div>
                    </div>

                    <div id="table-actions" class="flex gap-2 w-full md:w-auto">
                        <button onclick="toggleArchivedMode()" id="btn-toggle-archive" class="w-full md:w-auto bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm font-medium border border-gray-300 transition-colors">
                            <span class="material-icons-outlined text-sm">delete_outline</span>
                            Papelera
                        </button>

                        <button class="w-full md:w-auto bg-primary hover:bg-green-900 text-white px-4 py-2 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform transform active:scale-95 text-sm font-medium" onclick="window.openCreateModal()">
                            <span class="material-icons-outlined text-sm">add</span>
                            Nueva Mesa
                        </button>
                    </div>
                </div>
            </div>
            <div id="archive-warning" class="hidden bg-orange-50 border-l-4 border-orange-500 text-orange-700 p-4 mb-4 rounded-r shadow-sm" role="alert">
                <div class="flex items-center gap-2">
                    <span class="material-icons-outlined">warning</span>
                    <div>
                        <p class="font-bold">Modo Papelera de Reciclaje</p>
                        <p class="text-sm">Estás viendo las mesas eliminadas.</p>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden overflow-x-auto surface">
                <table class="table-compact w-full text-left border-collapse min-w-[680px]"> 
                    <thead class="bg-brand-800 text-white">
                        <tr>
                            <th class="p-4 text-xs font-semibold uppercase tracking-wide">ID</th>
                            <th class="p-4 text-xs font-semibold uppercase tracking-wide">Mesa #</th>
                            <th class="p-4 text-xs font-semibold uppercase tracking-wide text-center">Sesiones</th>
                            <th class="p-4 text-xs font-semibold uppercase tracking-wide">Estado</th>
                            <th class="p-4 text-xs font-semibold uppercase tracking-wide text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="table-body"></tbody>
                </table>
            </div>
            <div id="pagination-container" class="flex justify-center items-center mt-6 gap-2"></div>
            <div class="h-8"></div>
        </div>

        

    </main>

    <div id="create-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Registrar Nueva Mesa</h3>
                        <form id="create-table-form" class="mt-4 space-y-4">
                            <input type="hidden" id="table_id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Número de Mesa</label>
                                <input type="number" id="table_number" required min="1" class="mt-1 block w-full rounded border-gray-300 py-2 px-3 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Capacidad</label>
                                <input type="number" id="capacity" required min="1" value="4" class="mt-1 block w-full rounded border-gray-300 py-2 px-3 border">
                            </div>
                            <div id="status-container" class="hidden">
                                <label class="block text-sm font-medium text-gray-700">Estado</label>
                                <select id="modal_status" class="mt-1 block w-full rounded border-gray-300 py-2 px-3 border bg-white">
                                    <option value="AVAILABLE">Available (Disponible)</option>
                                    <option value="OCCUPIED">Occupied (Ocupada)</option>
                                    <option value="OUT_OF_SERVICE">Out of Service (Mantenimiento)</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" onclick="handleFormSubmit()" class="inline-flex w-full justify-center rounded-md bg-primary px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-800 sm:ml-3 sm:w-auto">Guardar</button>
                        <button type="button" onclick="closeModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="restore-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-sm">
                    
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-orange-100 sm:mx-0 sm:h-10 sm:w-10">
                                <span class="material-icons-outlined text-orange-600">restore_from_trash</span>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-base font-semibold leading-6 text-gray-900">Restaurar Mesa</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500 mb-4">
                                        Se restaurará la mesa manteniendo su número original.
                                    </p>
                                    <input type="hidden" id="restore_table_id">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" onclick="submitRestore()" class="inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 sm:ml-3 sm:w-auto">Confirmar</button>
                        <button type="button" onclick="closeRestoreModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-sm">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4 text-center">
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100 mb-4">
                            <span class="material-icons-outlined text-green-600">qr_code_2</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Código QR - Mesa <span id="qr-table-num">#</span></h3>
                        <div class="mt-4 flex justify-center bg-gray-50 p-4 rounded border">
                            <img id="qr-image" src="" alt="QR" class="w-48 h-48 object-contain">
                        </div>
                        <a id="qr-test-link" href="#" target="_blank" class="mt-2 text-xs text-blue-600 hover:underline block">Probar enlace</a>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button onclick="closeQrModal()" class="w-full justify-center rounded-md bg-primary px-3 py-2 text-sm font-semibold text-white shadow-sm sm:w-auto">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/config.js"></script>
    <script defer src="/mod-3-atencion-cliente/components/toast.js"></script>
    <script src="/mod-3-atencion-cliente/components/admin-auth.js"></script>
    <script src="/mod-3-atencion-cliente/components/aside.js"></script>
    <script src="/mod-3-atencion-cliente/api/base.js"></script>
    <script src="/mod-3-atencion-cliente/api/auth.js"></script>
    <script src="/mod-3-atencion-cliente/api/client.js"></script>
    <script src="/mod-3-atencion-cliente/api/tables.js"></script>
    <script src="/mod-3-atencion-cliente/api/service-request.js"></script>

    <script>
        // --- ESTADO GLOBAL (solo Mesas) ---
        let currentPage = 1;
        let isArchivedMode = false;
        let itemsPerPage = 10;

        const pageTitle = document.getElementById('page-title');
        const tableActions = document.getElementById('table-actions');

        const tableBody = document.getElementById('table-body');

        // Modales
        const modal = document.getElementById('create-modal');
        const form = document.getElementById('create-table-form');
        const qrModalEl = document.getElementById('qr-modal');
        const restoreModal = document.getElementById('restore-modal');
        const restoreInputId = document.getElementById('restore_table_id');

        // --- INICIALIZACIÓN ---
        let __tablesPoller = null;
        document.addEventListener('DOMContentLoaded', () => {
            loadTablesData();
            __tablesPoller = setInterval(() => {
                if (document.hidden) return; // evita trabajo en pestaña oculta
                loadTablesData();
            }, 15000);
        });

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        };

        // ==========================================
        // LOGICA 1: MESAS (CRUD)
        // ==========================================
        function renderSkeletonRows(count = 8) {
            const rows = Array.from({ length: count }).map(() => `
                <tr class="border-b border-gray-100">
                    <td class="p-4"><div class="skeleton h-4 w-10"></div></td>
                    <td class="p-4"><div class="skeleton h-4 w-40"></div></td>
                    <td class="p-4 text-center"><div class="inline-block skeleton h-4 w-8"></div></td>
                    <td class="p-4"><div class="skeleton h-6 w-24 rounded-full"></div></td>
                    <td class="p-4 text-right flex justify-end gap-2">
                        <div class="skeleton h-6 w-6 rounded"></div>
                        <div class="skeleton h-6 w-6 rounded"></div>
                        <div class="skeleton h-6 w-6 rounded"></div>
                    </td>
                </tr>
            `).join('');
            tableBody.innerHTML = rows;
        }

        async function loadTablesData() {
            try {
                renderSkeletonRows();
                const response = await window.TablesApi.getTables(currentPage, itemsPerPage, '', isArchivedMode);

                if (response.success && response.data.length > 0) {
                    tableBody.innerHTML = response.data.map(renderTableRow).join('');

                    if (response.metadata) {
                        renderPagination(response.metadata);
                    }

                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Sin registros.</td></tr>';
                    document.getElementById('pagination-container').innerHTML = '';
                }
            } catch (error) {
                console.error(error);
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        function renderPagination(meta) {
            const container = document.getElementById('pagination-container');
            
            // Si solo hay una página, no mostramos controles
            if (meta.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }

            const isFirst = meta.current_page === 1;
            const isLast = meta.current_page === meta.total_pages;

            container.innerHTML = `
                <button 
                    onclick="window.changePage(${meta.current_page - 1})" 
                    ${isFirst ? 'disabled' : ''}
                    class="px-3 py-1 rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1">
                    <span class="material-icons-outlined text-sm">chevron_left</span> Anterior
                </button>

                <span class="text-sm text-gray-600 font-medium px-2 flex items-center">
                    Página ${meta.current_page} de ${meta.total_pages}
                    <span class="ml-2 text-xs text-gray-400">(${meta.total_items} ítems)</span>
                </span>

                <button 
                    onclick="window.changePage(${meta.current_page + 1})" 
                    ${isLast ? 'disabled' : ''}
                    class="px-3 py-1 rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-1">
                    Siguiente <span class="material-icons-outlined text-sm">chevron_right</span>
                </button>
            `;
        }

        function renderTableRow(table) {
            const statusStyles = {
                'AVAILABLE': 'bg-green-100 text-green-800',
                'OCCUPIED': 'bg-orange-100 text-orange-800',
                'OUT_OF_SERVICE': 'bg-gray-200 text-gray-800'
            };
            const badgeClass = statusStyles[table.current_status] || 'bg-gray-100 text-gray-800';
            const activeSessions = table.active_sessions || 0;
            const sessionColor = activeSessions > 0 ? 'text-green-600 font-bold' : 'text-gray-400';

            let buttons = '';
            if(isArchivedMode) {
                buttons = `<button onclick="window.openRestoreModal(${table.id}, '${table.table_number}')" class="text-green-600 hover:bg-green-50 px-2 py-1 rounded text-xs font-bold border border-green-200">RESTAURAR</button>`;
            } else {
                buttons = `
                    <button onclick="window.openQrModal('${table.table_number}', '${table.qr_uuid}')" class="text-gray-400 hover:text-blue-600 p-1"><span class="material-icons-outlined">qr_code_2</span></button>
                    <button onclick="window.openEditModal('${table.id}', '${table.table_number}', '${table.capacity}', '${table.current_status}')" class="text-gray-400 hover:text-green-600 p-1"><span class="material-icons-outlined">edit</span></button>
                    ${table.current_status !== 'OCCUPIED' ? 
                        `<button onclick="window.deleteTable(${table.id})" class="text-gray-400 hover:text-red-500 p-1"><span class="material-icons-outlined">delete</span></button>` : 
                        `<span class="text-gray-300 p-1 cursor-not-allowed" title="Ocupada"><span class="material-icons-outlined">delete</span></span>`
                    }
                `;
            }

            return `
                <tr class="hover:bg-gray-50 border-b border-gray-100 transition-colors">
                    <td class="p-4 text-sm text-gray-700">#${table.id}</td>
                    <td class="p-4 text-sm font-medium text-gray-900">${table.table_number} <span class="text-gray-400 text-xs font-normal">(Cap: ${table.capacity})</span></td>
                    <td class="p-4 text-center ${sessionColor}">${activeSessions}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-medium ${badgeClass}">${table.current_status}</span></td>
                    <td class="p-4 text-right flex justify-end gap-1">${buttons}</td>
                </tr>
            `;
        }

        // --- Funciones Modales Mesas ---
        window.openCreateModal = () => {
            form.reset();
            document.getElementById('table_id').value = "";
            document.getElementById('table_number').disabled = false;
            document.getElementById('status-container').classList.add('hidden');
            document.getElementById('modal-title').textContent = "Registrar Nueva Mesa";
            modal.classList.remove('hidden');
        };

        window.openEditModal = (id, num, cap, status) => {
            form.reset();
            document.getElementById('table_id').value = id;
            document.getElementById('table_number').value = num;
            document.getElementById('capacity').value = cap;
            document.getElementById('modal_status').value = status;
            document.getElementById('table_number').disabled = true;
            document.getElementById('status-container').classList.remove('hidden');
            document.getElementById('modal-title').textContent = `Editar Mesa #${num}`;
            modal.classList.remove('hidden');
        };

        window.closeModal = () => modal.classList.add('hidden');

        window.handleFormSubmit = async () => {
            const id = document.getElementById('table_id').value;
            const number = document.getElementById('table_number').value;
            const capacity = document.getElementById('capacity').value;
            const status = document.getElementById('modal_status').value;

            if (!number) {
                if (typeof showToast === 'function') { showToast("Por favor ingresa un número de mesa.", 'warning'); }
                return;
            }

            if (isNaN(number) || parseInt(number) <= 0) {
                if (typeof showToast === 'function') { showToast("El número de mesa debe ser un entero positivo.", 'warning'); }
                return;
            }

            if (!capacity) {
                if (typeof showToast === 'function') { showToast("Por favor ingresa la capacidad de la mesa.", 'warning'); }
                return;
            }

            if (isNaN(capacity) || parseInt(capacity) <= 0) {
                if (typeof showToast === 'function') { showToast("La capacidad debe ser un entero positivo.", 'warning'); }
                return;
            }

            try {
                if (id) {
                    const updatedTable = await window.TablesApi.updateTable(id, { currentStatus: status, capacity: parseInt(capacity) });

                    if (updatedTable.id && !updatedTable.error) {
                        if (typeof showToast === 'function') { showToast(`Mesa #${updatedTable.table_number} actualizada con éxito.`, 'success'); }
                        closeModal();
                        loadTablesData();
                    } 
                    else {
                        let msg = `Error (${updatedTable.status || 'Desconocido'}):\n`;

                        // 1. Si hay un mensaje explicativo (Lógica de negocio)
                        if (updatedTable.message) {
                            msg += `${updatedTable.error}: ${updatedTable.message}`;
                        } 
                        // 2. Si hay errores de validación (Zod)
                        else if (updatedTable.validationErrors) {
                            msg += "Verifique los datos:\n";
                            // Recorremos los errores de Zod para mostrarlos
                            const issues = updatedTable.validationErrors; 
                            Object.keys(issues).forEach(key => {
                                const errText = issues[key]._errors ? issues[key]._errors.join(', ') : 'Inválido';
                                msg += `- ${key}: ${errText}\n`;
                            });
                        } 
                        // 3. Fallback (Error genérico)
                        else {
                            msg += updatedTable.error || "Ocurrió un error inesperado.";
                        }

                        if (typeof showToast === 'function') { showToast(msg, 'error', 6000); }
                    }

                } else {
                    const newTable = await window.TablesApi.createTable({ table_number: parseInt(number), capacity: parseInt(capacity) });

                    if (newTable.id && !newTable.error) {
                        if (typeof showToast === 'function') { showToast(`Mesa #${newTable.table_number} creada con éxito.`, 'success'); }
                    } else {
                        let msg = `Error (${newTable.status || 'Desconocido'}):\n`;

                        // 1. Si hay un mensaje explicativo (Lógica de negocio)
                        if (newTable.message) {
                            msg += `${newTable.error}: ${newTable.message}`;
                        } 
                        // 2. Si hay errores de validación (Zod)
                        else if (newTable.validationErrors) {
                            msg += "Verifique los datos:\n";
                            // Recorremos los errores de Zod para mostrarlos
                            const issues = newTable.validationErrors; 
                            Object.keys(issues).forEach(key => {
                                const errText = issues[key]._errors ? issues[key]._errors.join(', ') : 'Inválido';
                                msg += `- ${key}: ${errText}\n`;
                            });
                        } 
                        // 3. Fallback (Error genérico)
                        else {
                            msg += newTable.error || "Ocurrió un error inesperado.";
                        }

                        if (typeof showToast === 'function') { showToast(msg, 'error', 6000); }
                    }
                }
                closeModal();
                loadTablesData();
            } catch (e) {
                if (typeof showToast === 'function') { showToast("Error: " + (e.message || 'Desconocido'), 'error', 6000); }
            }
        };

        window.deleteTable = async (id) => {
            if(confirm("¿Enviar a papelera?")) {
                await window.TablesApi.deleteTable(id);
                if (typeof showToast === 'function') { showToast('Mesa enviada a la papelera.', 'success'); }
                loadTablesData();
            }
        };

        window.openRestoreModal = (id, oldNumber) => {
            restoreInputId.value = id;
            restoreModal.classList.remove('hidden');
        };

        window.closeRestoreModal = () => {
            restoreModal.classList.add('hidden');
        };

        window.submitRestore = async () => {
            const id = restoreInputId.value;
            try {
                const result = await window.TablesApi.restoreTable(id);
                if (result && !result.error) {
                    if (typeof showToast === 'function') { showToast('Mesa restaurada correctamente, número mantenido.', 'success'); }
                    closeRestoreModal();
                    loadTablesData();
                } else {
                    if (typeof showToast === 'function') { showToast("Error: " + (result.message || result.error || "No se pudo restaurar"), 'error', 6000); }
                }
            } catch (error) {
                console.error(error);
                if (typeof showToast === 'function') { showToast("Error de conexión.", 'error', 6000); }
            }
        };

        window.toggleArchivedMode = () => {
            isArchivedMode = !isArchivedMode;
            const btn = document.getElementById('btn-toggle-archive');
            const warning = document.getElementById('archive-warning');
            
            if(isArchivedMode) {
                btn.innerHTML = '<span class="material-icons-outlined text-sm">table_restaurant</span> Ver Inventario';
                btn.classList.add('bg-orange-100', 'text-orange-800');
                warning.classList.remove('hidden');
                pageTitle.textContent = "Papelera de Reciclaje";
            } else {
                btn.innerHTML = '<span class="material-icons-outlined text-sm">delete_outline</span> Papelera';
                btn.classList.remove('bg-orange-100', 'text-orange-800');
                warning.classList.add('hidden');
                pageTitle.textContent = "Inventario de Mesas";
            }
            loadTablesData();
        };

        window.openQrModal = (num, uuid) => {
            const url = `${window.location.origin}/mod-3-atencion-cliente/pages/login/scan.html?qr_uuid=${uuid}`; 
            document.getElementById('qr-table-num').textContent = `#${num}`;
            document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;
            document.getElementById('qr-test-link').href = url;
            qrModalEl.classList.remove('hidden');
        };
        window.closeQrModal = () => qrModalEl.classList.add('hidden');

        /*
        // ==========================================
        // LOGICA 2: SESIONES Y FANTASMAS
        // ==========================================
        async function loadSessionsData() {
            sessionsBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center">Cargando sesiones activas...</td></tr>';
            
            try {
                const response = await window.ClientApi.getActiveClients();
                if (response.success && response.data && response.data.length > 0) {
                    sessionsBody.innerHTML = response.data.map(renderSessionRow).join('');
                } else {
                    sessionsBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">No hay clientes activos.</td></tr>';
                }
            } catch (error) {
                console.error(error);
                sessionsBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        function renderSessionRow(client) {
            const created = new Date(client.createdAt);
            const now = new Date();
            const diffMs = now - created;
            const diffMins = Math.floor(diffMs / 60000);
            const timeString = created.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const currentConsumption = client.totalAmount || 0;
            const isGhost = diffMins > 30 && currentConsumption === 0;

            const rowClass = isGhost ? 'bg-red-50 hover:bg-red-100 border-l-4 border-red-500' : 'hover:bg-gray-50 border-b border-gray-100';
            const timeClass = isGhost ? 'text-red-600 font-bold' : 'text-gray-600';
            
            return `
                <tr class="${rowClass} transition-colors">
                    <td class="p-4 font-bold text-gray-800">Mesa ${client.table.tableNumber}</td>
                    <td class="p-4 text-sm">
                        <div class="font-medium">${client.customerName || 'Invitado'}</div>
                        <div class="text-xs text-gray-500">ID: ${client.id}</div>
                    </td>
                    <td class="p-4 text-sm text-gray-600">${timeString}</td>
                    <td class="p-4 text-sm ${timeClass}">${diffMins} min</td>
                    <td class="p-4 text-sm font-mono">$${currentConsumption.toFixed(2)}</td>
                    <td class="p-4 text-right">
                        <button onclick="forceCloseSession(${client.id})" class="text-xs text-red-500 hover:text-red-700 underline">Forzar Salida</button>
                    </td>
                </tr>
            `;
        }
        
        window.forceCloseSession = async (clientId) => {
            if(confirm("¿Estás seguro de cerrar forzosamente esta sesión?")) {
                try {
                   await window.ClientApi.updateClient(clientId, { status: "CLOSED" });
                         if (typeof showToast === 'function') { showToast('Sesión cerrada correctamente.', 'success'); }
                         loadSessionsData();
                     } catch(e) { if (typeof showToast === 'function') { showToast(e.message || 'Error desconocido', 'error', 5000); } }
            }
        };
        */

        /*
        // ==========================================
        // LOGICA 3: SOLICITUDES (CARDS)
        // ==========================================
        window.filterRequests = (status) => {
            requestStatusFilter = status;
            
            const btnPending = document.getElementById('filter-pending');
            const btnAttended = document.getElementById('filter-attended');
            
            if(status === 'PENDING') {
                btnPending.className = "px-4 py-2 text-sm font-medium rounded-md bg-orange-100 text-orange-700 transition-colors shadow-sm";
                btnAttended.className = "px-4 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 transition-colors";
            } else {
                btnPending.className = "px-4 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 transition-colors";
                btnAttended.className = "px-4 py-2 text-sm font-medium rounded-md bg-green-100 text-green-700 transition-colors shadow-sm";
            }

            loadRequestsData();
        };

        async function loadRequestsData() {
            // Spinner ligero si está vacío, si no, solo refresca silenciosamente
            if(requestsGrid.innerHTML === '') {
                requestsGrid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Cargando solicitudes...</div>';
            }

            try {
                // Usamos la nueva API creada
                const response = await window.ServiceRequestApi.getRequests(1, 20, requestStatusFilter);
                
                if (response.success && response.data.length > 0) {
                    requestsGrid.innerHTML = response.data.map(renderRequestCard).join('');
                } else {
                    requestsGrid.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-12 text-gray-400 bg-white rounded-lg border border-dashed border-gray-300">
                            <span class="material-icons-outlined text-4xl mb-2">inbox</span>
                            <p>No hay solicitudes ${requestStatusFilter === 'PENDING' ? 'pendientes' : 'en el historial'}.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
                // Si falla y es auto-refresh, mejor no borrar lo que ya hay
            }
        }

        function renderRequestCard(req) {
            const created = new Date(req.created_at || req.createdAt);
            const now = new Date();
            const diffMins = Math.floor((now - created) / 60000);
            
            let timeString = diffMins < 1 ? 'Hace un momento' : `Hace ${diffMins} min`;
            if (diffMins > 60) timeString = created.toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' });

            const isComplaint = req.type === 'COMPLAINT';
            const isPending = req.status === 'PENDING';
            
            // Estilos
            const cardBorder = isComplaint ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-blue-500';
            const iconBg = isComplaint ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600';
            const iconName = isComplaint ? 'priority_high' : 'pan_tool';
            const titleText = isComplaint ? 'Queja / Incidente' : 'Llamado a Mesero';
            
            // Safe access a table_info
            const mesaId = req.table_info?.id || req.table_id || '?';

            let actionButton = '';
            if (isPending) {
                actionButton = `
                    <button onclick="attendRequest('${req.id}')" class="w-full mt-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-green-50 hover:text-green-700 hover:border-green-200 transition-all font-medium text-sm flex items-center justify-center gap-2 group">
                        <span class="material-icons-outlined text-gray-400 group-hover:text-green-600 text-lg">check_circle</span>
                        Marcar como Atendido
                    </button>
                `;
            } else {
                const attendedTime = req.attended_at ? new Date(req.attended_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
                actionButton = `
                    <div class="mt-3 pt-3 border-t border-gray-100 text-xs text-center text-gray-400">
                        Atendido a las ${attendedTime}
                    </div>
                `;
            }

            return `
                <div class="card-enter bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow flex flex-col justify-between ${isPending ? cardBorder : 'opacity-75'}">
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full ${iconBg} flex items-center justify-center">
                                    <span class="material-icons-outlined text-lg">${iconName}</span>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-sm">${titleText}</h4>
                                    <p class="text-xs text-gray-500 flex items-center gap-1">
                                        <span class="material-icons-outlined text-[10px]">schedule</span>
                                        ${timeString}
                                    </p>
                                </div>
                            </div>
                            <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded border border-gray-200">Mesa ${mesaId}</span>
                        </div>
                        
                        <div class="bg-gray-50 p-2 rounded text-gray-700 text-sm mb-2 leading-relaxed italic border border-gray-100">
                            "${req.message || 'Sin mensaje'}"
                        </div>
                    </div>
                    ${actionButton}
                </div>
            `;
        }

        window.attendRequest = async (id) => {
            try {
                // Optimistic UI: lo marcamos como atendido visualmente
                await window.ServiceRequestApi.markAsAttended(id);
                if (typeof showToast === 'function') { showToast('Solicitud marcada como atendida.', 'success'); }
                loadRequestsData(); // Recargar datos frescos
            } catch (e) {
                if (typeof showToast === 'function') { showToast('Error al actualizar: ' + (e.message || 'Desconocido'), 'error', 5000); }
            }
        };
        */

        window.changePage = (newPage) => {
            if (newPage < 1) return;
            currentPage = newPage;
            loadTablesData();
        };

    </script>
</body>
</html>