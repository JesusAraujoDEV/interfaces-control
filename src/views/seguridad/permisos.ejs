<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Permisos - Charlotte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/seguridad/permisos.css">
    <%- include('../partials/inyectarHelpersCss.ejs') %>
</head>
<body class="bg-gray-100">

    <div class="contenedor-dashboard">
        
        <%- include('../partials/aside.ejs') %>

        <main class="contenido-principal">
            
            <header class="cabecera">
                <div>
                    <h1>Permisos</h1>
                    <p>Gestiona todos los permisos del sistema para usuarios y roles.</p>
                </div>
            </header>

            <div class="contenedor-busqueda">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" placeholder="Buscar por nombre de permiso o recurso...">
            </div>

            <div class="tarjeta-tabla overflow-tabla">
                <table class="tabla-permisos">
                    <thead>
                        <tr>
                            <th>Nombre del Permiso</th>
                            <th>Tipo</th>
                            <th>Recurso</th>
                            <th>Método</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (permissions && permissions.length > 0) { %>
                            <% permissions.forEach(permission => { %>
                                <tr>
                                    <td><a href="/seguridad/permisos/<%= permission.id %>" class="text-blue-600 hover:underline"><%= permission.name || permission.nombre %></a></td>
                                    <td><span class="badge <%= permission.type === 'RECURSO' ? 'azul' : permission.type === 'VIEW' ? 'morado' : 'gris' %>"><%= permission.type || permission.tipo %></span></td>
                                    <td><span class="badge gris"><%= permission.resource || permission.recurso %></span></td>
                                    <td><span class="badge amarillo"><%= permission.method || permission.metodo %></span></td>
                                    <td><i class="fa-solid fa-pen-to-square"></i> <i class="fa-solid fa-trash hover:text-red-600 cursor-pointer ml-2" title="Eliminar" onclick="eliminarPermiso(<%= permission.id %>)"></i></td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="5" style="text-align: center;">No hay permisos disponibles.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>

                <div class="paginacion">
                    <span><i class="fa-solid fa-chevron-left"></i></span>
                    <span class="pagina-activa">1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>...</span>
                    <span>10</span>
                    <span><i class="fa-solid fa-chevron-right"></i></span>
                </div>
            </div>
        </main>

    </div>

    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Confirmar Eliminación</h2>
            <p class="text-sm text-gray-600 mb-6">¿Estás seguro de que deseas eliminar este permiso? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">Cancelar</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Sí, eliminar</button>
            </div>
        </div>
    </div>

    <%- include('../partials/inyectarHelpersJs.ejs') %>
    <script>
        let permisoToDelete = null;

        document.addEventListener("DOMContentLoaded", () => {
         
            const permissionsData = <%- JSON.stringify(permissions) %>;
            
            const tableBody = document.querySelector('.tabla-permisos tbody');
            const searchInput = document.querySelector('.contenedor-busqueda input');
            const paginationContainer = document.querySelector('.paginacion');

            let estado = {
                permissions: permissionsData,     
                permissionsFiltrados: permissionsData, 
                paginaActual: 1,
                filasPorPagina: 12         
            };

            function renderizarTabla() {
                tableBody.innerHTML = ''; 

                const inicio = (estado.paginaActual - 1) * estado.filasPorPagina;
                const fin = inicio + estado.filasPorPagina;
                const permissionsPagina = estado.permissionsFiltrados.slice(inicio, fin);

                if (permissionsPagina.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No se encontraron permisos.</td></tr>';
                    return;
                }

                permissionsPagina.forEach(permission => {
                    // Formatear Tipo
                    const tipoClass = permission.type === 'RECURSO' ? 'azul' : permission.type === 'VIEW' ? 'morado' : 'gris';
                    const tipoHtml = `<span class="badge ${tipoClass}">${permission.type}</span>`;

                    // Construir la fila HTML
                    const fila = `
                        <tr>
                            <td><a href="/seguridad/permisos/${permission.id}" class="text-blue-600 hover:underline">${permission.name || permission.nombre}</a></td>
                            <td>${tipoHtml}</td>
                            <td><span class="badge gris">${permission.resource || permission.recurso}</span></td>
                            <td><span class="badge amarillo">${permission.method || permission.metodo}</span></td>
                            <td>
                                <i class="fa-solid fa-trash hover:text-red-600 cursor-pointer ml-2" title="Eliminar" onclick="eliminarPermiso(${permission.id})"></i>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', fila);
                });
            }

            function renderizarPaginacion() {
                paginationContainer.innerHTML = '';
                const totalPaginas = Math.ceil(estado.permissionsFiltrados.length / estado.filasPorPagina);

                const btnPrev = document.createElement('span');
                btnPrev.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
                btnPrev.className = estado.paginaActual === 1 ? 'disabled' : '';
                btnPrev.onclick = estado.paginaActual > 1 ? () => cambiarPagina(estado.paginaActual - 1) : null;
                paginationContainer.appendChild(btnPrev);

                for (let i = 1; i <= totalPaginas; i++) {
                    const span = document.createElement('span');
                    span.className = `num-pagina ${i === estado.paginaActual ? 'pagina-activa' : ''}`;
                    span.textContent = i;
                    span.onclick = () => cambiarPagina(i);
                    paginationContainer.appendChild(span);
                }

                const btnNext = document.createElement('span');
                btnNext.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
                btnNext.className = estado.paginaActual === totalPaginas || totalPaginas === 0 ? 'disabled' : '';
                btnNext.onclick = estado.paginaActual < totalPaginas ? () => cambiarPagina(estado.paginaActual + 1) : null;
                paginationContainer.appendChild(btnNext);
            }

            function cambiarPagina(nuevaPagina) {
                const totalPaginas = Math.ceil(estado.permissionsFiltrados.length / estado.filasPorPagina);
                if (nuevaPagina < 1 || nuevaPagina > totalPaginas) return;

                estado.paginaActual = nuevaPagina;
                renderizarTabla();
                renderizarPaginacion();
            }

       
            searchInput.addEventListener('input', (e) => {
                const texto = e.target.value.toLowerCase();
                
                estado.permissionsFiltrados = estado.permissions.filter(permission => {
                    const nombre = (permission.name || permission.nombre || '').toLowerCase();
                    return nombre.includes(texto);
                });

                estado.paginaActual = 1;
                renderizarTabla();
                renderizarPaginacion();
            });

            window.eliminarPermiso = (id) => {
                permisoToDelete = id;
                document.getElementById('confirmDeleteModal').classList.remove('hidden');
            };

            console.log("Inicializando tabla con", estado.permissions.length, "permisos.");
            renderizarTabla();
            renderizarPaginacion();
        });

        document.getElementById('cancelDelete').onclick = () => {
            document.getElementById('confirmDeleteModal').classList.add('hidden');
            permisoToDelete = null;
        };

        document.getElementById('confirmDelete').onclick = async () => {
            if (permisoToDelete) {
                try {
                    const response = await fetch(`/api/seguridad/permissions/${permisoToDelete}`, {
                        method: 'DELETE'
                    });
                    
                    let data = {};
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        data = await response.json();
                    }

                    if (response.ok) {
                        window.seguridad_notyf.success('Permiso eliminado exitosamente.');
                        location.reload();
                    } else {
                        window.seguridad_notyf.error(data.message || 'Error al eliminar el permiso.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    window.seguridad_notyf.error('Error de conexión.');
                }
            }
            document.getElementById('confirmDeleteModal').classList.add('hidden');
            permisoToDelete = null;
        };
    </script>
</body>
</html>