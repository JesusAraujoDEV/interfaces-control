<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Permiso - Charlotte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/seguridad/verPermiso.css">
    <%- include('../partials/inyectarHelpersCss.ejs') %>
</head>
<body class="bg-gray-50">

    <div class="contenedor-dashboard">
        
        <%- include('../partials/aside.ejs') %>

        <main class="contenido-principal">
            
            <nav class="breadcrumb">
                <span>Charlotte</span> / <span>Permisos</span> / <span class="actual">Ver permiso</span>
            </nav>

            <header class="titulo-pagina">
                <h1>Ver Permiso</h1>
            </header>

            <section class="tarjeta-formulario">
                <form>
                    <div class="fila-input">
                        <div class="grupo">
                            <label>Nombre del Permiso</label>
                            <input type="text" id="nombrePermiso" placeholder="ej., Ver Pedidos" readonly>
                        </div>
                        <div class="grupo">
                            <label>Tipo</label>
                            <input type="text" id="tipoPermiso" readonly>
                        </div>
                    </div>

                    <div class="fila-input">
                        <div class="grupo">
                            <label>Recurso</label>
                            <input type="text" id="recursoPermiso" readonly>
                        </div>
                        <div class="grupo">
                            <label>Método</label>
                            <input type="text" id="metodoPermiso" readonly>
                        </div>
                    </div>

                    <div class="grupo">
                        <label>Rol Asociado</label>
                        <div class="multi-input" id="rolesAsociados">
                            </div>
                    </div>

                    <div class="acciones-finales">
                         <button type="button" id="btnEliminar" class="btn-eliminar" style="color: red;">Eliminar Permiso</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <!-- Modal de confirmación -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Confirmar Eliminación</h2>
            <p class="text-sm text-gray-600 mb-6">¿Estás seguro de que deseas eliminar este permiso? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">Cancelar</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Sí, eliminar</button>
            </div>
        </div>
    </div>

    <%- include('../partials/inyectarHelpersJs.ejs') %>

    <script>
        const permissionId = <%- JSON.stringify(permissionId) %>;

        const getAuthHeaders = () => {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        };

        document.addEventListener("DOMContentLoaded", async () => {
            if (permissionId) {
                try {
                    const response = await fetch(`/api/seguridad/permissions/${permissionId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                    
                        const permission = data.id ? data : (data.permission || data.data);
                        
                        if (permission) {
                            console.log('Datos del permiso procesados:', permission);
                            
                    
                            document.getElementById('nombrePermiso').value = permission.name || '';
                            
                            const tipoMap = { 'RECURSO': 'Recurso', 'VIEW': 'Vista' };
                            document.getElementById('tipoPermiso').value = tipoMap[permission.type] || permission.type || '';
                            
                            const recursoMap = { 'PEDIDO': 'Pedido', 'MESA': 'Mesa', 'RECETA': 'Receta' };
                            document.getElementById('recursoPermiso').value = recursoMap[permission.resource] || permission.resource || '';
                            
                            const metodoMap = { 'CREATE': 'Crear', 'READ': 'Leer', 'UPDATE': 'Actualizar', 'DELETE': 'Eliminar' };
                            document.getElementById('metodoPermiso').value = metodoMap[permission.method] || permission.method || '';
                            
                      
                            const roleDiv = document.getElementById('rolesAsociados');
                            roleDiv.innerHTML = '<span class="text-gray-400 text-xs">Buscando rol...</span>';

                            if (permission.role && (permission.role.name || permission.role.nombre)) {
                                roleDiv.innerHTML = `<span class="tag-rol">${permission.role.name || permission.role.nombre}</span>`;
                            } 
                         
                            else if (permission.roleId) {
                                try {
                                    const roleRes = await fetch(`/api/seguridad/roles/${permission.roleId}`, { headers: getAuthHeaders() });
                                    const roleData = await roleRes.json();
                                    const roleObj = roleData.role || roleData;
                                    const finalName = (Array.isArray(roleObj) ? roleObj[0].name : roleObj.name) || `Rol #${permission.roleId}`;
                                    roleDiv.innerHTML = `<span class="tag-rol">${finalName}</span>`;
                                } catch (e) {
                                    roleDiv.innerHTML = `<span class="tag-rol text-gray-400">ID: ${permission.roleId}</span>`;
                                }
                            } 
                            
                            else {
                                try {
                                    const allRolesRes = await fetch('/api/seguridad/roles', { headers: getAuthHeaders() });
                                    const allRolesData = await allRolesRes.json();
                                    const roles = allRolesData.roles || allRolesData;
                                    
                                    // Buscamos qué rol contiene el permiso con nuestro ID
                                    const ownerRole = roles.find(r => 
                                        r.permissions && r.permissions.some(p => p.id == permissionId)
                                    );

                                    if (ownerRole) {
                                        roleDiv.innerHTML = `<span class="tag-rol">${ownerRole.name}</span>`;
                                    } else {
                                        roleDiv.innerHTML = `<span class="tag-rol text-red-400">Sin Rol Asignado</span>`;
                                    }
                                } catch (err) {
                                    roleDiv.innerHTML = `<span class="tag-rol text-red-400">No vinculado</span>`;
                                }
                            }
                        }
                    } else {
                        window.seguridad_notyf.error('Error al cargar permiso');
                    }
                } catch (e) { 
                    console.error('Error crítico:', e);
                }
            }
        });

 
        const modalEliminar = document.getElementById('confirmDeleteModal');
        const btnEliminar = document.getElementById('btnEliminar');
        const btnConfirmarEliminar = document.getElementById('confirmDelete');
        const btnCancelarEliminar = document.getElementById('cancelDelete');

    
        modalEliminar.style.display = 'none';

        btnEliminar.addEventListener('click', () => {
            modalEliminar.style.display = 'flex';
        });

        btnCancelarEliminar.addEventListener('click', () => {
            modalEliminar.style.display = 'none';
        });

        btnConfirmarEliminar.addEventListener('click', async () => {
            try {
                const response = await fetch(`/api/seguridad/permissions/${permissionId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    window.seguridad_notyf.success('Permiso eliminado exitosamente');
                  
                    setTimeout(() => {
                        window.location.href = '/seguridad/permisos';
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    window.seguridad_notyf.error(errorData.message || 'Error al eliminar el permiso');
                }
            } catch (error) {
                console.error('Error al eliminar:', error);
                window.seguridad_notyf.error('Error de conexión');
            }
            modalEliminar.style.display = 'none';
        });
    </script>
</body>
</html>