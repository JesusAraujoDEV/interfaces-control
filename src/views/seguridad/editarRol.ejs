<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Rol - Charlotte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/seguridad/editarRol.css">
    <%- include('../partials/inyectarHelpersCss.ejs') %>
</head>
<body class="bg-[#f8fafc]">
    <div id="modalPermiso" class="modal-overlay hidden">
        <div class="modal-container">
            <header class="mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">Crear Permiso</h2>
                <p id="modalSubtitle" class="text-sm text-gray-500 mt-1">Usa este formulario para crear un permiso asociado a este rol</p>
            </header>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div class="campo">
                        <label>Nombre del Permiso</label>
                        <input type="text" id="nombrePermiso" placeholder="ej., Ver Pedidos">
                    </div>
                    <div class="campo">
                        <label>Tipo</label>
                        <select id="tipoPermiso" class="select-personalizado">
                            <option selected disabled>Selecciona un tipo</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="campo">
                        <label>Recurso</label>
                        <select id="recursoPermiso" class="select-personalizado">
                            <option selected disabled>Selecciona un recurso</option>
                        </select>
                    </div>
                    <div class="campo">
                        <label>Método</label>
                        <select id="metodoPermiso" class="select-personalizado">
                            <option selected disabled>Selecciona un método</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="cerrarModal()" class="btn-cancelar-modal">Cancelar</button>
                    <button type="button" id="btnGuardarPermiso" class="btn-guardar">Crear Permiso</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal-container" style="max-width: 400px;">
            <header class="mb-6">
                <h2 class="text-xl font-bold text-gray-900">Confirmar Acción</h2>
            </header>
            <p class="text-sm text-gray-500 mb-6">¿Estás seguro de que deseas quitar este permiso del rol?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="btn-cancelar-modal">Cancelar</button>
                <button id="confirmYes" class="btn-guardar">Sí</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[100]">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Confirmar Eliminación</h2>
            <p class="text-sm text-gray-600 mb-6">¿Estás seguro de que deseas eliminar este rol? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">Cancelar</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-bold">Sí, eliminar</button>
            </div>
        </div>
    </div>

    <div class="flex min-h-screen">
        <%- include('../partials/aside.ejs') %>

        <main class="flex-grow p-12 contenido-principal">
            <header class="mb-8">
                <p class="text-[11px] text-gray-400 font-bold uppercase tracking-wider mb-1">Dashboard / Roles / Editar Rol </p>
                <h1 id="roleMainTitle" class="text-3xl font-bold text-gray-900">Editar Rol</h1>
                <p class="text-sm text-gray-500">Actualiza los detalles del rol, permisos y usuarios asignados.</p>
            </header>

            <div class="max-w-5xl space-y-6" style="margin: auto;">
                <div class="tarjeta-blanca">
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="campo">
                            <label>Nombre del Rol</label>
                            <input type="text" id="name">
                        </div>
                        <div class="campo">
                            <label>Descripción</label>
                            <textarea rows="2" id="description"></textarea>
                        </div>
                    </div>

                    <div class="mb-8">
                        <label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Permisos Asignados</label>
                        <button type="button" onclick="abrirModalCrear()" class="btn-añadir-permiso mb-4">
                            Añadir Permiso
                        </button>
                        <div class="flex flex-wrap gap-2" id="permisosAsignados"></div>
                    </div>

                    <div>
                        <label class="text-sm font-bold text-gray-800 mb-4 block">Usuarios con este Rol</label>
                        <div class="border border-gray-100 rounded-lg overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-[#1e4d35] text-white text-[11px] uppercase font-bold">
                                    <tr>
                                        <th class="px-4 py-3">Nombre</th>
                                        <th class="px-4 py-3">Email</th>
                                        <!-- <th class="px-4 py-3 text-right">Acción</th> -->
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-4">
                    <button id="btnOpenDeleteRol" class="text-red-700 font-bold text-sm hover:underline">Eliminar Rol</button>
                    <div class="flex gap-3">
                        <a href="/seguridad/roles" class="btn-cancelar">Cancelar</a>
                        <button id="saveRole" class="btn-guardar">Guardar Rol</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <%- include('../partials/inyectarHelpersJs.ejs') %>

    <script>
        const roleId = <%= roleId %>;
        let assignedPermissions = [];
        let isEditingExisting = false;
        let isViewMode = false;
        let currentPermId = null;
        let permToRemove = null;

        // --- HELPER PARA HEADERS CON TOKEN ---
        // Esta función centraliza la obtención del token del localStorage
        const getAuthHeaders = () => {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        };

        // --- INICIALIZACIÓN ---
        document.addEventListener("DOMContentLoaded", async () => {
            if (roleId) {
                try {
                    // Agregamos headers a la carga inicial por si la ruta está protegida
                    const response = await fetch(`/api/seguridad/roles/${roleId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(data);
                        let role = Array.isArray(data.role) ? data.role[0] : data.role;
                        
                        document.getElementById('name').value = role.name || '';
                        document.getElementById('description').value = role.description || '';
                        document.getElementById('roleMainTitle').textContent = `Editar Rol: ${role.name}`;

                        assignedPermissions = role.permissions || [];
                        const permisosDiv = document.getElementById('permisosAsignados');
                        permisosDiv.innerHTML = '';
                        assignedPermissions.forEach(perm => addPermissionSpan(perm));

                        const usersBody = document.getElementById('usersTableBody');
                        usersBody.innerHTML = '';
                        if (role.users?.length > 0) {
                            role.users.forEach(u => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td class="px-4 py-3 font-medium">${u.name || u.email}</td>
                                    <td class="px-4 py-3 text-gray-500">${u.email}</td>`
                                    // <td class="px-4 py-3 text-right">
                                    //     <button class="text-red-600 hover:underline text-xs">Desasignar</button>
                                    // </td>`;
                                usersBody.appendChild(tr);
                            });
                        } else {
                            usersBody.innerHTML = '<tr><td colspan="3" class="px-4 py-3 text-center text-gray-500">No hay usuarios</td></tr>';
                        }
                    }
                } catch (e) { console.error(e); }
            }
        });

        // --- LÓGICA DE ELIMINACIÓN DE ROL ---
        const deleteModal = document.getElementById('confirmDeleteModal');
        document.getElementById('btnOpenDeleteRol').onclick = (e) => { e.preventDefault(); deleteModal.classList.remove('hidden'); };
        document.getElementById('cancelDelete').onclick = () => deleteModal.classList.add('hidden');
        document.getElementById('confirmDelete').onclick = async () => {
            const res = await fetch(`/api/seguridad/roles/${roleId}`, { 
                method: 'DELETE',
                headers: getAuthHeaders() // Agregado token
            });
            if (res.ok) window.location.href = '/seguridad/roles';
            else window.seguridad_notyf.error("No se pudo eliminar el rol");
        };

        // --- LÓGICA DE PERMISOS ---

        function toggleFields(disabled) {
            document.getElementById('nombrePermiso').readOnly = disabled;
            document.getElementById('tipoPermiso').disabled = disabled;
            document.getElementById('recursoPermiso').disabled = disabled;
            document.getElementById('metodoPermiso').disabled = disabled;
        }

        function addPermissionSpan(perm) {
            const div = document.getElementById('permisosAsignados');
            const span = document.createElement('span');
            span.className = 'badge-permiso';
            span.innerHTML = `${perm.nombre || perm.name} <i class="fa-solid fa-xmark ml-2 cursor-pointer"></i>`;
            span.style.cursor = 'pointer';
            span.onclick = () => abrirModalLectura(perm);
            span.querySelector('i').onclick = (e) => {
                e.stopPropagation();
                permToRemove = perm;
                document.getElementById('confirmModal').classList.remove('hidden');
            };
            div.appendChild(span);
        }

        async function cargarEnums(perm = null) {
            // Los enums suelen ser públicos, pero por seguridad enviamos headers si es necesario
            const fetchEnum = (path) => fetch(path, { headers: getAuthHeaders() }).then(res => res.json());

            const [t, r, m] = await Promise.all([
                fetchEnum('/api/seguridad/enums/Permission/type'),
                fetchEnum('/api/seguridad/enums/Permission/resource'),
                fetchEnum('/api/seguridad/enums/Permission/method')
            ]);

            console.log(t,r,m);

            

            const populate = (id, list, current) => {
                    // // determina si current termina con _view
                    // const isView = current?.endsWith('_view') || current === 'View';
                    // const s = document.getElementById(id);
                    // s.innerHTML = '<option disabled>Selecciona...</option>';
                    // // inverte list.types
                    // const items = list.types?.reverse() || ( isView ? list.resources?.DefinitiveViews : list.resources?.Resources ) || ( isView ? list.methods?.View : list.methods?.Methods ) || [];
                    // items.forEach(i => {
                    //     const opt = document.createElement('option');
                    //     opt.value = i; opt.textContent = i;
                    //     if(i === current) opt.selected = true;
                    //     s.appendChild(opt);
                    // });
                    const s = document.getElementById(id);
                    s.innerHTML = '<option disabled>Selecciona...</option>';
                    // inverte list.types
                    let items = list.types?.[0] || ( list.resources?.DefinitiveViews ) || ( list.methods?.DefinitiveMethod ) || [];
                    // si items es un valor lo convierte en un array de un valor
                    if(!Array.isArray(items)) items = [items];
                    items.forEach(i => {
                        const opt = document.createElement('option');
                        opt.value = i; opt.textContent = i;
                        if(i === current) opt.selected = true;
                        s.appendChild(opt);
                    });
            };
            populate('tipoPermiso', t, perm?.tipo || perm?.type);
            populate('recursoPermiso', r, perm?.recurso || perm?.resource);
            populate('metodoPermiso', m, perm?.metodo || perm?.method);

            // Resource de Views
            const ResourceViews = r.resources?.Views || [];
            // Resource de Recursos 
            const ResourceResources = r.resources?.Resources || [];
            // Method de Views
            const MethodViews = m.methods?.View || [];  
            // Method de Recursos
            const MethodResources = m.methods?.Methods || [];

            // Agrega eventos a los selectores para que cuando cambie el tipo de permiso, se actualicen los recursos y métodos
            document.getElementById('tipoPermiso').onchange = (e) => {
                const type = e.target.value; 
                const recursoSelect = document.getElementById('recursoPermiso');
                const metodoSelect = document.getElementById('metodoPermiso');
                recursoSelect.innerHTML = '<option disabled>Selecciona...</option>';
                metodoSelect.innerHTML = '<option disabled>Selecciona...</option>';
                if(type === 'View') {
                    ResourceViews.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r; opt.textContent = r;
                        recursoSelect.appendChild(opt);
                    });
                    MethodViews.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m; opt.textContent = m;
                        metodoSelect.appendChild(opt);
                    });
                } else if(type === 'Resource') {
                    ResourceResources.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r; opt.textContent = r;
                        recursoSelect.appendChild(opt);
                    });
                    MethodResources.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m; opt.textContent = m;
                        metodoSelect.appendChild(opt);
                    });
                }
            };

        }

        function abrirModalCrear() {
            isEditingExisting = false;
            isViewMode = false;
            currentPermId = null;
            document.getElementById('modalTitle').textContent = 'Crear Permiso';
            document.getElementById('modalSubtitle').textContent = 'Usa este formulario para crear un permiso asociado a este rol';
            document.getElementById('btnGuardarPermiso').textContent = 'Crear Permiso';
            document.getElementById('nombrePermiso').value = '';
            toggleFields(false);
            cargarEnums();
            document.getElementById('modalPermiso').classList.remove('hidden');
        }

        async function abrirModalLectura(perm) {
            isEditingExisting = true;
            isViewMode = true;
            currentPermId = perm.id || perm._id; 

            document.getElementById('modalTitle').textContent = 'Detalle del Permiso';
            document.getElementById('modalSubtitle').textContent = 'Modo lectura. Haz clic en Editar para realizar cambios.';
            document.getElementById('btnGuardarPermiso').textContent = 'Editar';
            document.getElementById('nombrePermiso').value = perm.nombre || perm.name;
            
            toggleFields(true);
            await cargarEnums(perm);
            document.getElementById('modalPermiso').classList.remove('hidden');
        }

        function cerrarModal() { document.getElementById('modalPermiso').classList.add('hidden'); }

     
        document.getElementById('btnGuardarPermiso').onclick = async () => {
            if (isViewMode) {
                isViewMode = false;
                toggleFields(false);
                document.getElementById('btnGuardarPermiso').textContent = 'Actualizar Permiso';
                document.getElementById('modalTitle').textContent = 'Editando Permiso';
                return;
            }

            const payload = {
                name: document.getElementById('nombrePermiso').value,
                type: document.getElementById('tipoPermiso').value,
                resource: document.getElementById('recursoPermiso').value,
                method: document.getElementById('metodoPermiso').value,
                roleId: roleId
            };

            if (isEditingExisting) {
                payload.id = currentPermId;
            }

            const url = isEditingExisting ? `/api/seguridad/permissions/${currentPermId}` : '/api/seguridad/permissions';
            const method = isEditingExisting ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    window.seguridad_notyf.success(isEditingExisting ? "Permiso actualizado correctamente" : "Permiso creado correctamente");
                    setTimeout(() => { location.reload(); }, 1200);
                } else {
                    const msg = data.message || "Error al procesar la solicitud";
                    window.seguridad_notyf.error("Error: " + msg);
                }
            } catch (e) { 
                console.error("Error Fetch:", e);
                window.seguridad_notyf.error("No se pudo conectar con el servidor");
            }
        };

        // QUITAR PERMISO
        document.getElementById('confirmCancel').onclick = () => document.getElementById('confirmModal').classList.add('hidden');
        document.getElementById('confirmYes').onclick = async () => {
            if (permToRemove) {
                const res = await fetch(`/api/seguridad/permissions/${permToRemove.id}`, { 
                    method: 'DELETE',
                    headers: getAuthHeaders() // Agregado token
                });
                if (res.ok) {
                    window.seguridad_notyf.success("Permiso eliminado");
                    location.reload();
                } else {
                    window.seguridad_notyf.error("Error al eliminar");
                }
            }
        };

        // GUARDAR ROL (NOMBRE Y DESC)
        document.getElementById('saveRole').onclick = async () => {
            const res = await fetch(`/api/seguridad/roles/${roleId}`, {
                method: 'PUT',
                headers: getAuthHeaders(), // Agregado token
                body: JSON.stringify({
                    name: document.getElementById('name').value,
                    description: document.getElementById('description').value,
                    permissions: assignedPermissions.map(p => p.id)
                })
            });
            if (res.ok) {
                window.seguridad_notyf.success("Rol guardado");
                window.location.href = '/seguridad/roles';
            } else {
                const errorData = await res.json();
                window.seguridad_notyf.error(errorData.message || "Error al guardar rol");
            }
        };
    </script>
</body>
</html>