<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roles - Charlotte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/seguridad/roles.css">
    <%- include('../partials/inyectarHelpersCss.ejs') %>
</head>
<body class="bg-[#f8fafc]">

    <div class="contenedor-dashboard">
        <%- include('../partials/aside.ejs') %>

        <main class="flex-grow p-12">
            <header class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Roles</h1>
                    <p class="text-sm text-gray-500">Gestiona los roles de usuario y sus permisos dentro del sistema.</p>
                </div>
                <a href="/seguridad/roles/crear" class="inline-block">
                    <button class="btn-nuevo-rol">
                        <i class="fa-solid fa-plus mr-2"></i> Crear Nuevo Rol
                </a>
            </header>

            <div class="relative mb-6">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-gray-400 text-sm"></i>
                <input type="text" id="searchInput" placeholder="Buscar por nombre de rol..." class="input-busqueda">
            </div>

            <div class="bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-[#1e4d35] text-white uppercase text-[11px] tracking-wider font-bold">
                        <tr>
                            <th class="px-6 py-4">Nombre del Rol</th>
                            <th class="px-6 py-4">Descripción</th>
                            <th class="px-6 py-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        </tbody>
                </table>
                
                <div id="paginationContainer" class="flex justify-center items-center gap-1 py-4 bg-gray-50 border-t border-gray-100">
                    </div>
            </div>
        </main>
    </div>

    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-2xl">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Confirmar Eliminación</h2>
            <p class="text-sm text-gray-600 mb-6">¿Estás seguro de que deseas eliminar este rol? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">Cancelar</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Sí, eliminar</button>
            </div>
        </div>
    </div>

    <%- include('../partials/inyectarHelpersJs.ejs') %>

<script>
    let roleToDelete = null;
    let estado = {
        paginaActual: 1,
        filasPorPagina: 12,
        busqueda: '',
        rolesAMostrar: [],
        allRoles: [],
        totalPaginas: 0
    };

    // Función para eliminar
    async function eliminarRol(id) {
        roleToDelete = id;
        document.getElementById('confirmDeleteModal').classList.remove('hidden');
    }

    document.getElementById('cancelDelete').onclick = () => {
        document.getElementById('confirmDeleteModal').classList.add('hidden');
        roleToDelete = null;
    };

    document.getElementById('confirmDelete').onclick = async () => {
        if (roleToDelete) {
            try {
                const response = await fetch(`/api/seguridad/roles/${roleToDelete}`, { method: 'DELETE' });
                if (response.ok) {
                    window.seguridad_notyf.success('Rol eliminado exitosamente.');
                    // Forzar recarga completa de datos
                    estado.allRoles = []; 
                    await cargarRoles();
                } else {
                    const data = await response.json().catch(() => ({}));
                    window.seguridad_notyf.error(data.message || 'Error al eliminar.');
                }
            } catch (error) {
                window.seguridad_notyf.error('Error de conexión.');
            }
        }
        document.getElementById('confirmDeleteModal').classList.add('hidden');
    };

    // Carga de Datos Principal
    async function cargarRoles() {
        try {
            // Solo cargamos de la API si no tenemos los datos cacheamos
            if (estado.allRoles.length === 0) {
                const response = await fetch(`/api/seguridad/roles?limit=1000`);
                if (!response.ok) throw new Error('Error en red');
                const data = await response.json();
                
                if (data.success) {
                    estado.allRoles = data.roles;
                }
            }

            // Filtrar y Pags
            const filtered = estado.allRoles.filter(role => 
                role.name.toLowerCase().includes(estado.busqueda.toLowerCase())
            );

            estado.totalPaginas = Math.ceil(filtered.length / estado.filasPorPagina);
            
            // Ajustar página actual si queda fuera de rango tras búsqueda
            if (estado.paginaActual > estado.totalPaginas) estado.paginaActual = Math.max(1, estado.totalPaginas);

            const inicio = (estado.paginaActual - 1) * estado.filasPorPagina;
            estado.rolesAMostrar = filtered.slice(inicio, inicio + estado.filasPorPagina);

            renderizarTabla();
            renderizarPaginacion();
        } catch (error) {
            console.error('Fallo en carga:', error);
            // No disparamos Notyf aquí para evitar spam en el renderizado inicial
        }
    }

    function renderizarTabla() {
        const tableBody = document.querySelector('tbody.divide-y');
        tableBody.innerHTML = '';

        if (estado.rolesAMostrar.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-10 text-center text-gray-400">No se encontraron resultados.</td></tr>';
            return;
        }

        estado.rolesAMostrar.forEach(role => {
            const fila = `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 text-sm font-bold text-gray-800">${role.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${role.description || 'Sin descripción'}</td>
                    <td class="px-6 py-4 text-right space-x-3 text-gray-400">
                        <a href="/seguridad/roles/editar/${role.id}" class="hover:text-blue-500 transition-colors"><i class="fa-solid fa-pen"></i></a>
                        <button class="hover:text-red-500 transition-colors" onclick="eliminarRol(${role.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', fila);
        });
    }

    function renderizarPaginacion() {
        const container = document.getElementById('paginationContainer');
        container.innerHTML = '';

        if (estado.totalPaginas <= 1) return;

        // Botón Prev
        const btnPrev = document.createElement('button');
        btnPrev.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
        btnPrev.className = `w-10 h-10 flex items-center justify-center rounded-lg border ${estado.paginaActual === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-100'}`;
        btnPrev.onclick = () => { if(estado.paginaActual > 1) cambiarPagina(estado.paginaActual - 1) };
        container.appendChild(btnPrev);

        // Páginas
        for (let i = 1; i <= estado.totalPaginas; i++) {
            const btnPage = document.createElement('button');
            btnPage.textContent = i;
            btnPage.className = `w-10 h-10 rounded-lg text-sm font-medium transition-colors ${i === estado.paginaActual ? 'bg-[#1e4d35] text-white' : 'text-gray-600 hover:bg-gray-100'}`;
            btnPage.onclick = () => cambiarPagina(i);
            container.appendChild(btnPage);
        }

        // Botón Next
        const btnNext = document.createElement('button');
        btnNext.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
        btnNext.className = `w-10 h-10 flex items-center justify-center rounded-lg border ${estado.paginaActual === estado.totalPaginas ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-100'}`;
        btnNext.onclick = () => { if(estado.paginaActual < estado.totalPaginas) cambiarPagina(estado.paginaActual + 1) };
        container.appendChild(btnNext);
    }

    function cambiarPagina(n) {
        estado.paginaActual = n;
        cargarRoles();
    }

    document.addEventListener("DOMContentLoaded", () => {
        cargarRoles();

        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            estado.busqueda = e.target.value;
            estado.paginaActual = 1;
            cargarRoles();
        });
    });
</script>
</body>
</html>