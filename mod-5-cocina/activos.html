<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../api/config.js"></script>
    <script src="../js/dev-auth.js"></script>
    <script src="../js/api.js"></script>
    <title>Gestión de Activos Fijos - Kitchen OS</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="app-container">

    <aside class="sidebar">
        <div class="sidebar__profile">
            <div class="sidebar__avatar"></div>
            <div class="sidebar__info">
                <p class="sidebar__user">Charlotte</p>
                <p class="sidebar__role">Kitchen OS</p>
            </div>
        </div>
        <nav class="sidebar__nav">
            <a href="#" class="sidebar__link"><i data-lucide="layout-grid"></i> Panel de Control</a>
            <a href="#" class="sidebar__link"><i data-lucide="package"></i> Inventario</a>
            <a href="#" class="sidebar__link sidebar__link--active"><i data-lucide="wrench"></i> Activos Fijos</a>
            <a href="#" class="sidebar__link"><i data-lucide="book-open"></i> Recetas</a>
            <a href="#" class="sidebar__link"><i data-lucide="truck"></i> Proveedores</a>
        </nav>
        <div class="sidebar__footer">
            <a href="#" class="sidebar__link"><i data-lucide="settings"></i> Configuración</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1 class="header__title">Gestión de Activos Fijos</h1>
            <div class="header__actions">
                <button class="btn btn--secondary" id="addAssetBtn">Añadir Nuevo Activo</button>
                <button class="btn btn--primary"><i data-lucide="clipboard-check"></i> Auditar Activos</button>
            </div>
        </header>

        <section class="inventory-controls">
            <div class="search-bar">
                <i data-lucide="search" class="search-bar__icon"></i>
                <input type="text" class="search-bar__input" placeholder="Buscar por nombre o ID...">
            </div>
            <div class="inventory-controls__view-options">
                <button class="icon-btn"><i data-lucide="sliders-horizontal"></i></button>
                <div class="view-toggle">
                    <button class="view-toggle__btn view-toggle__btn--active"><i data-lucide="layout-grid"></i></button>
                    <button class="view-toggle__btn"><i data-lucide="list"></i></button>
                </div>
            </div>
        </section>

        <section id="assetsGrid" class="assets-grid">
            <!-- Asset cards se poblarán vía JS -->
        </section>
    </main>

    <!-- Modal para Nuevo Activo -->
    <div id="newAssetModal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Nuevo Activo</h2>
                <button class="modal__close" id="closeNewAssetModal">&times;</button>
            </div>
            <form id="newAssetForm" class="modal__form">
                <div class="form-group">
                    <label for="assetName">Nombre del Activo</label>
                    <input type="text" id="assetName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="assetTotal">Total</label>
                    <input type="number" id="assetTotal" name="total" min="1" required>
                </div>
                <div class="form-group">
                    <label for="assetStatus">Estado</label>
                    <select id="assetStatus" name="status" required>
                        <option value="OPERATIONAL">Operativo</option>
                        <option value="DAMAGED">Dañado</option>
                        <option value="LOST">Perdido</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assetImage">URL de Imagen (opcional)</label>
                    <input type="url" id="assetImage" name="image_url" placeholder="https://...">
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" id="cancelNewAssetBtn">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Crear Activo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Reportar Incidente -->
    <div id="reportIncidentModal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Reportar Incidente</h2>
                <button class="modal__close" id="closeReportModal">&times;</button>
            </div>
            <form id="reportIncidentForm" class="modal__form">
                <input type="hidden" id="incidentAssetId" name="asset_id">
                <div class="form-group">
                    <label for="incidentQuantity">Cantidad Perdida</label>
                    <input type="number" id="incidentQuantity" name="quantity" min="1" required placeholder="ej. 2">
                </div>
                <div class="form-group">
                    <label for="incidentReason">Motivo</label>
                    <select id="incidentReason" name="reason" required>
                        <option value="">Seleccionar...</option>
                        <option value="Deterioro">Deterioro</option>
                        <option value="Pérdida">Pérdida</option>
                        <option value="Robo">Robo</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportedBy">Reportado Por</label>
                    <input type="text" id="reportedBy" name="reported_by" readonly>
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" id="cancelReportBtn">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Reportar</button>
                </div>
            </form>
        </div>
    </div>

</script>

    <script>
        // Cargar activos y renderizar cards
        async function loadAssets() {
            const container = document.getElementById('assetsGrid');
            container.innerHTML = ''; // limpiar
            try {
                const resp = await fetch(`${KITCHEN_URL}/assets`, {
                    method: 'GET',
                    headers: getCommonHeaders()
                });
                if (!resp.ok) throw new Error(`Error: ${resp.status}`);
                const assets = await resp.json();
                if (!Array.isArray(assets) || assets.length === 0) {
                    container.innerHTML = '<p>No hay activos registrados.</p>';
                    return;
                }

                assets.forEach(a => {
                    const status = (a.status || '').toUpperCase();
                    let badgeClass = 'badge--warning';
                    let badgeText = status;
                    if (status === 'OPERATIONAL') {
                        badgeClass = 'badge--success';
                        badgeText = 'Operativo';
                    } else if (status === 'DAMAGED') {
                        badgeClass = 'badge--danger';
                        badgeText = 'Dañado';
                    } else if (status === 'LOST' || status === 'MISSING') {
                        badgeClass = 'badge--danger';
                        badgeText = 'Perdido';
                    }

                    const img = a.image_url || a.photo || 'https://via.placeholder.com/400x300?text=Activo';
                    const title = a.name || a.title || 'Activo';
                    const total = a.total != null ? a.total : (a.totalQuantity || 0);

                    const article = document.createElement('article');
                    article.className = 'asset-card';
                    article.innerHTML = `
                        <div class="asset-card__image-wrapper">
                            <img src="${img}" alt="${title}" class="asset-card__img">
                        </div>
                        <div class="asset-card__content">
                            <h3 class="asset-card__title">${title}</h3>
                            <p class="asset-card__total">Total: <span class="total-count">${total}</span></p>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            <button class="btn btn--small report-incident-btn" data-id="${a.id}">Reportar Incidente</button>
                            <button class="btn btn--small view-history-btn" data-id="${a.id}">Ver Historial</button>
                        </div>
                    `;
                    container.appendChild(article);
                });
            } catch (err) {
                console.error('Error cargando activos:', err);
                container.innerHTML = '<p>Error cargando activos. Revisa la consola.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', loadAssets);

        // Modal para nuevo activo
        const newAssetModal = document.getElementById('newAssetModal');
        const newAssetForm = document.getElementById('newAssetForm');
        const closeNewAssetModal = document.getElementById('closeNewAssetModal');
        const cancelNewAssetBtn = document.getElementById('cancelNewAssetBtn');
        const addAssetBtn = document.getElementById('addAssetBtn');

        // Abrir modal
        addAssetBtn.addEventListener('click', () => {
            newAssetModal.style.display = 'block';
        });

        // Cerrar modal
        closeNewAssetModal.addEventListener('click', () => {
            newAssetModal.style.display = 'none';
        });

        cancelNewAssetBtn.addEventListener('click', () => {
            newAssetModal.style.display = 'none';
        });

        // Enviar formulario
        newAssetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(newAssetForm);
            const payload = {
                name: formData.get('name'),
                total: parseInt(formData.get('total')),
                status: formData.get('status'),
                image_url: formData.get('image_url') || null
            };

            try {
                const response = await fetch(`${KITCHEN_URL}/assets`, {
                    method: 'POST',
                    headers: getCommonHeaders(),
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const newAsset = await response.json();
                // Agregar la nueva tarjeta al grid
                addAssetCard(newAsset);

                // Cerrar modal y resetear
                newAssetModal.style.display = 'none';
                newAssetForm.reset();
            } catch (error) {
                console.error('Error creando activo:', error);
                // Opcional: mostrar mensaje de error
            }
        });

        // Función para agregar una tarjeta de activo al grid
        function addAssetCard(asset) {
            const container = document.getElementById('assetsGrid');
            // Si había mensaje vacío, limpiarlo
            if (container.innerHTML.includes('No hay activos')) {
                container.innerHTML = '';
            }

            const status = (asset.status || '').toUpperCase();
            let badgeClass = 'badge--warning';
            let badgeText = status;
            if (status === 'OPERATIONAL') {
                badgeClass = 'badge--success';
                badgeText = 'Operativo';
            } else if (status === 'DAMAGED') {
                badgeClass = 'badge--danger';
                badgeText = 'Dañado';
            } else if (status === 'LOST') {
                badgeClass = 'badge--danger';
                badgeText = 'Perdido';
            }

            const img = asset.image_url || asset.photo || 'https://via.placeholder.com/400x300?text=Activo';
            const title = asset.name || asset.title || 'Activo';
            const total = asset.total != null ? asset.total : (asset.quantity || 0);

            const article = document.createElement('article');
            article.className = 'asset-card';
            article.innerHTML = `
                <div class="asset-card__image-wrapper">
                    <img src="${img}" alt="${title}" class="asset-card__img">
                </div>
                <div class="asset-card__content">
                    <h3 class="asset-card__title">${title}</h3>
                    <p class="asset-card__total">Total: <span class="total-count">${total}</span></p>
                    <span class="badge ${badgeClass}">${badgeText}</span>
                    <button class="btn btn--small report-incident-btn" data-id="${asset.id}">Reportar Incidente</button>
                    <button class="btn btn--small view-history-btn" data-id="${asset.id}">Ver Historial</button>
                </div>
            `;
            container.appendChild(article);
        }
    </script>

    <script>
        // Función para obtener usuario logueado
        function getLoggedUser() {
            // Asumir que está en localStorage o parsear JWT
            const token = localStorage.getItem('jwt_token');
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.username || payload.email || 'Usuario';
                } catch (e) {
                    return 'Admin';
                }
            }
            return 'Admin';
        }

        // Modal para reportar incidente
        const reportIncidentModal = document.getElementById('reportIncidentModal');
        const reportIncidentForm = document.getElementById('reportIncidentForm');
        const closeReportModal = document.getElementById('closeReportModal');
        const cancelReportBtn = document.getElementById('cancelReportBtn');

        // Event listener para botones reportar incidente
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('report-incident-btn')) {
                const assetId = e.target.dataset.id;
                openReportModal(assetId);
            }
            if (e.target.classList.contains('view-history-btn')) {
                const assetId = e.target.dataset.id;
                window.location.href = `auditoria.html?assetId=${assetId}`;
            }
        });

        function openReportModal(assetId) {
            document.getElementById('incidentAssetId').value = assetId;
            document.getElementById('reportedBy').value = getLoggedUser();
            reportIncidentModal.style.display = 'block';
        }

        // Cerrar modal
        closeReportModal.addEventListener('click', () => {
            reportIncidentModal.style.display = 'none';
        });

        cancelReportBtn.addEventListener('click', () => {
            reportIncidentModal.style.display = 'none';
        });

        // Enviar formulario de reporte
        reportIncidentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(reportIncidentForm);
            const assetId = formData.get('asset_id');
            const quantity = parseInt(formData.get('quantity'));
            const payload = {
                quantity: -quantity, // Negativo para baja
                reason: formData.get('reason'),
                reported_by: formData.get('reported_by')
            };

            try {
                const response = await fetch(`${KITCHEN_URL}/assets/${assetId}/logs`, {
                    method: 'POST',
                    headers: getCommonHeaders(),
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                // Actualizar el total en la tarjeta
                const card = document.querySelector(`.report-incident-btn[data-id="${assetId}"]`).closest('.asset-card');
                const totalSpan = card.querySelector('.total-count');
                const currentTotal = parseInt(totalSpan.textContent);
                totalSpan.textContent = currentTotal - quantity;

                // Cerrar modal y resetear
                reportIncidentModal.style.display = 'none';
                reportIncidentForm.reset();
            } catch (error) {
                console.error('Error reportando incidente:', error);
                // Opcional: mostrar mensaje de error
            }
        });
    </script>

    <script>lucide.createIcons();</script>
</body>

</html>