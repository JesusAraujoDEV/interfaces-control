<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/config.js"></script>
    <script src="/js/dev-auth.js"></script>
    <script src="/js/api.js"></script>
    <title>Auditoría y Movimientos - Kitchen OS</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="app-container">

    <aside class="sidebar">
        <div class="sidebar__profile">
            <div class="sidebar__avatar"></div>
            <div class="sidebar__info">
                <p class="sidebar__user">Charlotte KOS</p>
                <p class="sidebar__role">Kitchen Operating System</p>
            </div>
        </div>
        <nav class="sidebar__nav">
            <a href="#" class="sidebar__link"><i data-lucide="layout-grid"></i> Panel de Control</a>
            <a href="#" class="sidebar__link"><i data-lucide="package"></i> Inventario</a>
            <a href="#" class="sidebar__link"><i data-lucide="clipboard-list"></i> Pedidos</a>
            <a href="#" class="sidebar__link sidebar__link--active"><i data-lucide="history"></i> Registros de
                Auditoría</a>
            <a href="#" class="sidebar__link"><i data-lucide="settings"></i> Configuración</a>
        </nav>
        <div class="sidebar__footer">
            <a href="#" class="sidebar__link"><i data-lucide="help-circle"></i> Ayuda</a>
            <a href="#" class="sidebar__link"><i data-lucide="log-out"></i> Cerrar Sesión</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1 class="header__title">Registros de Auditoría y Movimientos</h1>
        </header>

        <section class="audit-filters">
            <div class="date-picker">
                <i data-lucide="calendar" class="date-picker__icon"></i>
                <span class="date-picker__range">5 Ene, 2024 - 7 Feb, 2024</span>
            </div>
            <button class="btn btn--primary btn--icon">
                <i data-lucide="download"></i> Exportar
            </button>
        </section>

        <section class="table-container">
            <table class="table">
                <thead class="table__head">
                    <tr>
                        <th>FECHA</th>
                        <th>ÍTEM</th>
                        <th>TIPO DE MOVIMIENTO</th>
                        <th>CANTIDAD</th>
                        <th>USUARIO</th>
                        <th>RAZÓN</th>
                    </tr>
                </thead>
                <tbody id="auditTableBody" class="table__body">
                    <!-- Logs serán renderizados aquí por JS cuando exista ?itemId= -->
                </tbody>
            </table>
        </section>
    </main>

    <script>
        // Leer query param itemId y cargar logs si existe
        (async function loadAuditLogs() {
            const params = new URLSearchParams(window.location.search);
            const itemId = params.get('itemId');
            const tbody = document.getElementById('auditTableBody');

            if (!itemId) {
                // Si no hay itemId, mostrar mensaje en la tabla
                tbody.innerHTML = '<tr class="table__row"><td colspan="6">Seleccione un ítem desde Inventario para ver su historial.</td></tr>';
                return;
            }

            try {
                const resp = await fetch(`${KITCHEN_URL}/inventory/items/${itemId}/logs`, {
                    method: 'GET',
                    headers: getCommonHeaders()
                });

                if (!resp.ok) throw new Error(`Error: ${resp.status}`);

                const logs = await resp.json();

                if (!Array.isArray(logs) || logs.length === 0) {
                    tbody.innerHTML = '<tr class="table__row"><td colspan="6">No se encontraron registros para este ítem.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.className = 'table__row';
                    const date = log.timestamp || log.date || '';
                    const itemName = log.item_name || log.name || '';
                    const type = log.type || log.movement_type || '';
                    const qty = (log.quantity || log.qty || 0);
                    const user = log.user || log.username || log.performed_by || '';
                    const reason = log.reason || log.note || '';

                    tr.innerHTML = `
                        <td>${date}</td>
                        <td><strong>${itemName}</strong></td>
                        <td><span class="badge-pill">${type}</span></td>
                        <td>${qty}</td>
                        <td>${user}</td>
                        <td>${reason}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error cargando logs:', err);
                tbody.innerHTML = '<tr class="table__row"><td colspan="6">Error cargando registros. Revisa la consola.</td></tr>';
            }
        })();
    </script>

    <script>lucide.createIcons();</script>
</body>

</html>