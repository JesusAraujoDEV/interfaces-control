<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/config.js"></script>
    <script src="/js/api.js"></script>
    <title>Inventario - Kitchen OS</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="app-container">

    <aside class="sidebar">
        <div class="sidebar__profile">
            <div class="w-9 h-9 rounded-xl bg-brand-50 text-brand-800 flex items-center justify-center shrink-0">
                <img src="/assets/charlotte_logo.png" alt="Charlotte Bistró" class="w-8 h-8 object-contain" loading="eager">
            </div>
            <div class="min-w-0">
                <div class="text-sm font-extrabold text-slate-900 leading-5">Cocina</div>
                <div class="text-xs text-slate-500 leading-4 truncate">Dashboard Operativo</div>
            </div>
            <a href="/admin" class="mt-3 inline-flex items-center gap-2 text-xs text-gray-500 hover:text-gray-800">
                <span aria-hidden="true">←</span>
                <span>Volver a Admin</span>
            </a>
        </div>

        <nav class="sidebar__nav">
            <a href="index.html" class="sidebar__link">
                <i data-lucide="layout-dashboard"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">Dashboard</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Resumen</div>
                </span>
            </a>
            <a href="kds.html" class="sidebar__link">
                <i data-lucide="monitor"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">KDS</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Cola de producción</div>
                </span>
            </a>
            <a href="Despacho.html" class="sidebar__link">
                <i data-lucide="truck"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">Despacho</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Entregas a camareros</div>
                </span>
            </a>
            <a href="rec-pro.html" class="sidebar__link">
                <i data-lucide="chef-hat"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">Recetas</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Maestro de productos</div>
                </span>
            </a>
            <a href="inv.html" class="sidebar__link sidebar__link--active">
                <i data-lucide="package"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">Inventario</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Consumibles y stock</div>
                </span>
            </a>
            <a href="activos.html" class="sidebar__link">
                <i data-lucide="box"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">Activos</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Equipos y utensilios</div>
                </span>
            </a>
            <a href="personal.html" class="sidebar__link">
                <i data-lucide="users"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">Personal</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Staff y turnos</div>
                </span>
            </a>
            <a href="historial_pedidos.html" class="sidebar__link">
                <i data-lucide="history"></i>
                <span class="link-text min-w-0">
                    <div class="text-sm font-semibold leading-5">Historial</div>
                    <div class="text-xs text-slate-500 leading-4 truncate atc-nav-desc">Pedidos y acciones</div>
                </span>
            </a>
        </nav>
        <div class="sidebar__footer">
            <div id="dp-sidebar-toggle-slot" class="sidebar__footer-slot"></div>
            <div class="sidebar__footer-action">
                <a href="/seguridad/logout" aria-label="Cerrar sesión" class="logout-link">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    <span>Cerrar Sesión</span>
                </a>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1 class="header__title">Inventario de Consumibles</h1>
            <div class="header__actions">
                <button class="btn btn--primary" id="newItemBtn">Nuevo Ítem</button>
                <button class="btn btn--secondary" id="inboundBtn">Entrada (+)</button>
                <button class="btn btn--secondary" id="outboundBtn">Salida (-)</button>
            </div>
        </header>

        <section class="table-container">
            <table class="table">
                <thead class="table__head">
                    <tr>
                        <th>NOMBRE</th>
                        <th>TIPO</th>
                        <th>UNIDAD</th>
                        <th>STOCK</th>
                        <th>MIN ALERT</th>
                        <th>COSTO PROM.</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody class="table__body" id="inventoryBody">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- Modal: Create Item -->
    <div id="newItemModal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Nuevo Ítem</h2>
                <button class="modal__close" data-close="newItemModal">&times;</button>
            </div>
            <form id="newItemForm" class="modal__form">
                <div class="form-group">
                    <label for="name">Nombre</label>
                    <input type="text" name="name" id="name" required minlength="2">
                </div>
                <div class="form-group">
                    <label for="type">Tipo</label>
                    <select name="type" id="type" required>
                        <option value="INGREDIENT">Ingrediente</option>
                        <option value="PACKAGING">Empaque</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unitMeasure">Unidad de Medida</label>
                    <select name="unitMeasure" id="unitMeasure" required>
                        <option value="KG">Kilogramos (KG)</option>
                        <option value="G">Gramos (G)</option>
                        <option value="L">Litros (L)</option>
                        <option value="ML">Mililitros (ML)</option>
                        <option value="UNIT">Unidad (UNIT)</option>
                    </select>
                </div>
                <!-- Schema: minStockAlert (number, nonnegative) -->
                <div class="form-group">
                    <label for="minStockAlert">Alerta Stock Mínimo</label>
                    <input type="number" name="minStockAlert" id="minStockAlert" min="0" value="0">
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" data-close="newItemModal">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Crear</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Inbound (Entrada) -->
    <div id="inboundModal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Registrar Entrada</h2>
                <button class="modal__close" data-close="inboundModal">&times;</button>
            </div>
            <form id="inboundForm" class="modal__form">
                <div class="form-group">
                    <label for="inboundItemId">Ítem</label>
                    <select name="itemId" id="inboundItemId" required class="full-width-select">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="inboundQuantity">Cantidad Entrada (+)</label>
                    <input type="number" name="quantityChange" id="inboundQuantity" min="0.01" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="inboundCost">Costo Total (o Unitario?)</label>
                    <small>Schema expects <code>costAtTime</code> (Unit cost usually)</small>
                    <input type="number" name="costAtTime" id="inboundCost" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="inboundReason">Motivo / Proveedor</label>
                    <input type="text" name="reason" id="inboundReason" required placeholder="Ej: Compra semanal">
                </div>
                <div class="form-group">
                    <label for="inboundType">Tipo Movimiento</label>
                    <select name="movementType" id="inboundType" required>
                        <option value="PURCHASE">Compra</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="inboundPin">PIN del Responsable</label>
                    <input type="password" name="pin" id="inboundPin" required placeholder="****" maxlength="6"
                        pattern="\d{6}">
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" data-close="inboundModal">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Outbound (Salida) -->
    <div id="outboundModal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Registrar Salida</h2>
                <button class="modal__close" data-close="outboundModal">&times;</button>
            </div>
            <form id="outboundForm" class="modal__form">
                <div class="form-group">
                    <label for="outboundItemId">Ítem</label>
                    <select name="itemId" id="outboundItemId" required class="full-width-select">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="outboundQuantity">Cantidad Salida (-)</label>
                    <input type="number" name="quantityChange" id="outboundQuantity" min="0.01" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="outboundReason">Razón</label>
                    <input type="text" name="reason" id="outboundReason" required placeholder="Ej: Caducado, Merma...">
                </div>
                <div class="form-group">
                    <label for="outboundType">Tipo Movimiento</label>
                    <select name="movementType" id="outboundType" required>
                        <option value="WASTE">Desperdicio (Merma)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="outboundPin">PIN del Responsable</label>
                    <input type="password" name="pin" id="outboundPin" required placeholder="****" maxlength="4"
                        pattern="\d{4}">
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" data-close="outboundModal">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Item -->
    <div id="editItemModal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Editar Ítem</h2>
                <button class="modal__close" data-close="editItemModal">&times;</button>
            </div>
            <form id="editItemForm" class="modal__form">
                <input type="hidden" name="id" id="editItemId">
                <div class="form-group">
                    <label>Nombre del Ítem</label>
                    <input type="text" name="name" id="editItemName" required>
                </div>
                <div class="form-group">
                    <label>Unidad de Medida</label>
                    <select name="unitMeasure" id="editItemUnit" required>
                        <option value="KG">Kilogramos (KG)</option>
                        <option value="G">Gramos (G)</option>
                        <option value="L">Litros (L)</option>
                        <option value="ML">Mililitros (ML)</option>
                        <option value="UNIT">Unidades (UNIT)</option>
                    </select>
                </div>
                <!-- Schema: minStockAlert (number, nonnegative) -->
                <div class="form-group">
                    <label>Alerta de Stock Mínimo</label>
                    <input type="number" name="minStockAlert" id="editItemMinStock" min="0" step="0.01" required>
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" data-close="editItemModal">Cancelar</button>
                    <button type="submit" class="btn btn--primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Shared Modal Logic ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                setTimeout(() => modal.classList.add('modal--active'), 10);
            }
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('modal--active');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        // Close buttons handler
        document.addEventListener('click', (e) => {
            if (e.target.dataset.close) {
                closeModal(e.target.dataset.close);
            }
        });

        const newItemBtn = document.getElementById('newItemBtn');
        const inboundBtn = document.getElementById('inboundBtn');
        const outboundBtn = document.getElementById('outboundBtn');

        newItemBtn.addEventListener('click', () => { document.getElementById('newItemForm').reset(); openModal('newItemModal'); });
        inboundBtn.addEventListener('click', () => {
            populateItemSelect('inboundItemId');
            document.getElementById('inboundForm').reset();
            openModal('inboundModal');
        });
        outboundBtn.addEventListener('click', () => {
            populateItemSelect('outboundItemId');
            document.getElementById('outboundForm').reset();
            openModal('outboundModal');
        });

        // --- Core Inventory Logic ---
        let inventoryData = [];

        async function validatePin(pin) {
            if (!pin) return null;
            try {
                const res = await fetch(`${KITCHEN_URL}/api/kitchen/staff/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, // No auth headers usually for PIN validation or maybe yes?
                    // Assuming existing pattern. If KITCHEN_URL/api needs auth token, it might be in getCommonHeaders
                    // but for PIN validation, often it's open or uses device token. 
                    // Let's use getCommonHeaders() to be safe if it includes auth.
                    headers: getCommonHeaders(),
                    body: JSON.stringify({ workerCode: pin })
                });
                if (!res.ok) throw new Error('PIN inválido');
                return await res.json(); // Returns staff object with id
            } catch (err) {
                console.error(err);
                alert('PIN inválido o error de verificación');
                return null;
            }
        }

        async function loadInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Cargando...</td></tr>';

            try {
                // Using generic list endpoint
                const resp = await fetch(`${KITCHEN_URL}/api/kitchen/inventory/items`, { headers: getCommonHeaders() });
                if (!resp.ok) throw new Error(resp.status);
                inventoryData = await resp.json();
                renderInventory(inventoryData);
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="7" style="color:red; text-align:center;">Error al cargar inventario</td></tr>';
            }
        }

        function renderInventory(items) {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay ítems registrados</td></tr>';
                return;
            }

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'table__row';

                // Fields from schema: name, type, unitMeasure, minStockAlert
                // Computed/Backend: currentStock, averageCost
                const stock = item.currentStock || 0;
                const min = item.minStockAlert || 0;
                const avgCost = item.averageCost || 0;

                // Status badge logic
                let statusBadge = '<span class="badge badge--success">OK</span>';
                if (stock <= min) {
                    statusBadge = '<span class="badge badge--danger">BAJO</span>';
                } else if (stock <= min * 1.2) {
                    statusBadge = '<span class="badge badge--warning">WARN</span>';
                }

                tr.innerHTML = `
                    <td><strong>${item.name}</strong></td>
                    <td>${item.type}</td>
                    <td>${item.unitMeasure}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <span>${stock}</span>
                            <!-- Minimal progress visual -->
                            <div style="flex:1; height:4px; max-width:60px; background:#eee; border-radius:2px; overflow:hidden;">
                                <div style="height:100%; width:${Math.min((stock / (min * 2 || 10)) * 100, 100)}%; background: ${stock <= min ? 'var(--color-danger)' : 'var(--color-success)'}"></div>
                            </div>
                        </div>
                    </td>
                    <td>${min}</td>
                    <td>${formatCurrency(avgCost)}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="icon-btn-sm btn-edit" data-id="${item.id}" title="Editar">
                                <i data-lucide="edit-3"></i>
                            </button>
                            <a href="auditoria.html?itemId=${item.id}" class="icon-btn-sm" title="Ver Historial">
                                <i data-lucide="history"></i>
                            </a>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (window.lucide) window.lucide.createIcons();

            // Re-attach listeners for dynamic buttons
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    const item = items.find(i => i.id === btn.dataset.id);
                    openEditModal(item);
                });
            });
        }

        // populate select for modals
        function populateItemSelect(selectId) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">Seleccione un ítem...</option>';
            inventoryData.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.id;
                opt.textContent = `${i.name} (${i.unitMeasure}) - Stock: ${i.currentStock || 0}`;
                sel.appendChild(opt);
            });
        }

        function openEditModal(item) {
            if (!item) return;
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemUnit').value = item.unitMeasure;
            document.getElementById('editItemMinStock').value = item.minStockAlert;
            openModal('editItemModal');
        }

        // --- Form Handlers ---

        // 0. Update
        document.getElementById('editItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const itemId = formData.get('id');
            const payload = {
                name: formData.get('name'),
                unitMeasure: formData.get('unitMeasure'),
                minStockAlert: parseFloat(formData.get('minStockAlert'))
            };

            try {
                const resp = await fetch(`${KITCHEN_URL}/api/kitchen/inventory/items/${itemId}`, {
                    method: 'PATCH',
                    headers: getCommonHeaders(),
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) throw new Error(resp.status);

                // Refresh list
                await loadInventory();
                closeModal('editItemModal');
                alert('Ítem actualizado correctamente');
            } catch (err) {
                console.error('Error actualizando ítem:', err);
                alert('Error al actualizar ítem');
            }
        });

        // 1. Create
        document.getElementById('newItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {
                name: fd.get('name'),
                type: fd.get('type'),
                unitMeasure: fd.get('unitMeasure'),
                minStockAlert: parseFloat(fd.get('minStockAlert')) || 0
            };

            try {
                const res = await fetch(`${KITCHEN_URL}/api/kitchen/inventory/items`, {
                    method: 'POST',
                    headers: getCommonHeaders(),
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(res.status);

                closeModal('newItemModal');
                loadInventory(); // Reload table
                alert('Ítem creado correctamente');
            } catch (err) {
                console.error(err);
                alert('Error al crear ítem');
            }
        });

        // 2. Inbound
        document.getElementById('inboundForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const pin = fd.get('pin');

            const staff = await validatePin(pin);
            if (!staff) return;

            // Payload matches inboundSchema
            const payload = {
                itemId: fd.get('itemId'),
                quantityChange: parseFloat(fd.get('quantityChange')),
                costAtTime: parseFloat(fd.get('costAtTime')),
                movementType: fd.get('movementType'),
                reason: fd.get('reason'),
                staffId: staff.id
            };

            try {
                // Post to /inventory/inbound or /inventory/movements/inbound ?
                // Trying generic convention based on schema name "inboundSchema" -> likely /inbound resource or action
                const res = await fetch(`${KITCHEN_URL}/api/kitchen/inventory/inbound`, {
                    method: 'POST',
                    headers: getCommonHeaders(),
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(res.status);

                closeModal('inboundModal');
                loadInventory();
                alert(`Entrada registrada por ${staff.role} (ID: ${staff.workerCode})`);
            } catch (err) {
                console.error(err);
                alert('Error al registrar entrada: ' + err.message);
            }
        });

        // 3. Outbound
        document.getElementById('outboundForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const pin = fd.get('pin');

            const staff = await validatePin(pin);
            if (!staff) return;

            // Payload matches outboundSchema
            const payload = {
                itemId: fd.get('itemId'),
                quantityChange: parseFloat(fd.get('quantityChange')),
                movementType: fd.get('movementType'),
                reason: fd.get('reason'),
                staffId: staff.id
            };

            try {
                const res = await fetch(`${KITCHEN_URL}/api/kitchen/inventory/outbound`, {
                    method: 'POST',
                    headers: getCommonHeaders(),
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(res.status);

                closeModal('outboundModal');
                loadInventory();
                alert(`Salida registrada por ${staff.role} (ID: ${staff.workerCode})`);
            } catch (err) {
                console.error(err);
                alert('Error al registrar salida: ' + err.message);
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', loadInventory);
        document.addEventListener('DOMContentLoaded', () => { if (window.lucide) window.lucide.createIcons(); });
    </script>
</body>

</html>